<div class="space-y-6" id="webhooks-container" data-calendar-id="<%= calendar.id %>">
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-xl font-semibold text-gray-900">Webhooks</h2>
      <p class="mt-1 text-sm text-gray-500">View incoming webhook events from Recall.ai for this calendar.</p>
    </div>
    <span id="webhooks-count-badge" class="inline-flex items-center gap-1 rounded-full bg-indigo-100 px-4 py-1.5 text-sm font-medium text-indigo-700">
      <span id="webhooks-total-count"><%= webhookCount || 0 %></span> <span>Events</span>
    </span>
  </div>

  <!-- Loading State -->
  <div id="webhooks-loading" class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
    <svg class="animate-spin mx-auto h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="mt-4 text-sm text-gray-500">Loading webhooks...</p>
  </div>

  <!-- Empty State (hidden by default) -->
  <div id="webhooks-empty" class="hidden text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
    <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
    </svg>
    <h3 class="mt-4 text-lg font-semibold text-gray-900">No webhooks yet</h3>
    <p class="mt-2 text-sm text-gray-500 max-w-md mx-auto">
      Webhook events will appear here as Recall.ai sends updates about your calendar and meeting events.
    </p>
  </div>

  <!-- Webhook List (hidden by default) -->
  <div id="webhooks-list" class="hidden space-y-4">
    <!-- Webhooks will be inserted here dynamically -->
  </div>

  <!-- Pagination Controls (hidden by default) -->
  <div id="webhooks-pagination" class="hidden flex items-center justify-between border-t border-gray-200 pt-4">
    <div class="flex items-center gap-1 text-sm text-gray-500">
      <span>Showing</span> <span id="pagination-start">1</span> <span>-</span> <span id="pagination-end">10</span> <span>of</span> <span id="pagination-total">0</span> <span>Webhooks</span>
    </div>
    <div class="flex items-center space-x-2">
      <button 
        id="pagination-prev"
        onclick="loadWebhooks(currentPage - 1)"
        class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Previous
      </button>
      <span class="text-sm text-gray-700">
        Page <span id="pagination-current">1</span> of <span id="pagination-pages">1</span>
      </span>
      <button 
        id="pagination-next"
        onclick="loadWebhooks(currentPage + 1)"
        class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        Next
        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
let currentPage = 1;
const pageSize = 10;
let calendarId = null;
let webhooksLoaded = false;

function formatDateTime(dateString) {
  const date = new Date(dateString);
  return date.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
}

function getEventIcon(event) {
  if (event.includes('created') || event.includes('new')) {
    return `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100">
      <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
      </svg>
    </span>`;
  } else if (event.includes('updated') || event.includes('changed')) {
    return `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100">
      <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
    </span>`;
  } else if (event.includes('deleted') || event.includes('removed')) {
    return `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100">
      <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
      </svg>
    </span>`;
  } else {
    return `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </span>`;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function renderWebhook(webhook, index) {
  const uniqueId = `webhook-${webhook.id}`;
  return `
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
      <div class="px-5 py-4 flex items-center justify-between bg-gradient-to-r from-gray-50 to-white border-b border-gray-100">
        <div class="flex items-center space-x-3">
          <div class="flex-shrink-0">
            ${getEventIcon(webhook.event)}
          </div>
          <div>
            <p class="text-sm font-semibold text-gray-900">${escapeHtml(webhook.event)}</p>
            <p class="text-xs text-gray-500">${formatDateTime(webhook.receivedAt)}</p>
          </div>
        </div>
        <button 
          onclick="toggleWebhookPayload('${uniqueId}')"
          class="inline-flex items-center text-xs font-medium text-indigo-600 hover:text-indigo-500"
        >
          <span id="${uniqueId}-toggle-text">Show payload</span>
          <svg id="${uniqueId}-chevron" class="w-4 h-4 ml-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
      </div>
      <div id="${uniqueId}-payload" class="hidden">
        <pre class="p-4 bg-gray-900 text-gray-100 text-xs overflow-x-auto rounded-b-xl"><code class="language-json">${escapeHtml(JSON.stringify(webhook.payload, null, 2))}</code></pre>
      </div>
    </div>
  `;
}

function toggleWebhookPayload(id) {
  const payload = document.getElementById(id + '-payload');
  const chevron = document.getElementById(id + '-chevron');
  const toggleText = document.getElementById(id + '-toggle-text');
  
  if (payload.classList.contains('hidden')) {
    payload.classList.remove('hidden');
    chevron.classList.add('rotate-180');
    toggleText.textContent = 'Hide payload';
  } else {
    payload.classList.add('hidden');
    chevron.classList.remove('rotate-180');
    toggleText.textContent = 'Show payload';
  }
}

async function loadWebhooks(page = 1) {
  if (!calendarId) {
    const container = document.getElementById('webhooks-container');
    calendarId = container?.dataset?.calendarId;
  }
  
  if (!calendarId) {
    console.error('No calendar ID found');
    return;
  }

  const loadingEl = document.getElementById('webhooks-loading');
  const emptyEl = document.getElementById('webhooks-empty');
  const listEl = document.getElementById('webhooks-list');
  const paginationEl = document.getElementById('webhooks-pagination');

  // Show loading state
  loadingEl.classList.remove('hidden');
  emptyEl.classList.add('hidden');
  listEl.classList.add('hidden');
  paginationEl.classList.add('hidden');

  try {
    const response = await fetch(`/api/webhooks?calendarId=${calendarId}&page=${page}&limit=${pageSize}`);
    if (!response.ok) {
      throw new Error('Failed to load webhooks');
    }

    const data = await response.json();
    const { webhooks, pagination } = data;

    // Hide loading
    loadingEl.classList.add('hidden');

    // Update total count badge
    document.getElementById('webhooks-total-count').textContent = pagination.totalCount;

    if (webhooks.length === 0 && page === 1) {
      // Show empty state
      emptyEl.classList.remove('hidden');
      return;
    }

    // Render webhooks
    listEl.innerHTML = webhooks.map((webhook, index) => renderWebhook(webhook, index)).join('');
    listEl.classList.remove('hidden');

    // Update pagination
    currentPage = pagination.page;
    const start = (pagination.page - 1) * pagination.limit + 1;
    const end = Math.min(pagination.page * pagination.limit, pagination.totalCount);

    document.getElementById('pagination-start').textContent = start;
    document.getElementById('pagination-end').textContent = end;
    document.getElementById('pagination-total').textContent = pagination.totalCount;
    document.getElementById('pagination-current').textContent = pagination.page;
    document.getElementById('pagination-pages').textContent = pagination.totalPages;

    // Update button states
    const prevBtn = document.getElementById('pagination-prev');
    const nextBtn = document.getElementById('pagination-next');
    
    prevBtn.disabled = pagination.page <= 1;
    nextBtn.disabled = !pagination.hasMore;

    // Show pagination if there are multiple pages
    if (pagination.totalPages > 1) {
      paginationEl.classList.remove('hidden');
    }

    webhooksLoaded = true;
  } catch (error) {
    console.error('Error loading webhooks:', error);
    loadingEl.classList.add('hidden');
    emptyEl.classList.remove('hidden');
    emptyEl.querySelector('h3').textContent = 'Error loading webhooks';
    emptyEl.querySelector('p').textContent = 'There was an error loading the webhook events. Please try again.';
  }
}

// Load webhooks when the tab is shown
function onWebhooksTabShown() {
  if (!webhooksLoaded) {
    loadWebhooks(1);
  }
}

// Use MutationObserver to detect when the webhooks tab becomes visible
function setupWebhooksTabObserver() {
  const webhooksContent = document.getElementById('content-webhooks');
  if (!webhooksContent) return;

  // Check if already visible (e.g., from URL hash)
  if (!webhooksContent.classList.contains('hidden')) {
    onWebhooksTabShown();
  }

  // Watch for class changes
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.attributeName === 'class') {
        if (!webhooksContent.classList.contains('hidden')) {
          onWebhooksTabShown();
        }
      }
    });
  });

  observer.observe(webhooksContent, { attributes: true });
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  // Small delay to ensure the main script has run and tabs are initialized
  setTimeout(setupWebhooksTabObserver, 100);
});

// Also check on window load as a fallback
window.addEventListener('load', function() {
  setTimeout(function() {
    const webhooksContent = document.getElementById('content-webhooks');
    if (webhooksContent && !webhooksContent.classList.contains('hidden') && !webhooksLoaded) {
      onWebhooksTabShown();
    }
  }, 200);
});

// Additional fallback: check periodically for the first few seconds
let checkCount = 0;
const checkInterval = setInterval(function() {
  checkCount++;
  const webhooksContent = document.getElementById('content-webhooks');
  if (webhooksContent && !webhooksContent.classList.contains('hidden') && !webhooksLoaded) {
    onWebhooksTabShown();
    clearInterval(checkInterval);
  }
  if (checkCount >= 10) {
    clearInterval(checkInterval);
  }
}, 300);
</script>
