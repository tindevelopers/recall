<%- include('partials/header') -%>
<div class="min-h-full bg-gradient-to-br from-slate-50 via-white to-indigo-50">
  <%- include('partials/navigation', { user: user, currentPage: 'meetings' }) -%>
  <%- include('partials/notice', { notice: notice }) -%>
  
  <div class="py-10">
    <header class="mb-8">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="md:flex md:items-center md:justify-between">
          <div class="min-w-0 flex-1">
            <h1 class="text-3xl font-bold tracking-tight text-gray-900 flex items-center">
              <svg class="w-8 h-8 mr-3 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              Meetings
            </h1>
            <p class="mt-2 text-sm text-gray-600">
              View upcoming events and access recordings, transcripts, and AI-generated notes from past meetings.
            </p>
          </div>
          <div class="mt-4 flex md:ml-4 md:mt-0 items-center space-x-3">
            <% if (typeof lastSyncAge !== 'undefined' && lastSyncAge !== null) { %>
              <span class="text-xs text-gray-400">
                <% if (syncInProgress) { %>
                  <span class="inline-flex items-center">
                    <svg class="animate-spin -ml-1 mr-1 h-3 w-3 text-indigo-500" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Syncing...
                  </span>
                <% } else { %>
                  Updated <%= lastSyncAge < 60 ? lastSyncAge + 's' : Math.round(lastSyncAge / 60) + 'm' %> ago
                <% } %>
              </span>
            <% } %>
            <button 
              onclick="window.location.reload()" 
              class="inline-flex items-center rounded-lg bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 transition-colors"
              title="Refresh to get latest data"
            >
              <svg class="w-4 h-4 mr-1.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Refresh
            </button>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <% if (!hasCalendars) { %>
          <!-- No Calendar Connected State -->
          <div class="text-center py-16 bg-white rounded-2xl shadow-sm border border-gray-100">
            <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <h3 class="mt-4 text-lg font-semibold text-gray-900">No Calendar Connected</h3>
            <p class="mt-2 text-sm text-gray-500 max-w-md mx-auto">
              Connect your Google Calendar or Microsoft Outlook to start scheduling meeting recordings automatically.
            </p>
              <div class="mt-6">
              <a href="/" class="inline-flex items-center rounded-lg bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  Connect a Calendar
                </a>
              </div>
          </div>
        <% } else { %>
          <!-- Tabbed Interface -->
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200">
              <nav class="-mb-px flex" aria-label="Tabs">
                <button 
                  onclick="switchMeetingsTab('upcoming')"
                  id="tab-upcoming"
                  class="meetings-tab-button flex-1 group inline-flex items-center justify-center py-4 px-4 border-b-2 font-medium text-sm transition-colors border-indigo-500 text-indigo-600"
                >
                  <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  Upcoming
                  <% if (upcomingEvents && upcomingEvents.length > 0) { %>
                    <span class="ml-2 inline-flex items-center rounded-full bg-indigo-100 px-2.5 py-0.5 text-xs font-medium text-indigo-700">
                      <%= upcomingEvents.length %>
                    </span>
                  <% } %>
                </button>
                <button 
                  onclick="switchMeetingsTab('past')"
                  id="tab-past"
                  class="meetings-tab-button flex-1 group inline-flex items-center justify-center py-4 px-4 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                >
                  <svg class="w-5 h-5 mr-2 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Past Meetings
                  <% if (meetings && meetings.length > 0) { %>
                    <span class="ml-2 inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600 group-hover:bg-gray-200">
                      <%= meetings.length %>
                    </span>
                  <% } %>
                </button>
              </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
              <!-- Upcoming Events Tab -->
              <div id="content-upcoming" class="meetings-tab-content">
                <% if (!upcomingEvents || upcomingEvents.length === 0) { %>
                  <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <h3 class="mt-4 text-lg font-semibold text-gray-900">No upcoming meetings</h3>
                    <p class="mt-2 text-sm text-gray-500">
                      Your upcoming calendar events with meeting links will appear here.
                    </p>
                  </div>
                <% } else { %>
                  <div class="space-y-4">
                    <% upcomingEvents.forEach(function(event) { %>
                      <div class="bg-gray-50 rounded-xl p-5 hover:bg-gray-100 transition-colors border border-gray-200">
                        <div class="flex items-start gap-4">
                          <!-- Left: Calendar Icon -->
                          <div class="flex-shrink-0">
                            <% if (event.platform === 'google_calendar') { %>
                              <div class="w-12 h-12 bg-white rounded-xl shadow-sm flex items-center justify-center">
                                <img class="h-7 w-7" src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Google_Calendar_icon_%282020%29.svg/2048px-Google_Calendar_icon_%282020%29.svg.png" alt="Google Calendar" />
                              </div>
                            <% } else { %>
                              <div class="w-12 h-12 bg-white rounded-xl shadow-sm flex items-center justify-center">
                                <img class="h-7 w-7" src="https://img.icons8.com/color/480/outlook-calendar.png" alt="Outlook" />
                              </div>
                            <% } %>
                          </div>
                          
                          <!-- Middle: Event Details -->
                          <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between">
                              <h4 class="text-sm font-semibold text-gray-900 truncate"><%= event.title || 'Untitled Meeting' %></h4>
                              <!-- Status Badge -->
                              <% if (event.recordStatus === 'record') { %>
                                <span class="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-green-800 ml-2 flex-shrink-0" title="<%= event.bots && event.bots.length > 0 ? 'Bot ID: ' + (event.bots[0].bot_id || event.bots[0].id || event.bots[0]) : '' %>">
                                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg>
                                  Bot scheduled
                                </span>
                              <% } else if (event.recordStatus === 'do_not_record') { %>
                                <span class="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-600 ml-2 flex-shrink-0">
                                  No recording
                                </span>
                              <% } else { %>
                                <span class="inline-flex items-center rounded-full bg-amber-100 px-3 py-1 text-xs font-medium text-amber-800 ml-2 flex-shrink-0">
                                  Pending
                                </span>
                              <% } %>
                            </div>
                            
                            <!-- Time -->
                            <div class="mt-1 flex items-center text-sm text-gray-500">
                              <svg class="mr-1.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                              </svg>
                              <% if (event.startTime) { %>
                                <span class="local-datetime" data-iso="<%= new Date(event.startTime).toISOString() %>" data-format="date"></span>
                                at
                                <span class="local-datetime" data-iso="<%= new Date(event.startTime).toISOString() %>" data-format="time"></span>
                                <% if (event.endTime) { %>
                                  - <span class="local-datetime" data-iso="<%= new Date(event.endTime).toISOString() %>" data-format="time"></span>
                                <% } %>
                              <% } %>
                            </div>
                            
                            <% if (event.calendarEmail) { %>
                              <p class="mt-1 text-xs text-gray-400"><%= event.calendarEmail %></p>
                            <% } %>
                            
                            <!-- Meeting URL -->
                            <% if (event.meetingUrl) { %>
                              <div class="mt-2 flex items-center text-xs text-gray-500">
                                <svg class="mr-1.5 h-3.5 w-3.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 103 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 002.273 1.765 11.842 11.842 0 00.976.544l.062.029.018.008.006.003zM10 11.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" clip-rule="evenodd" />
                                </svg>
                                <a href="<%= event.meetingUrl %>" target="_blank" class="text-indigo-600 hover:text-indigo-500 hover:underline truncate max-w-md">
                                  <%= event.meetingUrl %>
                                </a>
                              </div>
                            <% } else { %>
                              <p class="mt-2 text-xs text-amber-500">⚠️ No meeting URL</p>
                            <% } %>
                            
                            <!-- Attendees -->
                            <% if (event.attendees && event.attendees.length > 0) { %>
                              <div class="mt-2 flex flex-wrap gap-1 items-center">
                                <span class="text-xs text-gray-500">Attendees:</span>
                                <% event.attendees.slice(0, 5).forEach(function(att) { %>
                                  <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600" title="<%= att.email %> (<%= att.status %>)">
                                    <%= att.name || att.email %>
                                    <% if (att.organizer) { %>
                                      <svg class="ml-1 w-3 h-3 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    <% } %>
                                  </span>
                                <% }); %>
                                <% if (event.attendees.length > 5) { %>
                                  <span class="text-xs text-gray-400">+<%= event.attendees.length - 5 %> more</span>
                                <% } %>
                              </div>
                            <% } %>
                          </div>
                          
                          <!-- Right: Actions Panel -->
                          <div class="flex-shrink-0 w-56 pl-4 border-l border-gray-200">
                            <!-- Recording Status -->
                            <div class="space-y-2">
                              <div class="flex items-center justify-between text-xs">
                                <span class="text-gray-500">Auto Recording:</span>
                                <span class="font-medium <%= event.shouldRecordAutomatic ? 'text-green-600' : 'text-gray-600' %>">
                                  <%= event.shouldRecordAutomatic ? 'Yes' : 'No' %>
                                </span>
                              </div>
                              <div class="flex items-center justify-between text-xs">
                                <span class="text-gray-500">Manual Recording:</span>
                                <span class="font-medium <%= event.shouldRecordManual ? 'text-green-600' : 'text-gray-600' %>">
                                  <%= event.shouldRecordManual ? 'Yes' : 'No' %>
                                </span>
                              </div>
                              
                              <!-- Toggle Manual Record Button -->
                              <form method="post" action="/calendar-event/<%= event.id %>/set-manual-record" class="mt-2">
                                <input type="hidden" name="_method" value="PATCH" />
                                <input type="hidden" name="manualRecord" value="<%= event.shouldRecordManual ? false : true %>" />
                                <button type="submit" class="w-full rounded-md bg-white px-2.5 py-1.5 text-xs font-medium text-indigo-600 shadow-sm ring-1 ring-inset ring-indigo-300 hover:bg-indigo-50 transition-colors">
                                  <%= event.shouldRecordManual ? 'Disable Manual Record' : 'Enable Manual Record' %>
                                </button>
                              </form>
                              
                              <!-- Transcription Mode Selector -->
                              <div class="mt-3 pt-3 border-t border-gray-200">
                                <label class="text-xs text-gray-500 block mb-1">Transcription Mode:</label>
                                <select 
                                  class="transcription-mode-select w-full text-xs rounded-md border-gray-300 py-1.5 pl-2 pr-7 focus:border-indigo-500 focus:ring-indigo-500 bg-white"
                                  data-event-id="<%= event.id %>"
                                  onchange="updateTranscriptionMode(this)"
                                >
                                  <option value="default" <%= !event.transcriptionMode ? 'selected' : '' %>>
                                    Default (<%= event.calendarTranscriptionMode === 'async' ? 'Async' : 'Real-time' %>)
                                  </option>
                                  <option value="realtime" <%= event.transcriptionMode === 'realtime' ? 'selected' : '' %>>Real-time</option>
                                  <option value="async" <%= event.transcriptionMode === 'async' ? 'selected' : '' %>>Async</option>
                                </select>
                                <span class="transcription-status text-xs text-gray-400 hidden mt-1 block"></span>
                              </div>
                              
                              <!-- Join Button -->
                              <% if (event.meetingUrl) { %>
                                <a href="<%= event.meetingUrl %>" target="_blank" class="mt-3 w-full inline-flex items-center justify-center rounded-md bg-indigo-600 px-2.5 py-1.5 text-xs font-medium text-white shadow-sm hover:bg-indigo-500 transition-colors">
                                  Join Meeting
                                  <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                  </svg>
                                </a>
                              <% } %>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% }); %>
                  </div>
                <% } %>
              </div>

              <!-- Past Meetings Tab -->
              <div id="content-past" class="meetings-tab-content hidden">
                <script>
                  console.log('[DEBUG] Past meetings check:', {
                    meetingsType: typeof meetings,
                    meetingsIsNull: meetings === null,
                    meetingsIsArray: Array.isArray(meetings),
                    meetingsLength: meetings ? meetings.length : 'N/A',
                    meetingsSample: meetings && meetings.length > 0 ? meetings.slice(0, 3) : []
                  });
                </script>
                <% if (totalPages && totalPages > 1) { %>
                  <div class="flex items-center justify-between mb-4">
                    <div class="text-xs text-gray-500">
                      Page <%= page %> of <%= totalPages %>
                    </div>
                    <div class="flex space-x-2">
                      <a
                        href="<%= hasPrev ? (`/meetings?page=${page - 1}`) : '#' %>"
                        class="px-3 py-1.5 rounded-lg text-sm font-medium border <%= hasPrev ? 'text-gray-700 border-gray-200 hover:bg-gray-50' : 'text-gray-300 border-gray-100 cursor-not-allowed' %>"
                        aria-disabled="<%= !hasPrev %>"
                      >
                        Previous
                      </a>
                      <a
                        href="<%= hasNext ? (`/meetings?page=${page + 1}`) : '#' %>"
                        class="px-3 py-1.5 rounded-lg text-sm font-medium border <%= hasNext ? 'text-gray-700 border-gray-200 hover:bg-gray-50' : 'text-gray-300 border-gray-100 cursor-not-allowed' %>"
                        aria-disabled="<%= !hasNext %>"
                      >
                        Next
                      </a>
                    </div>
                  </div>
                <% } %>
                <!-- Filters -->
                <form method="GET" action="/meetings#past" class="mb-4 bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2">
                  <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3 space-y-2 sm:space-y-0">
                    <input
                      type="text"
                      name="q"
                      value="<%= filters?.q || '' %>"
                      placeholder="Search title or participant"
                      class="w-full sm:w-1/3 rounded-md border-gray-300 text-sm focus:border-indigo-500 focus:ring-indigo-500"
                    />
                    <div class="flex items-center space-x-2">
                      <label class="text-xs text-gray-600">From</label>
                      <input type="date" name="from" value="<%= filters?.from || '' %>" class="rounded-md border-gray-300 text-sm focus:border-indigo-500 focus:ring-indigo-500" />
                      <label class="text-xs text-gray-600">To</label>
                      <input type="date" name="to" value="<%= filters?.to || '' %>" class="rounded-md border-gray-300 text-sm focus:border-indigo-500 focus:ring-indigo-500" />
                    </div>
                    <select name="sort" class="rounded-md border-gray-300 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                      <option value="newest" <%= filters?.sort === 'newest' ? 'selected' : '' %>>Newest first</option>
                      <option value="oldest" <%= filters?.sort === 'oldest' ? 'selected' : '' %>>Oldest first</option>
                      <option value="duration" <%= filters?.sort === 'duration' ? 'selected' : '' %>>Longest duration</option>
                    </select>
                    <button type="submit" class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-1.5 text-xs font-medium text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                      Apply
                    </button>
                  </div>
                  <div class="flex flex-wrap gap-3 text-xs text-gray-700">
                    <label class="inline-flex items-center space-x-1">
                      <input type="checkbox" name="hasTranscript" value="true" <%= filters?.hasTranscript === true ? 'checked' : '' %> class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                      <span>Has transcript</span>
                    </label>
                    <label class="inline-flex items-center space-x-1">
                      <input type="checkbox" name="hasSummary" value="true" <%= filters?.hasSummary === true ? 'checked' : '' %> class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                      <span>Has summary</span>
                    </label>
                    <label class="inline-flex items-center space-x-1">
                      <input type="checkbox" name="hasRecording" value="true" <%= filters?.hasRecording === true ? 'checked' : '' %> class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                      <span>Has recording</span>
                    </label>
                    <label class="inline-flex items-center space-x-1">
                      <input type="checkbox" name="hasRecallRecording" value="true" <%= filters?.hasRecallRecording === true ? 'checked' : '' %> class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                      <span>Has Recall recording</span>
                    </label>
                    <label class="inline-flex items-center space-x-1">
                      <input type="checkbox" name="hasTeamsRecording" value="true" <%= filters?.hasTeamsRecording === true ? 'checked' : '' %> class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                      <span>Has Teams recording</span>
                    </label>
                  </div>
                </form>
                <% if (typeof meetings === 'undefined' || meetings === null || !Array.isArray(meetings) || meetings.length === 0) { %>
                  <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    <h3 class="mt-4 text-lg font-semibold text-gray-900">No recorded meetings yet</h3>
                    <p class="mt-2 text-sm text-gray-500">
                      Meetings will appear here once your bot has attended and recorded them.
                    </p>
                  </div>
                <% } else { %>
                  <div class="space-y-4">
              <% meetings.forEach(function(meeting) { %>
                      <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
                        <div class="p-5">
                          <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4">
                          <div class="flex-shrink-0">
                            <% if (meeting.platform === 'google_calendar') { %>
                                  <div class="w-12 h-12 bg-gray-50 rounded-xl flex items-center justify-center">
                                    <img class="h-7 w-7" src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Google_Calendar_icon_%282020%29.svg/2048px-Google_Calendar_icon_%282020%29.svg.png" alt="Google Calendar" />
                                  </div>
                            <% } else if (meeting.platform === 'microsoft_outlook') { %>
                                  <div class="w-12 h-12 bg-gray-50 rounded-xl flex items-center justify-center">
                                    <img class="h-7 w-7" src="https://img.icons8.com/color/480/outlook-calendar.png" alt="Outlook" />
                                  </div>
                            <% } else { %>
                                  <div class="w-12 h-12 bg-indigo-50 rounded-xl flex items-center justify-center">
                                <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                              </div>
                            <% } %>
                          </div>
                              <div class="flex-1 min-w-0 space-y-1">
                                <div class="flex items-center space-x-2">
                                  <h4 class="text-base font-semibold text-gray-900 truncate"><%= meeting.title || 'Meeting' %></h4>
                                  <% if (meeting.platform) { %>
                                    <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xxs font-medium text-gray-700 ring-1 ring-inset ring-gray-200">
                                      <%= meeting.platform === 'google_calendar' ? 'Google' : meeting.platform === 'microsoft_outlook' ? 'Outlook' : 'Meeting' %>
                                    </span>
                                  <% } %>
                                </div>

                                <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500">
                                  <span class="flex items-center">
                                    <svg class="mr-1.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <% if (meeting.startTime) { %>
                                      <span class="local-datetime" data-iso="<%= new Date(meeting.startTime).toISOString() %>" data-format="datetime"></span>
                                    <% } else { %>
                                      Date unknown
                                    <% } %>
                                  </span>
                                  <% if (meeting.durationSeconds) { %>
                                    <span class="flex items-center text-sm font-medium text-indigo-600 bg-indigo-50 rounded-full px-3 py-1">
                                      <svg class="mr-1.5 h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                      </svg>
                                      <% 
                                        const totalMins = Math.round(meeting.durationSeconds / 60);
                                        const hours = Math.floor(totalMins / 60);
                                        const mins = totalMins % 60;
                                        const durationDisplay = hours > 0 ? `${hours}h ${mins}m` : `${mins} min`;
                                      %>
                                      <%= durationDisplay %>
                                    </span>
                                  <% } else { %>
                                    <span class="flex items-center text-xs text-gray-400 bg-gray-100 rounded-full px-2 py-1">
                                      <svg class="mr-1 h-3.5 w-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                      </svg>
                                      Duration unknown
                                    </span>
                                  <% } %>
                                  <% if (meeting.calendarEmail) { %>
                                    <span class="text-xs text-gray-400"><%= meeting.calendarEmail %></span>
                                  <% } %>
                                </div>

                                <%# Show meeting ID (from stored metadata) and platform indicator %>
                                <%
                                  const platformNameMap = {
                                    teams: 'Teams',
                                    zoom: 'Zoom',
                                    webex: 'Webex',
                                    google_meet: 'Google Meet'
                                  };
                                  const platformName = platformNameMap[meeting.meetingPlatform] || null;
                                  let meetingId = meeting.displayMeetingId || meeting.meetingId || null;

                                  // Fallback: attempt lightweight extraction if still missing
                                  if (!meetingId && meeting.meetingUrl) {
                                    const urlStr = typeof meeting.meetingUrl === 'string'
                                      ? meeting.meetingUrl
                                      : (meeting.meetingUrl.url || meeting.meetingUrl.href || meeting.meetingUrl.link || '');
                                    if (urlStr.includes('teams.microsoft.com')) {
                                      const teamsMatch = urlStr.match(/\/meet\/([A-Za-z0-9]+)/);
                                      if (teamsMatch) meetingId = teamsMatch[1].replace(/(\d{3})(?=\d)/g, '$1 ').trim();
                                    } else if (urlStr.includes('zoom.us')) {
                                      const zoomMatch = urlStr.match(/\/j\/(\d+)/);
                                      if (zoomMatch) meetingId = zoomMatch[1].replace(/(\d{3})(?=\d)/g, '$1 ').trim();
                                    } else if (urlStr.includes('webex.com')) {
                                      const webexMatch = urlStr.match(/\/(\d{9,})/);
                                      if (webexMatch) meetingId = webexMatch[1].replace(/(\d{3})(?=\d)/g, '$1 ').trim();
                                    } else if (urlStr.includes('meet.google.com')) {
                                      const meetMatch = urlStr.match(/\/([a-z]{3}-[a-z]{4}-[a-z]{3})/i);
                                      if (meetMatch) meetingId = meetMatch[1];
                                    }
                                  }
                                %>
                                  <% if (meetingId) { %>
                                    <div class="flex items-center text-xs text-gray-500">
                                      <svg class="mr-1.5 h-3.5 w-3.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2z" clip-rule="evenodd" />
                                      </svg>
                                  <span class="font-medium text-gray-600"><%= platformName || 'Meeting' %> ID:</span>
                                      <span class="ml-1 font-mono"><%= meetingId %></span>
                                      <button 
                                        class="ml-2 text-indigo-600 hover:text-indigo-800 text-xs underline"
                                        onclick="copyText('<%= meetingId %>')"
                                        type="button"
                                      >
                                        Copy
                                      </button>
                                    </div>
                                  <% } %>

                                <!-- Description -->
                                <%# For past meetings, hide description entirely since meeting ID is shown separately %>
                                <%# Only show description if it contains actual meeting content (not just Teams metadata) %>
                                <% if (meeting.description) { 
                                     // Check if description is mostly Teams meeting metadata
                                     const desc = meeting.description.toLowerCase();
                                     const isTeamsMetadata = desc.includes('microsoft teams meeting') || 
                                                             desc.includes('dial in by phone') ||
                                                             desc.includes('phone conference id') ||
                                                             desc.includes('for organizers') ||
                                                             desc.includes('meeting options') ||
                                                             desc.includes('need help') ||
                                                             desc.includes('system reference') ||
                                                             (desc.match(/https?:\/\//g) && desc.match(/https?:\/\//g).length > 0);
                                     
                                     // Only show description if it's NOT Teams metadata
                                     // (Meeting ID is already shown separately above)
                                     if (!isTeamsMetadata) {
                                       // Remove any URLs that might still be present
                                       let cleanedDesc = meeting.description;
                                       const urlPattern = new RegExp('https?://[^\\s]+', 'g');
                                       cleanedDesc = cleanedDesc.replace(urlPattern, '').trim();
                                       
                                       if (cleanedDesc.length > 0) {
                                 %>
                                    <div class="mt-2 text-sm text-gray-600 line-clamp-2">
                                      <%= cleanedDesc %>
                                    </div>
                                 <%   }
                                     }
                                   } %>

                                <!-- Organizer -->
                                <% if (meeting.organizer) { %>
                                  <div class="mt-1 flex items-center text-xs text-gray-500">
                                    <svg class="mr-1.5 h-3.5 w-3.5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                    <span>Organizer: <span class="font-medium text-gray-700"><%= meeting.organizer.name || meeting.organizer.email %></span></span>
                                  </div>
                                <% } %>

                                <!-- Participants -->
                                <% if (meeting.participants && meeting.participants.length > 0) { %>
                                  <div class="mt-2 flex flex-wrap gap-2 items-center text-xs text-gray-600">
                                    <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 font-medium">
                                      <svg class="mr-1 h-3.5 w-3.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                      </svg>
                                      <span>Attendees:</span>
                                    </span>
                                    <% meeting.participants.slice(0,6).forEach(function(att) { %>
                                      <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-700" title="<%= att.email || '' %> (<%= att.status || 'unknown' %>)">
                                        <%= att.name || att.email || 'Guest' %>
                                        <% if (att.organizer) { %>
                                          <svg class="ml-1 w-3 h-3 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                        <% } %>
                                      </span>
                                    <% }); %>
                                    <% if (meeting.participants.length > 6) { %>
                                      <span class="text-xs text-gray-400">+<%= meeting.participants.length - 6 %> more</span>
                                    <% } %>
                                  </div>
                                <% } %>

                                <!-- Status Badges -->
                                <div class="mt-3 flex flex-wrap gap-2">
                          <%# Teams Video Available indicator %>
                          <% if (meeting.hasTeamsRecording) { %>
                                    <span class="inline-flex items-center rounded-full bg-blue-50 px-2.5 py-1 text-xs font-medium text-blue-700 ring-1 ring-inset ring-blue-600/20">
                              <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                              </svg>
                              Teams Video
                            </span>
                          <% } %>
                          <% if (meeting.hasRecording) { %>
                                    <span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                              <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                              </svg>
                              Recording
                            </span>
                          <% } else if (!meeting.hasTeamsRecording) { %>
                            <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-300">
                              No Recording
                            </span>
                          <% } %>
                          <% if (meeting.hasTranscript) { %>
                                    <span class="inline-flex items-center rounded-full bg-blue-50 px-2.5 py-1 text-xs font-medium text-blue-700 ring-1 ring-inset ring-blue-600/20">
                              <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                              </svg>
                              Transcript
                            </span>
                          <% } else { %>
                            <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-300">
                              No Transcript
                            </span>
                          <% } %>
                          <% if (meeting.hasSummary) { %>
                                    <span class="inline-flex items-center rounded-full bg-purple-50 px-2.5 py-1 text-xs font-medium text-purple-700 ring-1 ring-inset ring-purple-600/20">
                              <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"></path>
                              </svg>
                                      AI Summary
                            </span>
                          <% } else { %>
                            <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-300">
                              No Summary
                            </span>
                          <% } %>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Quick Action Icons -->
                            <div class="flex items-center space-x-1">
                              <!-- Play Recording Button - enabled for Recall recordings or Teams recordings -->
                              <% const canPlayVideo = meeting.hasRecording || meeting.hasRecallRecording || meeting.hasTeamsRecording || meeting.meetingPlatform === 'teams'; %>
                              <button 
                                onclick='openPlayerModal("<%= meeting.id %>", "<%= (meeting.recordingUrl || "").replace(/"/g, "\\\"") %>", "<%= (meeting.audioUrl || "").replace(/"/g, "\\\"") %>", "<%= (meeting.title || "Meeting").replace(/"/g, "\\\"") %>")'
                                class="<%= canPlayVideo ? 'text-green-600 hover:bg-green-50' : 'text-gray-300 cursor-not-allowed' %> p-2 rounded-lg transition-colors"
                                title="<%= canPlayVideo ? 'Play Recording' : 'No recording available' %>"
                                <%= canPlayVideo ? '' : 'disabled' %>
                              >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                              </button>
                              
                              <!-- Transcript Button -->
                              <button 
                                onclick='openTranscriptModal("<%= meeting.id %>", "<%= (meeting.title || "Meeting").replace(/"/g, "\\\"") %>")'
                                class="<%= meeting.hasTranscript ? 'text-blue-600 hover:bg-blue-50' : 'text-gray-300 cursor-not-allowed' %> p-2 rounded-lg transition-colors text-left"
                                title="<%= meeting.hasTranscript ? 'View Transcript' : 'No transcript available' %>"
                                <%= meeting.hasTranscript ? '' : 'disabled' %>
                              >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                              </button>
                              
                              <!-- AI Summary Button -->
                              <button 
                                onclick='openSummaryModal("<%= meeting.id %>", "<%= (meeting.summaryId || "").replace(/"/g, "\\\"") %>", "<%= (meeting.title || "Meeting").replace(/"/g, "\\\"") %>")'
                                class="<%= meeting.hasSummary ? 'text-purple-600 hover:bg-purple-50' : 'text-gray-300 cursor-not-allowed' %> p-2 rounded-lg transition-colors"
                                title="<%= meeting.hasSummary ? 'View AI Summary' : 'No summary available' %>"
                                <%= meeting.hasSummary ? '' : 'disabled' %>
                              >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                              </button>
                              
                              <!-- Action Items Button -->
                              <button 
                                onclick='openActionsModal("<%= meeting.id %>", "<%= (meeting.summaryId || "").replace(/"/g, "\\\"") %>", "<%= (meeting.title || "Meeting").replace(/"/g, "\\\"") %>")'
                                class="<%= meeting.hasSummary ? 'text-amber-600 hover:bg-amber-50' : 'text-gray-300 cursor-not-allowed' %> p-2 rounded-lg transition-colors"
                                title="<%= meeting.hasSummary ? 'View Action Items' : 'No action items available' %>"
                                <%= meeting.hasSummary ? '' : 'disabled' %>
                              >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                              </button>
                              
                              <!-- View Details Link -->
                              <a href="/meetings/<%= meeting.id %>" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-lg transition-colors" title="View Full Details">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                </svg>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% }); %>
                        </div>
                      <% } %>
                    </div>
            </div>
          </div>
        <% } %>
      </div>
    </main>
  </div>
</div>

<script>
// Format all datetime elements to user's local timezone
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.local-datetime').forEach(function(el) {
    const iso = el.getAttribute('data-iso');
    const format = el.getAttribute('data-format');
    if (!iso) return;
    
    const date = new Date(iso);
    let formatted = '';
    
    if (format === 'date') {
      formatted = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
    } else if (format === 'time') {
      formatted = date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
    } else if (format === 'datetime') {
      formatted = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) + 
                  ' at ' + 
                  date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
    }
    
    el.textContent = formatted;
  });
});

// Speaker color helper for transcripts
const speakerPalette = [
  { bg: 'bg-indigo-100', text: 'text-indigo-800' },
  { bg: 'bg-blue-100', text: 'text-blue-800' },
  { bg: 'bg-purple-100', text: 'text-purple-800' },
  { bg: 'bg-emerald-100', text: 'text-emerald-800' },
  { bg: 'bg-amber-100', text: 'text-amber-800' },
  { bg: 'bg-rose-100', text: 'text-rose-800' },
];

function getSpeakerColor(name) {
  const str = name || 'Speaker';
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = (hash << 5) - hash + str.charCodeAt(i);
    hash |= 0;
  }
  const idx = Math.abs(hash) % speakerPalette.length;
  return speakerPalette[idx];
}

function switchMeetingsTab(tabName) {
  // Check if tabs exist (only when calendar is connected)
  const tabContent = document.getElementById('content-' + tabName);
  const activeTab = document.getElementById('tab-' + tabName);
  
  if (!tabContent || !activeTab) {
    return; // Tabs don't exist, likely no calendar connected
  }
  
  // Hide all content
  document.querySelectorAll('.meetings-tab-content').forEach(el => el.classList.add('hidden'));
  
  // Reset all tab buttons
  document.querySelectorAll('.meetings-tab-button').forEach(el => {
    el.classList.remove('border-indigo-500', 'text-indigo-600');
    el.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    const svg = el.querySelector('svg');
    if (svg) {
      svg.classList.remove('text-indigo-500');
      svg.classList.add('text-gray-400', 'group-hover:text-gray-500');
    }
    const badge = el.querySelector('span');
    if (badge) {
      badge.classList.remove('bg-indigo-100', 'text-indigo-700');
      badge.classList.add('bg-gray-100', 'text-gray-600', 'group-hover:bg-gray-200');
    }
  });
  
  // Show selected content
  tabContent.classList.remove('hidden');
  
  // Activate selected tab
  activeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
  activeTab.classList.add('border-indigo-500', 'text-indigo-600');
  const svg = activeTab.querySelector('svg');
  if (svg) {
    svg.classList.remove('text-gray-400', 'group-hover:text-gray-500');
    svg.classList.add('text-indigo-500');
  }
  const badge = activeTab.querySelector('span');
  if (badge) {
    badge.classList.remove('bg-gray-100', 'text-gray-600', 'group-hover:bg-gray-200');
    badge.classList.add('bg-indigo-100', 'text-indigo-700');
  }
  
  // Update URL hash
  history.replaceState(null, null, '#' + tabName);
}

// Handle initial tab from URL hash
document.addEventListener('DOMContentLoaded', function() {
  const hash = window.location.hash.slice(1);
  if (hash && document.getElementById('tab-' + hash)) {
    switchMeetingsTab(hash);
  }
});

// Update transcription mode for an event
async function updateTranscriptionMode(selectElement) {
  const eventId = selectElement.dataset.eventId;
  const mode = selectElement.value;
  const statusEl = selectElement.parentElement.querySelector('.transcription-status');
  
  selectElement.disabled = true;
  statusEl.textContent = 'Saving...';
  statusEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
  statusEl.classList.add('text-gray-400');
  
  try {
    const response = await fetch(`/meetings/${eventId}/transcription-mode`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ transcriptionMode: mode })
    });
    
    if (response.ok) {
      const data = await response.json();
      statusEl.textContent = 'Saved!';
      statusEl.classList.remove('text-gray-400');
      statusEl.classList.add('text-green-600');
      setTimeout(() => statusEl.classList.add('hidden'), 2000);
    } else {
      throw new Error('Failed to update');
    }
  } catch (error) {
    statusEl.textContent = 'Error!';
    statusEl.classList.remove('text-gray-400');
    statusEl.classList.add('text-red-600');
    setTimeout(() => statusEl.classList.add('hidden'), 3000);
  } finally {
    selectElement.disabled = false;
  }
}

// Modal functions
async function openPlayerModal(meetingId, videoUrl, audioUrl, title) {
  // #region agent log
  fetch('http://127.0.0.1:7250/ingest/bf0206c3-6e13-4499-92a3-7fb2b7527fcf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'views/meetings.ejs:openPlayerModal',message:'Play button clicked',data:{meetingId,videoUrl:!!videoUrl,audioUrl:!!audioUrl,title},timestamp:Date.now(),sessionId:'debug-session',runId:'play-button',hypothesisId:'A'})}).catch(()=>{});
  // #endregion
  
  const modal = document.getElementById('player-modal');
  const titleEl = document.getElementById('player-modal-title');
  const content = document.getElementById('player-modal-content');
  
  titleEl.textContent = title;
  modal.classList.remove('hidden');
  
  // If we have Recall URLs, play directly (prioritize Recall)
  if (videoUrl) {
    content.innerHTML = `
      <video controls class="w-full rounded-lg" autoplay>
        <source src="${videoUrl}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      ${audioUrl ? `<p class="mt-3 text-sm text-gray-500"><a href="${audioUrl}" target="_blank" class="text-indigo-600 hover:underline">Download audio only</a></p>` : ''}
    `;
    return;
  }
  
  if (audioUrl) {
    content.innerHTML = `
      <audio controls class="w-full" autoplay>
        <source src="${audioUrl}" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
    `;
    return;
  }
  
  // No URL provided - try to fetch recording info from API
  content.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><span class="ml-3 text-gray-500">Loading recording...</span></div>';
  
  try {
    const response = await fetch(`/api/meetings/${meetingId}/recording`);
    if (response.ok) {
      const data = await response.json();
      
      // #region agent log
      fetch('http://127.0.0.1:7250/ingest/bf0206c3-6e13-4499-92a3-7fb2b7527fcf',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'views/meetings.ejs:openPlayerModal',message:'Recording API response',data:{meetingId,hasVideoUrl:!!data.videoUrl,hasAudioUrl:!!data.audioUrl,hasTeamsVideoUrl:!!data.teamsVideoUrl,source:data.source},timestamp:Date.now(),sessionId:'debug-session',runId:'play-button',hypothesisId:'B'})}).catch(()=>{});
      // #endregion
      
      // Prioritize Recall video
      if (data.videoUrl) {
        content.innerHTML = `
          <video controls class="w-full rounded-lg" autoplay>
            <source src="${data.videoUrl}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          ${data.audioUrl ? `<p class="mt-3 text-sm text-gray-500"><a href="${data.audioUrl}" target="_blank" class="text-indigo-600 hover:underline">Download audio only</a></p>` : ''}
          ${data.teamsVideoUrl ? `<p class="mt-3 text-sm text-gray-500"><a href="${data.teamsVideoUrl}" target="_blank" class="text-blue-600 hover:underline">Also available: View Teams recording on Microsoft</a></p>` : ''}
        `;
      } else if (data.audioUrl) {
        content.innerHTML = `
          <audio controls class="w-full" autoplay>
            <source src="${data.audioUrl}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
          ${data.teamsVideoUrl ? `<p class="mt-3 text-sm text-gray-500"><a href="${data.teamsVideoUrl}" target="_blank" class="text-blue-600 hover:underline">Also available: View Teams recording on Microsoft</a></p>` : ''}
        `;
      } else if (data.teamsVideoUrl) {
        // No Recall recording, but Teams recording available
        content.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-600 mb-4">No Recall recording available for this meeting.</p>
            <p class="text-sm text-gray-500 mb-6">The recording is available on Microsoft Teams.</p>
            <a href="${data.teamsVideoUrl}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
              </svg>
              View Teams Recording on Microsoft
            </a>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-500 mb-2">No recording available for this meeting.</p>
            <p class="text-xs text-gray-400">Teams recordings are stored in OneDrive/SharePoint and may need to be accessed directly from Microsoft Teams.</p>
          </div>
        `;
      }
    } else {
      content.innerHTML = `
        <div class="text-center py-8">
          <p class="text-gray-500 mb-2">No recording available for this meeting.</p>
          <p class="text-xs text-gray-400">Teams recordings are stored in OneDrive/SharePoint and may need to be accessed directly from Microsoft Teams.</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error fetching recording:', error);
    content.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load recording</p>';
  }
}

async function openTranscriptModal(meetingId, title) {
  const modal = document.getElementById('transcript-modal');
  const titleEl = document.getElementById('transcript-modal-title');
  const content = document.getElementById('transcript-modal-content');
  
  titleEl.textContent = title;
  content.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div><span class="ml-3 text-gray-500">Loading transcript...</span></div>';
  modal.classList.remove('hidden');
  
  try {
    const response = await fetch(`/api/meetings/${meetingId}/transcript`);
    if (response.ok) {
      const data = await response.json();
      if (data.transcript && data.transcript.length > 0) {
        content.innerHTML = `
          <div class="space-y-3 max-h-96 overflow-y-auto">
            ${data.transcript.map(chunk => `
              <div class="flex space-x-3">
                <div class="flex-shrink-0">
                  ${(() => { const c = getSpeakerColor(chunk.speaker || 'Speaker'); return `
                    <span class="inline-flex items-center justify-center h-8 w-8 rounded-full ${c.bg} ${c.text} text-xs font-medium">
                      ${(chunk.speaker || 'S').charAt(0).toUpperCase()}
                    </span>
                  `; })()}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 text-left">${chunk.speaker || 'Speaker'}</p>
                  <p class="text-sm text-gray-600 text-left">${chunk.text}</p>
                  ${chunk.timestamp ? `<p class="text-xs text-gray-400 mt-1">${formatTimestamp(chunk.timestamp)}</p>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        content.innerHTML = '<p class="text-gray-500 text-center py-8">No transcript available yet</p>';
      }
    } else {
      throw new Error('Failed to load transcript');
    }
  } catch (error) {
    content.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load transcript</p>';
  }
}

async function openSummaryModal(meetingId, summaryId, title) {
  const modal = document.getElementById('summary-modal');
  const titleEl = document.getElementById('summary-modal-title');
  const content = document.getElementById('summary-modal-content');
  
  titleEl.textContent = title;
  content.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div><span class="ml-3 text-gray-500">Loading summary...</span></div>';
  modal.classList.remove('hidden');
  
  try {
    const response = await fetch(`/api/meetings/${meetingId}/summary`);
    if (response.ok) {
      const data = await response.json();
      if (data.summary) {
        content.innerHTML = `
          <div class="prose prose-sm max-w-none max-h-96 overflow-y-auto">
            <div class="whitespace-pre-wrap text-gray-700">${data.summary.content || data.summary.text || 'No summary content available'}</div>
            ${data.summary.keyTopics ? `
              <div class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="font-medium text-gray-900">Key Topics</h4>
                <ul class="mt-2 space-y-1">
                  ${data.summary.keyTopics.map(topic => `<li class="text-sm text-gray-600">• ${topic}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        `;
      } else {
        content.innerHTML = '<p class="text-gray-500 text-center py-8">No summary available yet</p>';
      }
    } else {
      throw new Error('Failed to load summary');
    }
  } catch (error) {
    content.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load summary</p>';
  }
}

async function openActionsModal(meetingId, summaryId, title) {
  const modal = document.getElementById('actions-modal');
  const titleEl = document.getElementById('actions-modal-title');
  const content = document.getElementById('actions-modal-content');
  
  titleEl.textContent = title + ' - Action Items';
  content.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600"></div><span class="ml-3 text-gray-500">Loading action items...</span></div>';
  modal.classList.remove('hidden');
  
  try {
    const response = await fetch(`/api/meetings/${meetingId}/actions`);
    if (response.ok) {
      const data = await response.json();
      if (data.actionItems && data.actionItems.length > 0) {
        content.innerHTML = `
          <ul class="space-y-3 max-h-96 overflow-y-auto">
            ${data.actionItems.map((item, index) => `
              <li class="flex items-start space-x-3 p-3 bg-amber-50 rounded-lg">
                <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-amber-200 text-amber-800 rounded-full text-xs font-medium">${index + 1}</span>
                <div class="flex-1 min-w-0">
                  <p class="text-sm text-gray-900">${item.text || item.description || item}</p>
                  ${item.assignee ? `<p class="text-xs text-gray-500 mt-1">Assigned to: ${item.assignee}</p>` : ''}
                  ${item.dueDate ? `<p class="text-xs text-gray-500">Due: ${item.dueDate}</p>` : ''}
                </div>
              </li>
            `).join('')}
          </ul>
        `;
      } else {
        content.innerHTML = '<p class="text-gray-500 text-center py-8">No action items found</p>';
      }
    } else {
      throw new Error('Failed to load action items');
    }
  } catch (error) {
    content.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load action items</p>';
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.add('hidden');
  // Stop any playing media
  const video = modal.querySelector('video');
  const audio = modal.querySelector('audio');
  if (video) video.pause();
  if (audio) audio.pause();
}

function formatTimestamp(seconds) {
  if (typeof seconds !== 'number') return '';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function copyText(text) {
  if (!text) return;
  navigator.clipboard?.writeText(text).catch(() => {});
}

// Close modals on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    ['player-modal', 'transcript-modal', 'summary-modal', 'actions-modal'].forEach(id => {
      const modal = document.getElementById(id);
      if (modal && !modal.classList.contains('hidden')) {
        closeModal(id);
      }
    });
  }
});
</script>

<!-- Modal Templates -->
<!-- Player Modal -->
<div id="player-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal('player-modal')"></div>
    <div class="relative bg-white rounded-2xl shadow-xl transform transition-all sm:max-w-2xl sm:w-full">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 id="player-modal-title" class="text-lg font-semibold text-gray-900">Recording</h3>
        <button onclick="closeModal('player-modal')" class="text-gray-400 hover:text-gray-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <div id="player-modal-content" class="px-6 py-4"></div>
    </div>
  </div>
</div>

<!-- Transcript Modal -->
<div id="transcript-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal('transcript-modal')"></div>
    <div class="relative bg-white rounded-2xl shadow-xl transform transition-all sm:max-w-2xl sm:w-full">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 id="transcript-modal-title" class="text-lg font-semibold text-gray-900">Transcript</h3>
        <button onclick="closeModal('transcript-modal')" class="text-gray-400 hover:text-gray-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <div id="transcript-modal-content" class="px-6 py-4"></div>
    </div>
  </div>
</div>

<!-- Summary Modal -->
<div id="summary-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal('summary-modal')"></div>
    <div class="relative bg-white rounded-2xl shadow-xl transform transition-all sm:max-w-2xl sm:w-full">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 id="summary-modal-title" class="text-lg font-semibold text-gray-900">AI Summary</h3>
        <button onclick="closeModal('summary-modal')" class="text-gray-400 hover:text-gray-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <div id="summary-modal-content" class="px-6 py-4"></div>
    </div>
  </div>
</div>

<!-- Actions Modal -->
<div id="actions-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal('actions-modal')"></div>
    <div class="relative bg-white rounded-2xl shadow-xl transform transition-all sm:max-w-2xl sm:w-full">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 id="actions-modal-title" class="text-lg font-semibold text-gray-900">Action Items</h3>
        <button onclick="closeModal('actions-modal')" class="text-gray-400 hover:text-gray-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <div id="actions-modal-content" class="px-6 py-4"></div>
    </div>
  </div>
</div>

<%- include('partials/footer') -%>
