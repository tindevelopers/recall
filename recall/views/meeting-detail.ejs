<%- include('partials/header') -%>
<div class="min-h-full">
  <%- include('partials/navigation', { user: user, currentPage: 'meetings' }) -%>
  <%- include('partials/notice', { notice: notice }) -%>
  <div class="py-10">
    <header>
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="md:flex md:items-center md:justify-between">
          <div class="min-w-0 flex-1">
            <nav class="flex mb-4" aria-label="Breadcrumb">
              <ol role="list" class="flex items-center space-x-2">
                <li>
                  <a href="/meetings" class="text-sm font-medium text-gray-500 hover:text-gray-700">Meetings</a>
                </li>
                <li>
                  <svg class="h-5 w-5 flex-shrink-0 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd"></path>
                  </svg>
                </li>
                <li>
                  <span class="text-sm font-medium text-gray-900"><%= meeting.title %></span>
                </li>
              </ol>
            </nav>
            <h1 class="text-2xl font-bold leading-tight tracking-tight text-gray-900">
              <%= meeting.title %>
            </h1>
            <div class="mt-2 flex flex-col sm:flex-row sm:flex-wrap sm:space-x-6">
              <div class="mt-2 flex items-center text-sm text-gray-500">
                <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <% if (meeting.startTime) { %>
                  <span class="local-datetime" data-iso="<%= new Date(meeting.startTime).toISOString() %>" data-format="full"></span>
                <% } else { %>
                  Date unknown
                <% } %>
              </div>
              <% if (meeting.calendarEmail) { %>
                <div class="mt-2 flex items-center text-sm text-gray-500">
                  <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                  <%= meeting.calendarEmail %>
                </div>
              <% } %>
              <% if (meeting.participants && meeting.participants.length > 0) { %>
                <div class="mt-2 flex items-center text-sm text-gray-500">
                  <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                  </svg>
                  <%= meeting.participants.length %> participant<%= meeting.participants.length !== 1 ? 's' : '' %>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </header>
    <main>
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-8">
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
          <!-- Main content column -->
          <div class="lg:col-span-2 space-y-6">
            
            <!-- Media Player Section -->
            <% if (meeting.videoUrl || meeting.audioUrl) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Recording
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <!-- Media Toggle Buttons -->
                  <% if (meeting.videoUrl && meeting.audioUrl) { %>
                    <div class="flex space-x-2 mb-4">
                      <button 
                        type="button" 
                        onclick="toggleMedia('video')" 
                        id="video-toggle-btn"
                        class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                      >
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        Video
                      </button>
                      <button 
                        type="button" 
                        onclick="toggleMedia('audio')" 
                        id="audio-toggle-btn"
                        class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                      >
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        Audio Only
                      </button>
                    </div>
                  <% } %>

                  <!-- Video Player -->
                  <% if (meeting.videoUrl) { %>
                    <div id="video-player-container" class="mb-4">
                      <div class="relative bg-black rounded-lg overflow-hidden aspect-video">
                        <video 
                          id="video-player"
                          controls 
                          class="w-full h-full"
                          poster=""
                        >
                          <source src="<%= meeting.videoUrl %>" type="video/mp4">
                          Your browser does not support the video tag.
                        </video>
                      </div>
                    </div>
                  <% } %>

                  <!-- Audio Player -->
                  <% if (meeting.audioUrl) { %>
                    <div id="audio-player-container" class="mb-4 <%= meeting.videoUrl ? 'hidden' : '' %>">
                      <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-6">
                        <div class="flex items-center justify-center mb-4">
                          <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                          </div>
                        </div>
                        <p class="text-white text-center text-sm font-medium mb-4"><%= meeting.title %></p>
                        <audio 
                          id="audio-player"
                          controls 
                          class="w-full"
                        >
                          <source src="<%= meeting.audioUrl %>" type="audio/mpeg">
                          Your browser does not support the audio element.
                        </audio>
                      </div>
                    </div>
                  <% } %>

                  <!-- Download Buttons -->
                  <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200">
                    <% if (meeting.videoUrl || meeting.artifactId) { %>
                      <% 
                        const videoDownloadUrl = meeting.isShared && meeting.shareInfo?.shareToken 
                          ? `/api/meetings/shared/${meeting.shareInfo.shareToken}/recording/download/video`
                          : `/api/meetings/${meeting.artifactId || meeting.id}/recording/download/video`;
                      %>
                      <a
                        href="<%= videoDownloadUrl %>"
                        download
                        class="inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-500"
                      >
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download Video
                      </a>
                    <% } %>
                    <% if (meeting.audioUrl || meeting.artifactId) { %>
                      <% 
                        const audioDownloadUrl = meeting.isShared && meeting.shareInfo?.shareToken 
                          ? `/api/meetings/shared/${meeting.shareInfo.shareToken}/recording/download/audio`
                          : `/api/meetings/${meeting.artifactId || meeting.id}/recording/download/audio`;
                      %>
                      <a
                        href="<%= audioDownloadUrl %>"
                        download
                        class="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-500"
                      >
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download Audio
                      </a>
                    <% } %>
                  </div>
                </div>
              </div>
            <% } %>

            <!-- Tabbed Content Section -->
            <div class="overflow-hidden bg-white shadow sm:rounded-lg">
              <!-- Tab Navigation -->
              <div class="border-b border-gray-200">
                <nav class="-mb-px flex" aria-label="Tabs">
                  <button
                    type="button"
                    onclick="switchTab('summary')"
                    id="tab-summary"
                    class="tab-btn border-indigo-500 text-indigo-600 w-1/4 border-b-2 py-4 px-1 text-center text-sm font-medium"
                    aria-current="page"
                  >
                    <svg class="mx-auto h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    Summary
                  </button>
                  <button
                    type="button"
                    onclick="switchTab('actions')"
                    id="tab-actions"
                    class="tab-btn border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 w-1/4 border-b-2 py-4 px-1 text-center text-sm font-medium"
                  >
                    <svg class="mx-auto h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    Actions
                    <% if (meeting.actionItems && meeting.actionItems.length > 0) { %>
                      <span class="ml-1 inline-flex items-center rounded-full bg-orange-100 px-2 py-0.5 text-xs font-medium text-orange-800"><%= meeting.actionItems.length %></span>
                    <% } %>
                  </button>
                  <button
                    type="button"
                    onclick="switchTab('followups')"
                    id="tab-followups"
                    class="tab-btn border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 w-1/4 border-b-2 py-4 px-1 text-center text-sm font-medium"
                  >
                    <svg class="mx-auto h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Follow-ups
                    <% if (meeting.followUps && meeting.followUps.length > 0) { %>
                      <span class="ml-1 inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800"><%= meeting.followUps.length %></span>
                    <% } %>
                  </button>
                  <button
                    type="button"
                    onclick="switchTab('transcript')"
                    id="tab-transcript"
                    class="tab-btn border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 w-1/4 border-b-2 py-4 px-1 text-center text-sm font-medium"
                  >
                    <svg class="mx-auto h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Transcript
                  </button>
                </nav>
              </div>

              <!-- Tab Content -->
              <div class="px-4 py-5 sm:px-6">
                <!-- Summary Tab -->
                <div id="content-summary" class="tab-content">
                  <% if (meeting.summary) { %>
                    <div class="prose prose-sm max-w-none text-gray-700">
                      <%= meeting.summary %>
                    </div>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No summary available</h3>
                      <p class="mt-1 text-sm text-gray-500">An AI-generated summary will appear here once the meeting is processed.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Actions Tab -->
                <div id="content-actions" class="tab-content hidden">
                  <% if (meeting.actionItems && meeting.actionItems.length > 0) { %>
                    <ul class="space-y-3">
                      <% meeting.actionItems.forEach(function(item, index) { %>
                        <li class="flex items-start bg-orange-50 rounded-lg p-3">
                          <span class="flex-shrink-0 h-6 w-6 flex items-center justify-center rounded-full bg-orange-100 text-orange-600 text-xs font-medium">
                            <%= index + 1 %>
                          </span>
                          <div class="ml-3 flex-1">
                            <p class="text-sm text-gray-900">
                              <% if (typeof item === 'object') { %>
                                <%= item.task || item.description || item.text || JSON.stringify(item) %>
                              <% } else { %>
                                <%= item %>
                              <% } %>
                            </p>
                            <% if (typeof item === 'object' && (item.assignee || item.due_date)) { %>
                              <div class="mt-2 flex flex-wrap gap-2">
                                <% if (item.assignee) { %>
                                  <span class="inline-flex items-center rounded-full bg-white px-2 py-0.5 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-200">
                                    <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <%= item.assignee %>
                                  </span>
                                <% } %>
                                <% if (item.due_date) { %>
                                  <span class="inline-flex items-center rounded-full bg-red-50 px-2 py-0.5 text-xs font-medium text-red-600 ring-1 ring-inset ring-red-200">
                                    <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <%= item.due_date %>
                                  </span>
                                <% } %>
                              </div>
                            <% } %>
                          </div>
                        </li>
                      <% }); %>
                    </ul>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No action items</h3>
                      <p class="mt-1 text-sm text-gray-500">Action items extracted from the meeting will appear here.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Follow-ups Tab -->
                <div id="content-followups" class="tab-content hidden">
                  <% if (meeting.followUps && meeting.followUps.length > 0) { %>
                    <ul class="space-y-2">
                      <% meeting.followUps.forEach(function(item) { %>
                        <li class="flex items-start bg-blue-50 rounded-lg p-3">
                          <svg class="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path>
                          </svg>
                          <span class="ml-3 text-sm text-gray-700">
                            <% if (typeof item === 'object') { %>
                              <%= item.description || item.text || item.task || JSON.stringify(item) %>
                            <% } else { %>
                              <%= item %>
                            <% } %>
                          </span>
                        </li>
                      <% }); %>
                    </ul>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No follow-ups</h3>
                      <p class="mt-1 text-sm text-gray-500">Suggested follow-ups from the meeting will appear here.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Transcript Tab -->
                <div id="content-transcript" class="tab-content hidden">
                  <% 
                    const speakerPalette = ['indigo','blue','purple','emerald','amber','rose'];
                    const speakerClass = (name) => {
                      const str = name || 'Speaker';
                      let hash = 0;
                      for (let i = 0; i < str.length; i++) { hash = (hash << 5) - hash + str.charCodeAt(i); hash |= 0; }
                      const idx = Math.abs(hash) % speakerPalette.length;
                      return speakerPalette[idx];
                    };
                  %>
                  <% if (meeting.transcript && meeting.transcript.length > 0) { %>
                    <div class="max-h-96 overflow-y-auto">
                      <div class="space-y-4">
                        <% 
                          let currentSpeaker = null;
                          meeting.transcript.forEach(function(chunk) { 
                            const showSpeaker = chunk.speaker !== currentSpeaker;
                            currentSpeaker = chunk.speaker;
                        %>
                          <div class="<%= showSpeaker ? 'pt-3 border-t border-gray-100' : '' %>">
                            <% if (showSpeaker) { %>
                              <div class="flex items-center mb-1">
                                <% const color = speakerClass(chunk.speaker); %>
                                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-<%= color %>-100 text-<%= color %>-800">
                                  <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                  </svg>
                                  <%= chunk.speaker %>
                                </span>
                                <% if (chunk.startTimeMs) { %>
                                  <span class="ml-2 text-xs text-gray-400">
                                    <%= Math.floor(chunk.startTimeMs / 60000) %>:<%= String(Math.floor((chunk.startTimeMs % 60000) / 1000)).padStart(2, '0') %>
                                  </span>
                                <% } %>
                              </div>
                            <% } %>
                            <p class="text-sm text-gray-700 pl-4 text-left">
                              <%= chunk.text %>
                            </p>
                          </div>
                        <% }); %>
                      </div>
                    </div>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No transcript available</h3>
                      <p class="mt-1 text-sm text-gray-500">The meeting transcript will appear here once it's processed.</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>

          </div>

          <!-- Sidebar -->
          <div class="lg:col-span-1 space-y-6">
            
            <!-- Meeting Sentiment & Outcome -->
            <% if (meeting.sentiment || meeting.outcome) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Meeting Pulse
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6 space-y-4">
                  <% if (meeting.sentiment) { %>
                    <div>
                      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Sentiment</p>
                      <% 
                        const sentimentLabel = meeting.sentiment || 'neutral';
                        const sentimentLower = sentimentLabel.toLowerCase();
                        let sentimentColor = 'gray';
                        let sentimentIcon = 'ðŸ˜';
                        if (sentimentLower.includes('positive') || sentimentLower.includes('good') || sentimentLower.includes('great')) {
                          sentimentColor = 'green';
                          sentimentIcon = 'ðŸ˜Š';
                        } else if (sentimentLower.includes('negative') || sentimentLower.includes('bad') || sentimentLower.includes('poor')) {
                          sentimentColor = 'red';
                          sentimentIcon = 'ðŸ˜Ÿ';
                        } else if (sentimentLower.includes('neutral') || sentimentLower.includes('mixed')) {
                          sentimentColor = 'yellow';
                          sentimentIcon = 'ðŸ˜';
                        }
                        const sentimentScore = meeting.sentimentData?.score;
                        const sentimentConfidence = meeting.sentimentData?.confidence;
                      %>
                      <div class="inline-flex items-center rounded-full bg-<%= sentimentColor %>-100 px-3 py-1.5 text-sm font-medium text-<%= sentimentColor %>-800">
                        <span class="mr-2"><%= sentimentIcon %></span>
                        <%= sentimentLabel.charAt(0).toUpperCase() + sentimentLabel.slice(1) %>
                        <% if (sentimentScore !== undefined) { %>
                          <span class="ml-2 text-xs opacity-75">(<%= (sentimentScore * 100).toFixed(0) %>%<%= sentimentConfidence ? `, ${(sentimentConfidence * 100).toFixed(0)}% confidence` : '' %>)</span>
                        <% } %>
                      </div>
                    </div>
                  <% } %>
                  <% if (meeting.outcome) { %>
                    <div>
                      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Outcome</p>
                      <p class="text-sm text-gray-700"><%= meeting.outcome %></p>
                    </div>
                  <% } %>
                </div>
              </div>
            <% } %>

            <!-- Key Insights Section -->
            <% if (meeting.keyInsights && meeting.keyInsights.length > 0) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    Key Insights
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <ul class="space-y-3">
                    <% meeting.keyInsights.forEach(function(insight, index) { %>
                      <li class="flex items-start">
                        <span class="flex-shrink-0 h-5 w-5 flex items-center justify-center rounded-full bg-yellow-100 text-yellow-600 text-xs font-bold mt-0.5">
                          ðŸ’¡
                        </span>
                        <span class="ml-2 text-sm text-gray-700">
                          <% if (typeof insight === 'object') { %>
                            <%= insight.text || insight.insight || insight.description || JSON.stringify(insight) %>
                          <% } else { %>
                            <%= insight %>
                          <% } %>
                        </span>
                      </li>
                    <% }); %>
                  </ul>
                </div>
              </div>
            <% } %>

            <!-- Decisions Section -->
            <% if (meeting.decisions && meeting.decisions.length > 0) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Decisions Made
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <ul class="space-y-2">
                    <% meeting.decisions.forEach(function(decision) { %>
                      <li class="flex items-start bg-purple-50 rounded-lg p-2">
                        <svg class="h-4 w-4 text-purple-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="ml-2 text-sm text-gray-700">
                          <% if (typeof decision === 'object') { %>
                            <%= decision.text || decision.decision || decision.description || JSON.stringify(decision) %>
                          <% } else { %>
                            <%= decision %>
                          <% } %>
                        </span>
                      </li>
                    <% }); %>
                  </ul>
                </div>
              </div>
            <% } %>

            <!-- Topics Section -->
            <% if (meeting.topics && meeting.topics.length > 0) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    Topics Discussed
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <div class="flex flex-wrap gap-2">
                    <% meeting.topics.forEach(function(topic) { %>
                      <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 text-sm font-medium text-indigo-700">
                        <% if (typeof topic === 'object') { %>
                          <%= topic.name || topic.topic || topic.title || JSON.stringify(topic) %>
                        <% } else { %>
                          <%= topic %>
                        <% } %>
                      </span>
                    <% }); %>
                  </div>
                </div>
              </div>
            <% } %>

            <!-- Participants Section -->
            <% if (meeting.participants && meeting.participants.length > 0) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    Participants
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <ul class="space-y-2">
                    <% meeting.participants.forEach(function(participant) { %>
                      <li class="flex items-center">
                        <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                          <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                          </svg>
                        </div>
                        <span class="ml-3 text-sm text-gray-700">
                          <% if (typeof participant === 'object') { %>
                            <%= participant.name || participant.email || participant.displayName || JSON.stringify(participant) %>
                          <% } else { %>
                            <%= participant %>
                          <% } %>
                        </span>
                      </li>
                    <% }); %>
                  </ul>
                </div>
              </div>
            <% } %>

            <!-- Sharing Section -->
            <% if (meeting.isOwner) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    Share Meeting
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <p class="text-sm text-gray-500 mb-4">Share this meeting's transcript and summary with attendees.</p>
                  
                  <!-- Share with attendees form -->
                  <div id="share-attendees-container">
                    <div class="mb-4">
                      <label for="share-email" class="block text-sm font-medium text-gray-700 mb-1">Share with email</label>
                      <div class="flex gap-2">
                        <input 
                          type="email" 
                          id="share-email" 
                          placeholder="email@example.com"
                          class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"
                        >
                        <button 
                          type="button" 
                          onclick="shareMeeting()"
                          class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-500"
                        >
                          Share
                        </button>
                      </div>
                    </div>
                    
                    <!-- Quick share with attendees -->
                    <div id="attendees-to-share" class="space-y-2">
                      <p class="text-xs text-gray-500">Loading attendees...</p>
                    </div>
                  </div>
                  
                  <!-- Current shares -->
                  <div id="current-shares" class="mt-4 pt-4 border-t border-gray-200">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Shared with</h3>
                    <div id="shares-list" class="space-y-2">
                      <p class="text-xs text-gray-500">Loading...</p>
                    </div>
                  </div>
                </div>
              </div>
            <% } else if (meeting.isShared) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    Shared Meeting
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <div class="flex items-center text-sm text-gray-600">
                    <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>
                      Shared by <strong><%= meeting.shareInfo?.sharedBy?.name || meeting.shareInfo?.sharedBy?.email || 'Unknown' %></strong>
                    </span>
                  </div>
                  <p class="mt-2 text-xs text-gray-500">
                    Access level: <span class="capitalize"><%= meeting.shareInfo?.accessLevel || 'view' %></span>
                  </p>
                </div>
              </div>
            <% } %>

            <!-- Publish Status Section -->
            <% if (publishDeliveries && publishDeliveries.length > 0) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Published To
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <ul class="space-y-3">
                    <% publishDeliveries.forEach(function(delivery) { %>
                      <li class="flex items-center justify-between">
                        <div class="flex items-center">
                          <% if (delivery.PublishTarget?.type === 'notion') { %>
                            <svg class="h-5 w-5 text-gray-600" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.98-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.167V6.354c0-.606-.233-.933-.748-.886l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.22.186c-.094-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.14c-.093-.514.28-.886.747-.933zM1.936 1.035l13.31-.98c1.634-.14 2.055-.047 3.082.7l4.249 2.986c.7.513.934.653.934 1.213v16.378c0 1.026-.373 1.634-1.68 1.726l-15.458.934c-.98.047-1.448-.093-1.962-.747l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.447-1.632z"/>
                            </svg>
                          <% } else { %>
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                          <% } %>
                          <span class="ml-2 text-sm text-gray-700 capitalize"><%= delivery.PublishTarget?.type || 'Unknown' %></span>
                        </div>
                        <% if (delivery.status === 'delivered') { %>
                          <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700">
                            <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Sent
                          </span>
                        <% } else if (delivery.status === 'failed') { %>
                          <span class="inline-flex items-center rounded-full bg-red-50 px-2 py-1 text-xs font-medium text-red-700">
                            <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            Failed
                          </span>
                        <% } else { %>
                          <span class="inline-flex items-center rounded-full bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-700">
                            <svg class="mr-1 h-3 w-3 animate-spin" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Pending
                          </span>
                        <% } %>
                      </li>
                    <% }); %>
                  </ul>
                </div>
              </div>
            <% } %>

            <!-- Quick Actions -->
            <div class="overflow-hidden bg-white shadow sm:rounded-lg">
              <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h2 class="text-base font-semibold text-gray-900">Quick Actions</h2>
              </div>
              <div class="px-4 py-5 sm:px-6 space-y-3">
                <% if (meeting.artifactId && !meeting.hasBeenEnriched) { %>
                  <button
                    type="button"
                    onclick="triggerEnrichment('<%= meeting.artifactId %>')"
                    id="enrich-btn"
                    class="w-full inline-flex items-center justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                  >
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span id="enrich-btn-text">Generate AI Summary</span>
                  </button>
                <% } else if (meeting.artifactId && meeting.hasBeenEnriched) { %>
                  <button
                    type="button"
                    onclick="triggerEnrichment('<%= meeting.artifactId %>')"
                    id="enrich-btn"
                    class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                  >
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span id="enrich-btn-text">Re-generate Summary</span>
                  </button>
                <% } %>
                <% if (meeting.artifactId) { %>
                  <button
                    type="button"
                    onclick="openNotionDestinationPicker('<%= meeting.artifactId %>')"
                    id="publish-notion-btn"
                    class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-indigo-600 shadow-sm ring-1 ring-inset ring-indigo-200 hover:bg-indigo-50"
                  >
                    <svg class="mr-2 h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 2.02c-.42-.326-.98-.7-2.055-.607L3.01 2.72c-.466.046-.56.28-.374.466l1.823 1.022zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.166V6.354c0-.606-.233-.933-.748-.886l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.22.186c-.094-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.14c-.093-.514.28-.886.747-.933l3.222-.186zM2.877 1.16l13.681-.933c1.682-.14 2.101.093 2.801.606l3.876 2.754c.466.326.606.7.606 1.213v15.06c0 .933-.373 1.493-1.682 1.586l-15.457.933c-.98.047-1.448-.093-1.962-.7l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.682-1.633l.377.126z"/>
                    </svg>
                    <span id="publish-notion-btn-text">Publish to Notion</span>
                  </button>
                  <button
                    type="button"
                    onclick="publishToNotion('<%= meeting.artifactId %>')"
                    id="publish-btn"
                    class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                  >
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m-9 7h18a2 2 0 002-2V7a2 2 0 00-2-2H2a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span id="publish-btn-text">Publish to All Destinations</span>
                  </button>
                  <p class="text-xs text-gray-500">Publish to Notion (with destination picker) or all enabled targets.</p>
                <% } %>
                <a href="/meetings" class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                  <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                  </svg>
                  Back to Meetings
                </a>
                <a href="/" class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                  <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                  </svg>
                  Dashboard
                </a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
  // Store meeting ID for use in JavaScript (could be UUID or readableId)
  const meetingId = '<%= meeting.readableId || meeting.id %>';
  const artifactId = '<%= meeting.artifactId || "" %>';

  // Format all datetime elements to user's local timezone
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.local-datetime').forEach(function(el) {
      const iso = el.getAttribute('data-iso');
      const format = el.getAttribute('data-format');
      if (!iso) return;
      
      const date = new Date(iso);
      let formatted = '';
      
      if (format === 'date') {
        formatted = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
      } else if (format === 'time') {
        formatted = date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
      } else if (format === 'datetime') {
        formatted = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) + 
                    ' at ' + 
                    date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
      } else if (format === 'full') {
        formatted = date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) + 
                    ' at ' + 
                    date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
      }
      
      el.textContent = formatted;
    });
  });

  // Tab switching functionality
  function switchTab(tabName) {
    // Hide all content
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.add('hidden');
    });
    
    // Remove active state from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('border-indigo-500', 'text-indigo-600');
      btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
    });
    
    // Show selected content
    document.getElementById('content-' + tabName).classList.remove('hidden');
    
    // Activate selected tab
    const activeTab = document.getElementById('tab-' + tabName);
    activeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
    activeTab.classList.add('border-indigo-500', 'text-indigo-600');
  }

  // Notification system
  function showNotification(message, type = 'info') {
    // Remove any existing notifications
    const existing = document.getElementById('enrichment-notification');
    if (existing) {
      existing.remove();
    }

    const notification = document.createElement('div');
    notification.id = 'enrichment-notification';
    notification.className = `fixed top-4 right-4 z-50 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden`;
    
    const bgColor = type === 'success' ? 'bg-green-50' : type === 'error' ? 'bg-red-50' : 'bg-blue-50';
    const iconColor = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-blue-400';
    const textColor = type === 'success' ? 'text-green-800' : type === 'error' ? 'text-red-800' : 'text-blue-800';
    
    let iconSvg = '';
    if (type === 'success') {
      iconSvg = '<svg class="h-6 w-6 ' + iconColor + '" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
    } else if (type === 'error') {
      iconSvg = '<svg class="h-6 w-6 ' + iconColor + '" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
    } else {
      iconSvg = '<svg class="h-6 w-6 ' + iconColor + ' animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
    }
    
    const hoverColor = textColor.replace('800', '600');
    
    notification.innerHTML = 
      '<div class="p-4 ' + bgColor + '">' +
        '<div class="flex items-start">' +
          '<div class="flex-shrink-0">' + iconSvg + '</div>' +
          '<div class="ml-3 w-0 flex-1">' +
            '<p class="text-sm font-medium ' + textColor + '">' + message + '</p>' +
          '</div>' +
          '<div class="ml-4 flex-shrink-0 flex">' +
            '<button onclick="this.closest(\'#enrichment-notification\').remove()" class="inline-flex ' + textColor + ' hover:' + hoverColor + ' focus:outline-none">' +
              '<svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">' +
                '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>' +
              '</svg>' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds for success/error, keep info notifications until manually closed
    if (type !== 'info') {
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }
  }

  // Poll for summary completion
  async function pollForSummary(meetingId, maxAttempts = 60, intervalMs = 2000) {
    let attempts = 0;
    
    const poll = async () => {
      try {
        const response = await fetch(`/api/meetings/${meetingId}/summary`);
        const data = await response.json();
        
        if (data.summary && data.summary.content) {
          // Summary is ready!
          return true;
        }
        
        attempts++;
        if (attempts >= maxAttempts) {
          // Timeout after 2 minutes
          return false;
        }
        
        // Continue polling
        await new Promise(resolve => setTimeout(resolve, intervalMs));
        return poll();
      } catch (error) {
        console.error('Error polling for summary:', error);
        attempts++;
        if (attempts >= maxAttempts) {
          return false;
        }
        await new Promise(resolve => setTimeout(resolve, intervalMs));
        return poll();
      }
    };
    
    return poll();
  }

  // Enrichment trigger functionality
  async function triggerEnrichment(artifactId) {
    const btn = document.getElementById('enrich-btn');
    const btnText = document.getElementById('enrich-btn-text');
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    const originalText = btnText.textContent;
    btnText.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...';
    
    // Show "Please wait" notification
    showNotification('Please wait, generating AI summary... This may take a moment.', 'info');
    
    try {
      const response = await fetch('/api/meetings/enrich', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ artifactId }),
      });
      
      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Failed to trigger enrichment');
      }
      
      // Start polling for summary completion
      btnText.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
      
      const summaryReady = await pollForSummary(meetingId);
      
      if (summaryReady) {
        // Success! Show notification and refresh page
        showNotification('AI summary generated successfully! Refreshing page...', 'success');
        
        // Refresh page after a short delay to show the notification
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        // Timeout - show message that it's still processing
        showNotification('Summary generation is taking longer than expected. The page will refresh automatically when complete.', 'info');
        btnText.textContent = 'Still processing...';
        
        // Continue polling in background and refresh when ready
        setTimeout(async () => {
          const ready = await pollForSummary(meetingId, 120, 3000); // Poll for up to 6 more minutes
          if (ready) {
            showNotification('AI summary generated successfully!', 'success');
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          }
        }, 5000);
      }
    } catch (error) {
      console.error('Enrichment error:', error);
      showNotification('Error: ' + error.message, 'error');
      btnText.textContent = 'Error: ' + error.message;
      btn.classList.remove('opacity-75', 'cursor-not-allowed');
      btn.disabled = false;
      
      // Reset button text after 5 seconds
      setTimeout(() => {
        btnText.textContent = originalText;
      }, 5000);
    }
  }

  // Manual publish to Notion
  async function publishToNotion(artifactId) {
    const btn = document.getElementById('publish-btn');
    const btnText = document.getElementById('publish-btn-text');
    if (!btn) return;
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    const originalText = btnText.textContent;
    btnText.textContent = 'Queuing...';

    try {
      const response = await fetch(`/api/meetings/${artifactId}/publish`, {
        method: 'POST',
      });
      const result = await response.json();
      
      if (!response.ok) {
        // Handle specific error cases
        if (result.error === 'Notion not connected') {
          showNotification('Please connect your Notion account in Settings first.', 'error');
          btnText.textContent = 'Notion not connected';
        } else if (result.error === 'Notion destination not configured') {
          showNotification('Please configure a Notion destination in Settings first.', 'error');
          btnText.textContent = 'No destination configured';
        } else {
          throw new Error(result.message || result.error || 'Failed to queue publish');
        }
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        setTimeout(() => (btnText.textContent = originalText), 5000);
        return;
      }
      
      if (result.success) {
        if (result.action === 'publish') {
          showNotification('Publishing to Notion... This may take a moment.', 'info');
          btnText.textContent = 'Publishing...';
          
          // Poll for publish completion (check publish deliveries)
          setTimeout(async () => {
            try {
              // Reload page after a delay to show updated publish status
              setTimeout(() => {
                window.location.reload();
              }, 3000);
            } catch (pollErr) {
              console.error('Error checking publish status:', pollErr);
            }
          }, 2000);
        } else {
          showNotification('Generating summary first, then will publish to Notion...', 'info');
          btnText.textContent = 'Enriching then publish';
          
          // Wait for summary, then publish
          const summaryReady = await pollForSummary(meetingId, 60, 2000);
          if (summaryReady) {
            showNotification('Summary ready! Publishing to Notion...', 'info');
            // The enrichment job should have triggered publishing automatically
            setTimeout(() => {
              window.location.reload();
            }, 3000);
          } else {
            showNotification('Summary generation is taking longer than expected. Publishing will happen automatically when ready.', 'info');
            btnText.textContent = 'Processing...';
          }
        }
      } else {
        throw new Error(result.error || 'Failed to queue publish');
      }
    } catch (err) {
      console.error('Publish error:', err);
      showNotification('Error: ' + err.message, 'error');
      btnText.textContent = 'Error: ' + err.message;
      btn.disabled = false;
      btn.classList.remove('opacity-75', 'cursor-not-allowed');
      setTimeout(() => (btnText.textContent = originalText), 5000);
    }
  }

  // Media toggle functionality
  function toggleMedia(mediaType) {
    const videoContainer = document.getElementById('video-player-container');
    const audioContainer = document.getElementById('audio-player-container');
    const videoBtn = document.getElementById('video-toggle-btn');
    const audioBtn = document.getElementById('audio-toggle-btn');

    if (mediaType === 'video') {
      if (videoContainer) videoContainer.classList.remove('hidden');
      if (audioContainer) audioContainer.classList.add('hidden');
      if (videoBtn) {
        videoBtn.classList.remove('bg-white', 'text-gray-700', 'ring-1', 'ring-inset', 'ring-gray-300');
        videoBtn.classList.add('bg-indigo-600', 'text-white');
      }
      if (audioBtn) {
        audioBtn.classList.remove('bg-indigo-600', 'text-white');
        audioBtn.classList.add('bg-white', 'text-gray-700', 'ring-1', 'ring-inset', 'ring-gray-300');
      }
    } else {
      if (videoContainer) videoContainer.classList.add('hidden');
      if (audioContainer) audioContainer.classList.remove('hidden');
      if (audioBtn) {
        audioBtn.classList.remove('bg-white', 'text-gray-700', 'ring-1', 'ring-inset', 'ring-gray-300');
        audioBtn.classList.add('bg-indigo-600', 'text-white');
      }
      if (videoBtn) {
        videoBtn.classList.remove('bg-indigo-600', 'text-white');
        videoBtn.classList.add('bg-white', 'text-gray-700', 'ring-1', 'ring-inset', 'ring-gray-300');
      }
    }
  }

  // Sharing functionality
  const shareMeetingId = '<%= meeting.id %>';
  const isOwner = <%= meeting.isOwner ? 'true' : 'false' %>;
  
  // Load shareable attendees and current shares on page load
  if (isOwner) {
    loadShareableAttendees();
    loadCurrentShares();
  }
  
  async function loadShareableAttendees() {
    const container = document.getElementById('attendees-to-share');
    if (!container) return;
    
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shareable-attendees`);
      const data = await response.json();
      
      if (!response.ok) {
        container.innerHTML = '<p class="text-xs text-red-500">Failed to load attendees</p>';
        return;
      }
      
      if (!data.attendees || data.attendees.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500">No attendees to share with</p>';
        return;
      }
      
      container.innerHTML = data.attendees.map(attendee => `
        <div class="flex items-center justify-between py-1">
          <div class="flex items-center">
            <div class="h-6 w-6 rounded-full bg-gray-200 flex items-center justify-center">
              <svg class="h-3 w-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <span class="ml-2 text-xs text-gray-700">${attendee.name || attendee.email}</span>
            ${attendee.isRegistered ? '<span class="ml-1 text-xs text-green-600">âœ“</span>' : ''}
          </div>
          ${attendee.isShared 
            ? '<span class="text-xs text-green-600">Shared</span>'
            : `<button 
                type="button" 
                onclick="shareWithAttendee('${attendee.email}')"
                class="text-xs text-indigo-600 hover:text-indigo-800"
              >Share</button>`
          }
        </div>
      `).join('');
    } catch (error) {
      console.error('Error loading attendees:', error);
      container.innerHTML = '<p class="text-xs text-red-500">Error loading attendees</p>';
    }
  }
  
  async function loadCurrentShares() {
    const container = document.getElementById('shares-list');
    if (!container) return;
    
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares`);
      const data = await response.json();
      
      if (!response.ok) {
        container.innerHTML = '<p class="text-xs text-red-500">Failed to load shares</p>';
        return;
      }
      
      const activeShares = (data.shares || []).filter(s => s.status !== 'revoked');
      
      if (activeShares.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500">Not shared with anyone yet</p>';
        return;
      }
      
      container.innerHTML = activeShares.map(share => {
        const shareLink = share.shareToken ? `${window.location.origin}/meetings/shared/${share.shareToken}` : null;
        return `
        <div class="py-2 border-b border-gray-100 last:border-0">
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center">
              <div class="h-6 w-6 rounded-full bg-indigo-100 flex items-center justify-center">
                <svg class="h-3 w-3 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
              <span class="ml-2 text-xs text-gray-700">
                ${share.sharedWithUser?.name || share.sharedWithUser?.email || share.sharedWithEmail || 'Unknown'}
              </span>
              <span class="ml-2 text-xs text-gray-400 capitalize">(${share.accessLevel})</span>
            </div>
            <button 
              type="button" 
              onclick="revokeShare('${share.id}')"
              class="text-xs text-red-600 hover:text-red-800"
            >Revoke</button>
          </div>
          ${shareLink ? `
          <div class="mt-2 flex items-center gap-2">
            <input 
              type="text" 
              value="${shareLink}" 
              readonly 
              id="share-link-${share.id}"
              class="flex-1 text-xs px-2 py-1 bg-gray-50 border border-gray-200 rounded text-gray-600 font-mono"
              onclick="this.select()"
            >
            <button 
              type="button"
              onclick="copyShareLink('${share.id}', '${shareLink}')"
              class="text-xs px-2 py-1 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100"
              title="Copy link"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>
          ` : `
          <div class="mt-2">
            <button 
              type="button"
              onclick="generateShareToken('${share.id}')"
              class="text-xs px-2 py-1 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100"
            >
              Generate Shareable Link
            </button>
          </div>
          `}
        </div>
      `;
      }).join('');
    } catch (error) {
      console.error('Error loading shares:', error);
      container.innerHTML = '<p class="text-xs text-red-500">Error loading shares</p>';
    }
  }
  
  async function shareMeeting() {
    const emailInput = document.getElementById('share-email');
    const email = emailInput?.value?.trim();
    
    if (!email) {
      showNotification('Please enter an email address', 'error');
      return;
    }
    
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, accessLevel: 'view' }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        showNotification(data.error || 'Failed to share meeting', 'error');
        return;
      }
      
      showNotification(`Meeting shared with ${email}`, 'success');
      emailInput.value = '';
      loadShareableAttendees();
      loadCurrentShares();
    } catch (error) {
      console.error('Error sharing meeting:', error);
      showNotification('Failed to share meeting', 'error');
    }
  }
  
  async function shareWithAttendee(email) {
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, accessLevel: 'view' }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        showNotification(data.error || 'Failed to share meeting', 'error');
        return;
      }
      
      showNotification(`Meeting shared with ${email}`, 'success');
      loadShareableAttendees();
      loadCurrentShares();
    } catch (error) {
      console.error('Error sharing meeting:', error);
      showNotification('Failed to share meeting', 'error');
    }
  }
  
  async function revokeShare(shareId) {
    if (!confirm('Are you sure you want to revoke this share?')) return;
    
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares/${shareId}`, {
        method: 'DELETE',
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        showNotification(data.error || 'Failed to revoke share', 'error');
        return;
      }
      
      showNotification('Share revoked', 'success');
      loadShareableAttendees();
      loadCurrentShares();
    } catch (error) {
      console.error('Error revoking share:', error);
      showNotification('Failed to revoke share', 'error');
    }
  }

  // ===== Notion Destination Picker =====
  let notionDestinations = [];
  let selectedDestinationId = null;
  let selectedDestinationType = null;
  let createNewPage = false;
  let publishArtifactId = null;

  async function openNotionDestinationPicker(artifactId) {
    publishArtifactId = artifactId;
    const modal = document.getElementById('notion-destination-modal');
    const listContainer = document.getElementById('notion-destinations-list');
    const loadingEl = document.getElementById('notion-destinations-loading');
    const errorEl = document.getElementById('notion-destinations-error');
    const searchInput = document.getElementById('notion-destination-search');
    
    // Reset state
    selectedDestinationId = null;
    selectedDestinationType = null;
    createNewPage = false;
    searchInput.value = '';
    listContainer.innerHTML = '';
    loadingEl.classList.remove('hidden');
    errorEl.classList.add('hidden');
    document.getElementById('notion-publish-btn').disabled = true;
    updateCreateNewPageOption();
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Fetch destinations
    try {
      const response = await fetch('/api/notion/destinations');
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.message || data.error || 'Failed to load destinations');
      }
      
      notionDestinations = data.destinations || [];
      selectedDestinationId = data.defaultDestinationId;
      
      // Find the type of the default destination
      if (selectedDestinationId) {
        const defaultDest = notionDestinations.find(d => d.id === selectedDestinationId);
        selectedDestinationType = defaultDest?.type || 'page';
      }
      
      renderNotionDestinations(notionDestinations);
      updateCreateNewPageOption();
    } catch (error) {
      console.error('Error loading Notion destinations:', error);
      errorEl.textContent = error.message || 'Failed to load Notion destinations. Please check your Notion connection.';
      errorEl.classList.remove('hidden');
    } finally {
      loadingEl.classList.add('hidden');
    }
  }

  function closeNotionDestinationPicker() {
    document.getElementById('notion-destination-modal').classList.add('hidden');
  }

  function renderNotionDestinations(destinations) {
    const listContainer = document.getElementById('notion-destinations-list');
    
    if (destinations.length === 0) {
      listContainer.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <p>No Notion pages or databases found.</p>
          <p class="text-sm mt-2">Make sure you've shared pages with the Recall integration in Notion.</p>
        </div>
      `;
      return;
    }
    
    // Group by type
    const databases = destinations.filter(d => d.type === 'database');
    const pages = destinations.filter(d => d.type === 'page');
    
    let html = '';
    
    if (databases.length > 0) {
      html += `<div class="mb-4">
        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Databases (creates new page)</h4>
        <div class="space-y-1">
          ${databases.map(d => renderDestinationItem(d)).join('')}
        </div>
      </div>`;
    }
    
    if (pages.length > 0) {
      html += `<div>
        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Pages (appends content)</h4>
        <div class="space-y-1">
          ${pages.map(d => renderDestinationItem(d)).join('')}
        </div>
      </div>`;
    }
    
    listContainer.innerHTML = html;
    
    // Update button state
    document.getElementById('notion-publish-btn').disabled = !selectedDestinationId;
  }

  function renderDestinationItem(dest) {
    const isSelected = dest.id === selectedDestinationId;
    const icon = dest.icon || (dest.type === 'database' ? 'ðŸ“Š' : 'ðŸ“„');
    
    return `
      <button
        type="button"
        onclick="selectNotionDestination('${dest.id}', '${dest.type}')"
        class="w-full flex items-center px-3 py-2 rounded-lg text-left transition-colors ${
          isSelected 
            ? 'bg-indigo-50 ring-2 ring-indigo-500 text-indigo-700' 
            : 'hover:bg-gray-50 text-gray-700'
        }"
      >
        <span class="text-lg mr-3">${icon.length <= 2 ? icon : 'ðŸ“„'}</span>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate">${escapeHtml(dest.title)}</p>
          <p class="text-xs text-gray-500">${dest.type === 'database' ? 'Database' : 'Page'}</p>
        </div>
        ${isSelected ? `
          <svg class="h-5 w-5 text-indigo-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
        ` : ''}
      </button>
    `;
  }

  function selectNotionDestination(id, type) {
    selectedDestinationId = id;
    selectedDestinationType = type;
    createNewPage = false; // Reset when changing destination
    renderNotionDestinations(notionDestinations);
    updateCreateNewPageOption();
  }

  function updateCreateNewPageOption() {
    const container = document.getElementById('create-new-page-option');
    if (!container) return;
    
    // Only show "create new page" option for page destinations
    if (selectedDestinationType === 'page') {
      container.classList.remove('hidden');
      const checkbox = document.getElementById('create-new-page-checkbox');
      if (checkbox) checkbox.checked = createNewPage;
    } else {
      container.classList.add('hidden');
      createNewPage = false;
    }
  }

  function toggleCreateNewPage() {
    createNewPage = document.getElementById('create-new-page-checkbox')?.checked || false;
  }

  function filterNotionDestinations() {
    const query = document.getElementById('notion-destination-search').value.toLowerCase();
    const filtered = notionDestinations.filter(d => 
      d.title.toLowerCase().includes(query)
    );
    renderNotionDestinations(filtered);
  }

  async function publishToSelectedNotionDestination() {
    if (!selectedDestinationId || !publishArtifactId) return;
    
    const btn = document.getElementById('notion-publish-btn');
    const btnText = btn.querySelector('span');
    const originalText = btnText.textContent;
    
    btn.disabled = true;
    btnText.textContent = 'Publishing...';
    
    try {
      const selectedDest = notionDestinations.find(d => d.id === selectedDestinationId);
      
      const response = await fetch(`/api/meetings/${publishArtifactId}/publish/notion`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          destinationId: selectedDestinationId,
          destinationType: selectedDest?.type || 'database',
          createNewPage: createNewPage,
        }),
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.message || result.error || 'Failed to publish');
      }
      
      closeNotionDestinationPicker();
      showNotification(result.message || 'Publishing to Notion...', 'success');
      
      // Reload after a delay to show updated status
      setTimeout(() => window.location.reload(), 3000);
    } catch (error) {
      console.error('Error publishing to Notion:', error);
      showNotification(error.message || 'Failed to publish to Notion', 'error');
      btn.disabled = false;
      btnText.textContent = originalText;
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function copyShareLink(shareId, link) {
    navigator.clipboard.writeText(link).then(() => {
      showNotification('Share link copied to clipboard!', 'success');
      const btn = document.querySelector(`#share-link-${shareId}`).nextElementSibling;
      if (btn) {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
        }, 2000);
      }
    }).catch(err => {
      console.error('Failed to copy:', err);
      showNotification('Failed to copy link', 'error');
    });
  }

  async function generateShareToken(shareId) {
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares/${shareId}/generate-token`, {
        method: 'POST',
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to generate token');
      }
      
      showNotification('Shareable link generated!', 'success');
      loadCurrentShares(); // Reload to show the new link
    } catch (error) {
      console.error('Error generating share token:', error);
      showNotification(error.message || 'Failed to generate shareable link', 'error');
    }
  }
</script>

<!-- Notion Destination Picker Modal -->
<div id="notion-destination-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeNotionDestinationPicker()"></div>

    <!-- Modal panel -->
    <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
      <div class="absolute top-0 right-0 pt-4 pr-4">
        <button type="button" onclick="closeNotionDestinationPicker()" class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
          <span class="sr-only">Close</span>
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="sm:flex sm:items-start">
        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
          <svg class="h-6 w-6 text-indigo-600" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 2.02c-.42-.326-.98-.7-2.055-.607L3.01 2.72c-.466.046-.56.28-.374.466l1.823 1.022zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.166V6.354c0-.606-.233-.933-.748-.886l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.22.186c-.094-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.14c-.093-.514.28-.886.747-.933l3.222-.186zM2.877 1.16l13.681-.933c1.682-.14 2.101.093 2.801.606l3.876 2.754c.466.326.606.7.606 1.213v15.06c0 .933-.373 1.493-1.682 1.586l-15.457.933c-.98.047-1.448-.093-1.962-.7l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.682-1.633l.377.126z"/>
          </svg>
        </div>
        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
            Publish to Notion
          </h3>
          <p class="mt-1 text-sm text-gray-500">
            Select a Notion page or database to publish this meeting's notes.
          </p>
        </div>
      </div>
      
      <!-- Search -->
      <div class="mt-4">
        <input
          type="text"
          id="notion-destination-search"
          placeholder="Search pages and databases..."
          oninput="filterNotionDestinations()"
          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
        />
      </div>
      
      <!-- Loading state -->
      <div id="notion-destinations-loading" class="mt-4 text-center py-8">
        <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2 text-sm text-gray-500">Loading Notion destinations...</p>
      </div>
      
      <!-- Error state -->
      <div id="notion-destinations-error" class="hidden mt-4 p-4 bg-red-50 rounded-md">
        <p class="text-sm text-red-700"></p>
      </div>
      
      <!-- Destinations list -->
      <div id="notion-destinations-list" class="mt-4 max-h-64 overflow-y-auto">
        <!-- Populated by JavaScript -->
      </div>
      
      <!-- Create new page option (only shown for page destinations) -->
      <div id="create-new-page-option" class="hidden mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
        <label class="flex items-center cursor-pointer">
          <input
            type="checkbox"
            id="create-new-page-checkbox"
            onchange="toggleCreateNewPage()"
            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
          />
          <div class="ml-3">
            <span class="text-sm font-medium text-gray-900">Create new subpage</span>
            <p class="text-xs text-gray-500">Creates a new page under the selected page instead of appending content</p>
          </div>
        </label>
      </div>
      
      <!-- Actions -->
      <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse gap-3">
        <button
          type="button"
          id="notion-publish-btn"
          onclick="publishToSelectedNotionDestination()"
          disabled
          class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span>Publish to Selected</span>
        </button>
        <button
          type="button"
          onclick="closeNotionDestinationPicker()"
          class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') -%>
