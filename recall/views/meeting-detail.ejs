<%- include('partials/header') -%>
<style>
  /* Hide scrollbar for Chrome, Safari and Opera */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  /* Hide scrollbar for IE, Edge and Firefox */
  .scrollbar-hide {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }
</style>
<div class="min-h-full">
  <%- include('partials/navigation', { user: user, currentPage: 'meetings' }) -%>
  <%- include('partials/notice', { notice: notice }) -%>
  <div class="py-10">
    <header>
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="md:flex md:items-center md:justify-between">
          <div class="min-w-0 flex-1">
            <nav class="flex mb-4" aria-label="Breadcrumb">
              <ol role="list" class="flex items-center space-x-2">
                <li>
                  <a href="/meetings" class="text-sm font-medium text-gray-500 hover:text-gray-700">Meetings</a>
                </li>
                <li>
                  <svg class="h-5 w-5 flex-shrink-0 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd"></path>
                  </svg>
                </li>
                <li>
                  <span class="text-sm font-medium text-gray-900"><%= meeting.title %></span>
                </li>
              </ol>
            </nav>
            <h1 class="text-2xl font-bold leading-tight tracking-tight text-gray-900">
              <%= meeting.title %>
            </h1>
            <div class="mt-2 flex flex-col sm:flex-row sm:flex-wrap sm:space-x-6">
              <div class="mt-2 flex items-center text-sm text-gray-500">
                <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <% if (meeting.startTime) { %>
                  <span class="local-datetime" data-iso="<%= new Date(meeting.startTime).toISOString() %>" data-format="full"></span>
                <% } else { %>
                  Date unknown
                <% } %>
              </div>
              <% if (meeting.calendarEmail) { %>
                <div class="mt-2 flex items-center text-sm text-gray-500">
                  <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                  <%= meeting.calendarEmail %>
                </div>
              <% } %>
              <% if (meeting.participants && meeting.participants.length > 0) { %>
                <div class="mt-2 flex items-center text-sm text-gray-500">
                  <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                  </svg>
                  <%= meeting.participants.length %> participant<%= meeting.participants.length !== 1 ? 's' : '' %>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </header>
    <main>
      <div class="mx-auto max-w-7xl px-3 sm:px-6 lg:px-8 mt-6 sm:mt-8">
        <div class="grid grid-cols-1 gap-4 sm:gap-6 lg:grid-cols-3">
          <!-- Main content column -->
          <div class="lg:col-span-2 space-y-4 sm:space-y-6">
            
            <!-- Media Player Section -->
            <% if (meeting.videoUrl || meeting.audioUrl) { %>
              <div class="overflow-hidden bg-white shadow rounded-lg sm:rounded-lg">
                <div class="px-3 sm:px-6 py-4 sm:py-5 border-b border-gray-200">
                  <h2 class="text-base sm:text-lg font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 sm:w-5 h-4 sm:h-5 mr-2 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Recording
                  </h2>
                </div>
                <div class="px-3 sm:px-6 py-4 sm:py-5">
                  <!-- Media Toggle Buttons -->
                  <% if (meeting.videoUrl && meeting.audioUrl) { %>
                    <div class="flex flex-wrap gap-2 mb-4">
                      <button
                        type="button"
                        onclick="toggleMedia('video')"
                        id="video-toggle-btn"
                        class="inline-flex items-center rounded-lg bg-indigo-600 px-4 py-2 text-xs sm:text-sm font-semibold text-white shadow hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors"
                      >
                        <svg class="mr-2 h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        Video
                      </button>
                      <button
                        type="button"
                        onclick="toggleMedia('audio')"
                        id="audio-toggle-btn"
                        class="inline-flex items-center rounded-lg bg-gray-200 px-4 py-2 text-xs sm:text-sm font-semibold text-gray-800 shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors"
                      >
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        Audio Only
                      </button>
                    </div>
                  <% } %>

                  <!-- Video Player -->
                  <% if (meeting.videoUrl) { %>
                    <div id="video-player-container" class="mb-4">
                      <div class="relative bg-black rounded-lg overflow-hidden aspect-video">
                        <video 
                          id="video-player"
                          controls 
                          class="w-full h-full"
                          poster=""
                        >
                          <source src="<%= meeting.videoUrl %>" type="video/mp4">
                          Your browser does not support the video tag.
                        </video>
                      </div>
                    </div>
                  <% } %>

                  <!-- Audio Player -->
                  <% if (meeting.audioUrl) { %>
                    <div id="audio-player-container" class="mb-4 <%= meeting.videoUrl ? 'hidden' : '' %>">
                      <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-6">
                        <div class="flex items-center justify-center mb-4">
                          <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                          </div>
                        </div>
                        <p class="text-white text-center text-sm font-medium mb-4"><%= meeting.title %></p>
                        <audio 
                          id="audio-player"
                          controls 
                          class="w-full"
                        >
                          <source src="<%= meeting.audioUrl %>" type="audio/mpeg">
                          Your browser does not support the audio element.
                        </audio>
                      </div>
                    </div>
                  <% } %>

                  <!-- Download Buttons -->
                  <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200">
                    <% if (meeting.videoUrl || meeting.artifactId) { %>
                      <% 
                        const videoDownloadUrl = meeting.isShared && meeting.shareInfo?.shareToken 
                          ? `/api/meetings/shared/${meeting.shareInfo.shareToken}/recording/download/video`
                          : `/api/meetings/${meeting.artifactId || meeting.id}/recording/download/video`;
                      %>
                      <a
                        href="<%= videoDownloadUrl %>"
                        download
                        class="inline-flex items-center rounded-lg bg-green-600 px-4 py-2 text-xs sm:text-sm font-semibold text-white shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors"
                      >
                        <svg class="mr-2 h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download Video
                      </a>
                    <% } %>
                    <% if (meeting.audioUrl || meeting.artifactId) { %>
                      <% 
                        const audioDownloadUrl = meeting.isShared && meeting.shareInfo?.shareToken 
                          ? `/api/meetings/shared/${meeting.shareInfo.shareToken}/recording/download/audio`
                          : `/api/meetings/${meeting.artifactId || meeting.id}/recording/download/audio`;
                      %>
                      <a
                        href="<%= audioDownloadUrl %>"
                        download
                        class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-xs sm:text-sm font-semibold text-white shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
                      >
                        <svg class="mr-2 h-4 w-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download Audio
                      </a>
                    <% } %>
                  </div>
                </div>
              </div>
            <% } %>

            <!-- Tabbed Content Section -->
            <div class="overflow-hidden bg-white shadow sm:rounded-lg">
              <!-- Tab Navigation - Responsive with horizontal scroll -->
              <div class="border-b border-gray-200">
                <div class="overflow-x-auto scrollbar-hide">
                  <nav class="-mb-px flex min-w-max" aria-label="Tabs">
                    <button
                      type="button"
                      onclick="switchTab('summary')"
                      id="tab-summary"
                      class="tab-btn group relative border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-3 px-2 sm:px-4 text-center text-xs font-medium transition-colors"
                    >
                      <svg class="mx-auto h-5 w-5 mb-0.5 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                      </svg>
                      Summary
                    </button>
                    <button
                      type="button"
                      onclick="switchTab('topics')"
                      id="tab-topics"
                      class="tab-btn group relative border-indigo-500 text-indigo-600 whitespace-nowrap border-b-2 py-3 px-3 sm:px-4 text-center text-xs sm:text-sm font-medium transition-colors"
                      aria-current="page"
                    >
                      <svg class="mx-auto h-5 w-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h10"></path>
                      </svg>
                      Topics
                    </button>
                    <button
                      type="button"
                      onclick="switchTab('highlights')"
                      id="tab-highlights"
                      class="tab-btn group relative border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-3 px-3 sm:px-4 text-center text-xs sm:text-sm font-medium transition-colors"
                    >
                      <svg class="mx-auto h-5 w-5 mb-0.5 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                      </svg>
                      Highlights
                    </button>
                    <button
                      type="button"
                      onclick="switchTab('detailed')"
                      id="tab-detailed"
                      class="tab-btn group relative border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-3 px-3 sm:px-4 text-center text-xs sm:text-sm font-medium transition-colors"
                    >
                      <svg class="mx-auto h-5 w-5 mb-0.5 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-4 4v-4z"></path>
                      </svg>
                      <span class="hidden sm:inline">Detailed Notes</span>
                      <span class="sm:hidden">Notes</span>
                    </button>
                    <button
                      type="button"
                      onclick="switchTab('actions')"
                      id="tab-actions"
                      class="tab-btn group relative border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-3 px-3 sm:px-4 text-center text-xs sm:text-sm font-medium transition-colors"
                    >
                      <svg class="mx-auto h-5 w-5 mb-0.5 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                      </svg>
                      Actions
                      <% if (meeting.actionItems && meeting.actionItems.length > 0) { %>
                        <span class="absolute -top-1 -right-1 inline-flex items-center justify-center h-5 w-5 rounded-full bg-orange-500 text-xs font-bold text-white"><%= meeting.actionItems.length %></span>
                      <% } %>
                    </button>
                    <button
                      type="button"
                      onclick="switchTab('followups')"
                      id="tab-followups"
                      class="tab-btn group relative border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-3 px-3 sm:px-4 text-center text-xs sm:text-sm font-medium transition-colors"
                    >
                      <svg class="mx-auto h-5 w-5 mb-0.5 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <span class="hidden sm:inline">Follow-ups</span>
                      <span class="sm:hidden">Follow</span>
                      <% if (meeting.followUps && meeting.followUps.length > 0) { %>
                        <span class="absolute -top-1 -right-1 inline-flex items-center justify-center h-5 w-5 rounded-full bg-blue-500 text-xs font-bold text-white"><%= meeting.followUps.length %></span>
                      <% } %>
                    </button>
                    <button
                      type="button"
                      onclick="switchTab('transcript')"
                      id="tab-transcript"
                      class="tab-btn group relative border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-3 px-3 sm:px-4 text-center text-xs sm:text-sm font-medium transition-colors"
                    >
                      <svg class="mx-auto h-5 w-5 mb-0.5 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      Transcript
                    </button>
                    <button
                      type="button"
                      onclick="switchTab('stats')"
                      id="tab-stats"
                      class="tab-btn group relative border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap border-b-2 py-3 px-3 sm:px-4 text-center text-xs sm:text-sm font-medium transition-colors"
                    >
                      <svg class="mx-auto h-5 w-5 mb-0.5 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                      </svg>
                      Stats
                    </button>
                  </nav>
                </div>
              </div>

              <!-- Tab Content -->
              <div class="px-3 sm:px-6 py-4 sm:py-5">
                <!-- Summary Tab -->
                <div id="content-summary" class="tab-content hidden">
                  <% if (meeting.summary) { %>
                    <div class="prose prose-sm max-w-none text-gray-700">
                      <%= meeting.summary %>
                    </div>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No summary available</h3>
                      <p class="mt-1 text-sm text-gray-500">An AI-generated summary will appear here once the meeting is processed.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Topics Tab -->
                <div id="content-topics" class="tab-content">
                  <% if (meeting.topics && meeting.topics.length > 0) { %>
                    <% 
                      function topicTitle(topic, idx) {
                        if (typeof topic === 'string') return topic || `Topic ${idx + 1}`;
                        if (Array.isArray(topic)) return `Topic ${idx + 1}`;
                        return topic.title || topic.name || topic.topic || topic.heading || topic.label || `Topic ${idx + 1}`;
                      }
                      function topicBullets(topic) {
                        if (typeof topic === 'string') return [topic];
                        if (Array.isArray(topic)) return topic.map(item => typeof item === 'string' ? item : (item.text || item.summary || item.description || item.details || JSON.stringify(item)));
                        // Check for array properties first (items, points, bullets, etc.)
                        const arrayKeys = ['items', 'points', 'bullets', 'notes', 'entries', 'highlights', 'list'];
                        for (const key of arrayKeys) {
                          if (Array.isArray(topic[key]) && topic[key].length > 0) {
                            return topic[key].map(item => typeof item === 'string' ? item : (item.text || item.summary || item.description || item.details || item.content || item.note || JSON.stringify(item)));
                          }
                        }
                        // Handle AssemblyAI format: {topic: "title", details: "description"}
                        // Return details as a single bullet if present
                        if (topic.details && typeof topic.details === 'string') return [topic.details];
                        if (topic.summary) return [topic.summary];
                        if (topic.description) return [topic.description];
                        if (topic.content) return [topic.content];
                        if (topic.text) return [topic.text];
                        // Don't return JSON.stringify for objects with only topic/title property
                        const keys = Object.keys(topic).filter(k => !['topic', 'title', 'name', 'heading', 'label', 'id', 'index'].includes(k));
                        if (keys.length === 0) return ['No details available'];
                        return [JSON.stringify(topic)];
                      }
                      function parseTimeFromText(txt) {
                        if (!txt || typeof txt !== 'string') return null;
                        const match = txt.match(/(\d{1,2}:)?\d{1,2}:\d{2}/);
                        if (!match) return null;
                        const parts = match[0].split(':').map(Number);
                        if (parts.length === 3) {
                          return parts[0] * 3600 + parts[1] * 60 + parts[2];
                        }
                        return parts[0] * 60 + parts[1];
                      }
                      function formatTsLabel(sec) {
                        const hours = Math.floor(sec / 3600);
                        const minutes = Math.floor((sec % 3600) / 60);
                        const seconds = Math.floor(sec % 60);
                        if (hours > 0) return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        return `${minutes}:${String(seconds).padStart(2, '0')}`;
                      }
                    %>
                    <div class="flex items-center justify-between mb-4">
                      <div>
                        <h3 class="text-base font-semibold text-gray-900">Topics</h3>
                        <p class="text-sm text-gray-500">Expand chapters, jump to timestamps, or copy.</p>
                      </div>
                      <div class="flex items-center gap-2">
                        <button 
                          type="button" 
                          onclick="copyAllTopics()"
                          class="inline-flex items-center rounded-md bg-indigo-50 px-3 py-2 text-sm font-medium text-indigo-700 ring-1 ring-inset ring-indigo-200 hover:bg-indigo-100"
                          title="Copy entire recap"
                        >
                          <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                          </svg>
                          Copy recap
                        </button>
                      </div>
                    </div>
                    <div class="divide-y divide-gray-200 border border-gray-200 rounded-lg">
                      <% meeting.topics.forEach((topic, idx) => { 
                        const title = topicTitle(topic, idx);
                        const bullets = topicBullets(topic);
                      %>
                        <div class="topic-accordion">
                          <button 
                            type="button" 
                            class="w-full flex items-center justify-between px-4 py-3 hover:bg-gray-50"
                            onclick="toggleTopicAccordion(<%= idx %>)"
                            aria-expanded="<%= idx === 0 ? 'true' : 'false' %>"
                            aria-controls="topic-panel-<%= idx %>"
                          >
                            <div class="flex items-center gap-2">
                              <svg id="topic-chevron-<%= idx %>" class="h-4 w-4 text-gray-500 transform transition-transform <%= idx === 0 ? 'rotate-90' : 'rotate-0' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                              </svg>
                              <span class="text-sm font-semibold text-gray-900"><%= title %></span>
                            </div>
                            <div class="flex items-center gap-2">
                              <button 
                                type="button" 
                                onclick="copyTopic(<%= idx %>, event)"
                                class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-200 hover:bg-gray-100"
                                title="Copy chapter"
                              >
                                <svg class="h-3.5 w-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copy
                              </button>
                            </div>
                          </button>
                          <div id="topic-panel-<%= idx %>" class="<%= idx === 0 ? '' : 'hidden' %> border-t border-gray-100 bg-white" role="region">
                            <ul class="px-4 py-3 space-y-3">
                              <% bullets.forEach((bullet, bulletIdx) => { 
                                const text = typeof bullet === 'object' ? (bullet.text || bullet.summary || bullet.content || bullet.description || bullet.note || JSON.stringify(bullet)) : bullet;
                                const numericTs = typeof bullet === 'object' ? Number(bullet.timestamp_seconds ?? bullet.timestamp ?? bullet.ts ?? bullet.time ?? bullet.time_seconds ?? (bullet.startTimeMs ? bullet.startTimeMs / 1000 : NaN)) : NaN;
                                const parsedTs = Number.isNaN(numericTs) ? parseTimeFromText(text) : numericTs;
                                const tsSeconds = Number.isNaN(parsedTs) ? null : Math.max(0, Math.floor(parsedTs));
                                const tsLabel = tsSeconds !== null ? formatTsLabel(tsSeconds) : null;
                              %>
                                <li class="flex items-start gap-3">
                                  <span class="mt-1 h-1.5 w-1.5 rounded-full bg-indigo-400 flex-shrink-0"></span>
                                  <div class="flex-1">
                                    <p class="text-sm text-gray-800"><%= text %></p>
                                    <div class="mt-1 flex flex-wrap gap-2 text-xs text-gray-500">
                                      <% if (tsSeconds !== null) { %>
                                        <button 
                                          type="button" 
                                          class="inline-flex items-center rounded-full bg-indigo-50 px-2 py-0.5 text-indigo-700 ring-1 ring-indigo-200 hover:bg-indigo-100"
                                          onclick="jumpToTimestamp(<%= tsSeconds %>)"
                                        >
                                          <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                          </svg>
                                          <%= tsLabel %>
                                        </button>
                                      <% } %>
                                    </div>
                                  </div>
                                </li>
                              <% }); %>
                            </ul>
                          </div>
                        </div>
                      <% }); %>
                    </div>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 00-2 2h-5l-4 4v-4z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No topics yet</h3>
                      <p class="mt-1 text-sm text-gray-500">AI chapters will appear here once available.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Highlights Tab -->
                <div id="content-highlights" class="tab-content hidden">
                  <% if (meeting.highlights && meeting.highlights.length > 0) { %>
                    <ul class="space-y-3">
                      <% meeting.highlights.forEach(function(item, idx) { %>
                        <li class="p-3 rounded-lg border border-gray-100 bg-gray-50">
                          <div class="flex items-start justify-between">
                            <div>
                              <p class="text-sm font-semibold text-gray-900"><%= item.title || 'Highlight ' + (idx + 1) %></p>
                              <p class="mt-1 text-sm text-gray-700"><%= item.summary || item.text || '' %></p>
                              <div class="mt-2 flex flex-wrap gap-2 text-xs text-gray-500">
                                <% if (item.speaker) { %>
                                  <span class="inline-flex items-center rounded-full bg-white px-2 py-0.5 ring-1 ring-gray-200">
                                    <svg class="h-3 w-3 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <%= item.speaker %>
                                  </span>
                                <% } %>
                                <% const highlightTs = Number(item.timestamp_seconds); if (!Number.isNaN(highlightTs)) { %>
                                  <button 
                                    type="button" 
                                    class="inline-flex items-center rounded-full bg-indigo-50 px-2 py-0.5 text-indigo-700 ring-1 ring-indigo-200 hover:bg-indigo-100 cursor-pointer transition-colors"
                                    onclick="jumpToTimestamp(<%= Math.floor(highlightTs) %>)"
                                  >
                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <%= Math.floor(highlightTs / 60) %>:<%= String(Math.floor(highlightTs % 60)).padStart(2, '0') %>
                                  </button>
                                <% } %>
                                <% if (item.category) { %>
                                  <span class="inline-flex items-center rounded-full bg-purple-50 px-2 py-0.5 text-purple-700 ring-1 ring-purple-200 capitalize"><%= item.category %></span>
                                <% } %>
                                <% if (item.impact) { %>
                                  <span class="inline-flex items-center rounded-full bg-amber-50 px-2 py-0.5 text-amber-700 ring-1 ring-amber-200 capitalize">Impact: <%= item.impact %></span>
                                <% } %>
                              </div>
                            </div>
                            <span class="text-xs text-gray-400 ml-2">#<%= idx + 1 %></span>
                          </div>
                        </li>
                      <% }); %>
                    </ul>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No highlights yet</h3>
                      <p class="mt-1 text-sm text-gray-500">Key decisions and outcomes will appear here after processing.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Detailed Notes Tab -->
                <div id="content-detailed" class="tab-content hidden">
                  <% if (meeting.detailedNotes && meeting.detailedNotes.length > 0) { %>
                    <div class="space-y-3">
                      <% meeting.detailedNotes.forEach(function(item, idx) { %>
                        <div class="p-3 rounded-lg border border-gray-100 bg-white shadow-sm">
                          <div class="flex items-start justify-between">
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                              <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-gray-700">
                                <svg class="h-3 w-3 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <%= item.speaker || 'Speaker' %>
                              </span>
                              <% const detailTs = Number(item.timestamp_seconds); if (!Number.isNaN(detailTs)) { %>
                                <button 
                                  type="button" 
                                  class="inline-flex items-center rounded-full bg-indigo-50 px-2 py-0.5 text-indigo-700 ring-1 ring-indigo-200 hover:bg-indigo-100 cursor-pointer transition-colors"
                                  onclick="jumpToTimestamp(<%= Math.floor(detailTs) %>)"
                                >
                                  <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                  </svg>
                                  <%= Math.floor(detailTs / 60) %>:<%= String(Math.floor(detailTs % 60)).padStart(2, '0') %>
                                </button>
                              <% } %>
                              <% if (item.topic) { %>
                                <span class="inline-flex items-center rounded-full bg-blue-50 px-2 py-0.5 text-blue-700 ring-1 ring-blue-200"><%= item.topic %></span>
                              <% } %>
                              <% if (item.importance) { %>
                                <span class="inline-flex items-center rounded-full bg-amber-50 px-2 py-0.5 text-amber-700 ring-1 ring-amber-200 capitalize">Priority: <%= item.importance %></span>
                              <% } %>
                            </div>
                            <span class="text-xs text-gray-400 ml-2">#<%= idx + 1 %></span>
                          </div>
                          <p class="mt-2 text-sm text-gray-800 font-medium"><%= item.paraphrase || item.summary || item.text || '' %></p>
                          <% if (item.quote) { %>
                            <p class="mt-1 text-sm text-gray-500 italic">&ldquo;<%= item.quote %>&rdquo;</p>
                          <% } %>
                        </div>
                      <% }); %>
                    </div>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 00-2 2h-5l-4 4v-4z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No detailed notes yet</h3>
                      <p class="mt-1 text-sm text-gray-500">Paraphrased key phrases will appear here for richer context.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Actions Tab -->
                <div id="content-actions" class="tab-content hidden">
                  <% if (meeting.actionItems && meeting.actionItems.length > 0) { %>
                    <ul class="space-y-3">
                      <% meeting.actionItems.forEach(function(item, index) { %>
                        <li class="flex items-start bg-orange-50 rounded-lg p-3">
                          <span class="flex-shrink-0 h-6 w-6 flex items-center justify-center rounded-full bg-orange-100 text-orange-600 text-xs font-medium">
                            <%= index + 1 %>
                          </span>
                          <div class="ml-3 flex-1">
                            <p class="text-sm text-gray-900">
                              <% if (typeof item === 'object') { %>
                                <%= item.task || item.description || item.text || JSON.stringify(item) %>
                              <% } else { %>
                                <%= item %>
                              <% } %>
                            </p>
                            <% if (typeof item === 'object' && (item.assignee || item.due_date)) { %>
                              <div class="mt-2 flex flex-wrap gap-2">
                                <% if (item.assignee) { %>
                                  <span class="inline-flex items-center rounded-full bg-white px-2 py-0.5 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-200">
                                    <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <%= item.assignee %>
                                  </span>
                                <% } %>
                                <% if (item.due_date) { %>
                                  <span class="inline-flex items-center rounded-full bg-red-50 px-2 py-0.5 text-xs font-medium text-red-600 ring-1 ring-inset ring-red-200">
                                    <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <%= item.due_date %>
                                  </span>
                                <% } %>
                              </div>
                            <% } %>
                          </div>
                        </li>
                      <% }); %>
                    </ul>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No action items</h3>
                      <p class="mt-1 text-sm text-gray-500">Action items extracted from the meeting will appear here.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Follow-ups Tab -->
                <div id="content-followups" class="tab-content hidden">
                  <% if (meeting.followUps && meeting.followUps.length > 0) { %>
                    <ul class="space-y-2">
                      <% meeting.followUps.forEach(function(item) { %>
                        <li class="flex items-start bg-blue-50 rounded-lg p-3">
                          <svg class="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path>
                          </svg>
                          <span class="ml-3 text-sm text-gray-700">
                            <% if (typeof item === 'object') { %>
                              <%= item.description || item.text || item.task || JSON.stringify(item) %>
                            <% } else { %>
                              <%= item %>
                            <% } %>
                          </span>
                        </li>
                      <% }); %>
                    </ul>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No follow-ups</h3>
                      <p class="mt-1 text-sm text-gray-500">Suggested follow-ups from the meeting will appear here.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Transcript Tab -->
                <div id="content-transcript" class="tab-content hidden">
                  <% 
                    const speakerPalette = ['indigo','blue','purple','emerald','amber','rose'];
                    const speakerClass = (name) => {
                      const str = name || 'Speaker';
                      let hash = 0;
                      for (let i = 0; i < str.length; i++) { hash = (hash << 5) - hash + str.charCodeAt(i); hash |= 0; }
                      const idx = Math.abs(hash) % speakerPalette.length;
                      return speakerPalette[idx];
                    };
                  %>
                  <% if (meeting.transcript && meeting.transcript.length > 0) { %>
                    <div class="max-h-96 overflow-y-auto">
                      <div class="space-y-4">
                        <% 
                          let currentSpeaker = null;
                          meeting.transcript.forEach(function(chunk) { 
                            const showSpeaker = chunk.speaker !== currentSpeaker;
                            currentSpeaker = chunk.speaker;
                        %>
                          <div class="<%= showSpeaker ? 'pt-3 border-t border-gray-100' : '' %>">
                            <% if (showSpeaker) { %>
                              <div class="flex items-center mb-1">
                                <% const color = speakerClass(chunk.speaker); %>
                                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-<%= color %>-100 text-<%= color %>-800">
                                  <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                  </svg>
                                  <%= chunk.speaker %>
                                </span>
                                <% if (chunk.startTimeMs) { %>
                                  <span class="ml-2 text-xs text-gray-400">
                                    <%= Math.floor(chunk.startTimeMs / 60000) %>:<%= String(Math.floor((chunk.startTimeMs % 60000) / 1000)).padStart(2, '0') %>
                                  </span>
                                <% } %>
                              </div>
                            <% } %>
                            <p class="text-sm text-gray-700 pl-4 text-left">
                              <%= chunk.text %>
                            </p>
                          </div>
                        <% }); %>
                      </div>
                    </div>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">No transcript available</h3>
                      <p class="mt-1 text-sm text-gray-500">The meeting transcript will appear here once it's processed.</p>
                    </div>
                  <% } %>
                </div>

                <!-- Stats Tab -->
                <div id="content-stats" class="tab-content hidden">
                  <% const stats = meeting.stats; %>
                  <% if (stats && ((stats.speakers && stats.speakers.length) || stats.durationSeconds)) { %>
                    <div class="space-y-4">
                      <% if (stats.durationSeconds) { %>
                        <div class="rounded-lg border border-gray-100 bg-gray-50 p-4 flex items-center justify-between">
                          <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-semibold">
                              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                              </svg>
                            </div>
                            <div>
                              <p class="text-sm font-semibold text-gray-900">Estimated duration</p>
                              <p class="text-sm text-gray-600">
                                <% const totalMins = Math.round(stats.durationSeconds / 60); const hours = Math.floor(totalMins / 60); const mins = totalMins % 60; %>
                                <%= hours > 0 ? `${hours}h ${mins}m` : `${mins} min` %> (<%= Math.round(stats.durationSeconds) %>s)
                              </p>
                            </div>
                          </div>
                          <% if (stats.note) { %>
                            <span class="text-xs text-gray-400"><%= stats.note %></span>
                          <% } %>
                        </div>
                      <% } %>

                      <% if (stats.speakers && stats.speakers.length > 0) { %>
                        <div>
                          <h4 class="text-sm font-semibold text-gray-900 mb-3">Talk time by speaker</h4>
                          <div class="space-y-2">
                            <% stats.speakers.forEach(function(speaker) { %>
                              <div class="flex items-center justify-between rounded-lg border border-gray-100 p-3">
                                <div>
                                  <p class="text-sm font-medium text-gray-900"><%= speaker.name || 'Speaker' %></p>
                                  <p class="text-xs text-gray-500">
                                    <% const secs = Math.round(speaker.talkTimeSeconds || 0); const mins = Math.floor(secs / 60); const rem = secs % 60; %>
                                    <%= mins > 0 ? `${mins}m ${rem}s` : `${secs}s` %>
                                    <% if (speaker.turns) { %>
                                       <%= speaker.turns %> turns
                                    <% } %>
                                    <% if (speaker.wordCount) { %>
                                       <%= speaker.wordCount %> words
                                    <% } %>
                                  </p>
                                </div>
                                <div class="flex items-center gap-3">
                                  <% if (speaker.talkTimePercent !== null && speaker.talkTimePercent !== undefined) { %>
                                    <span class="text-sm font-semibold text-indigo-700"><%= speaker.talkTimePercent.toFixed(1) %>%</span>
                                  <% } %>
                                  <div class="w-32 bg-gray-100 rounded-full h-2 overflow-hidden">
                                    <% const pct = Math.max(0, Math.min(100, speaker.talkTimePercent || 0)); %>
                                    <div class="h-2 bg-indigo-500" style="width:<%= pct %>%"></div>
                                  </div>
                                </div>
                              </div>
                            <% }); %>
                          </div>
                        </div>
                      <% } %>
                    </div>
                  <% } else { %>
                    <div class="text-center py-8">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                      </svg>
                      <h3 class="mt-2 text-sm font-semibold text-gray-900">Stats unavailable</h3>
                      <p class="mt-1 text-sm text-gray-500">Talk-time stats will appear here once transcript timing is processed.</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>

          </div>

          <!-- Sidebar -->
          <div class="lg:col-span-1 space-y-4 sm:space-y-6">
            
            <!-- Meeting Sentiment & Outcome -->
            <% if (meeting.sentiment || meeting.outcome) { %>
              <div class="overflow-hidden bg-white shadow rounded-lg sm:rounded-lg">
                <div class="px-3 sm:px-6 py-4 sm:py-5 border-b border-gray-200">
                  <h2 class="text-sm sm:text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Meeting Pulse
                  </h2>
                </div>
                <div class="px-3 sm:px-6 py-4 sm:py-5 space-y-4">
                  <% if (meeting.sentiment) { %>
                    <div>
                      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Sentiment</p>
                      <% 
                        const sentimentLabel = meeting.sentiment || 'neutral';
                        const sentimentLower = sentimentLabel.toLowerCase();
                        let sentimentType = 'neutral';
                        let sentimentIcon = '';
                        if (sentimentLower.includes('positive') || sentimentLower.includes('good') || sentimentLower.includes('great')) {
                          sentimentType = 'positive';
                          sentimentIcon = '';
                        } else if (sentimentLower.includes('negative') || sentimentLower.includes('bad') || sentimentLower.includes('poor')) {
                          sentimentType = 'negative';
                          sentimentIcon = '';
                        }
                        const sentimentScore = meeting.sentimentData?.score;
                        const sentimentConfidence = meeting.sentimentData?.confidence;
                      %>
                      <div class="inline-flex items-center rounded-full px-3 py-1.5 text-sm font-medium <%= sentimentType === 'positive' ? 'bg-green-100 text-green-800' : sentimentType === 'negative' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800' %>">
                        <span class="mr-2"><%= sentimentIcon %></span>
                        <%= sentimentLabel.charAt(0).toUpperCase() + sentimentLabel.slice(1) %>
                        <% if (sentimentScore !== undefined) { %>
                          <span class="ml-2 text-xs opacity-75">(<%= (sentimentScore * 100).toFixed(0) %>%<%= sentimentConfidence ? `, ${(sentimentConfidence * 100).toFixed(0)}% confidence` : '' %>)</span>
                        <% } %>
                      </div>
                    </div>
                  <% } %>
                  <% if (meeting.outcome) { %>
                    <div>
                      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Outcome</p>
                      <% 
                        const outcomeLower = meeting.outcome.toLowerCase();
                        let outcomeLabel = meeting.outcome.replace(/_/g, ' ');
                        outcomeLabel = outcomeLabel.charAt(0).toUpperCase() + outcomeLabel.slice(1);
                        let outcomeClass = 'bg-gray-100 text-gray-700';
                        let outcomeIcon = '';
                        if (outcomeLower === 'productive') {
                          outcomeClass = 'bg-green-100 text-green-800';
                          outcomeIcon = '';
                        } else if (outcomeLower === 'inconclusive') {
                          outcomeClass = 'bg-yellow-100 text-yellow-800';
                          outcomeIcon = '';
                        } else if (outcomeLower === 'needs_followup') {
                          outcomeClass = 'bg-blue-100 text-blue-800';
                          outcomeIcon = '';
                        } else if (outcomeLower === 'blocked') {
                          outcomeClass = 'bg-red-100 text-red-800';
                          outcomeIcon = '';
                        } else if (outcomeLower === 'informational') {
                          outcomeClass = 'bg-purple-100 text-purple-800';
                          outcomeIcon = '';
                        }
                      %>
                      <div class="inline-flex items-center rounded-full px-3 py-1.5 text-sm font-medium <%= outcomeClass %>">
                        <span class="mr-2"><%= outcomeIcon %></span>
                        <%= outcomeLabel %>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            <% } %>

            <!-- Key Insights Section -->
            <% if (meeting.keyInsights && meeting.keyInsights.length > 0) { %>
              <div class="overflow-hidden bg-white shadow rounded-lg sm:rounded-lg">
                <div class="px-3 sm:px-6 py-4 sm:py-5 border-b border-gray-200">
                  <h2 class="text-sm sm:text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    Key Insights
                  </h2>
                </div>
                <div class="px-3 sm:px-6 py-4 sm:py-5">
                  <ul class="space-y-2 sm:space-y-3">
                    <% meeting.keyInsights.forEach(function(insight, index) { %>
                      <li class="flex items-start">
                        <span class="flex-shrink-0 h-5 w-5 flex items-center justify-center rounded-full bg-yellow-100 text-yellow-600 text-xs font-bold mt-0.5">
                          
                        </span>
                        <span class="ml-2 text-sm text-gray-700">
                          <% if (typeof insight === 'object') { %>
                            <%= insight.text || insight.insight || insight.description || JSON.stringify(insight) %>
                          <% } else { %>
                            <%= insight %>
                          <% } %>
                        </span>
                      </li>
                    <% }); %>
                  </ul>
                </div>
              </div>
            <% } %>

            <!-- Decisions Section -->
            <% if (meeting.decisions && meeting.decisions.length > 0) { %>
              <div class="overflow-hidden bg-white shadow rounded-lg sm:rounded-lg">
                <div class="px-3 sm:px-6 py-4 sm:py-5 border-b border-gray-200">
                  <h2 class="text-sm sm:text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Decisions Made
                  </h2>
                </div>
                <div class="px-3 sm:px-6 py-4 sm:py-5">
                  <ul class="space-y-2 sm:space-y-3">
                    <% meeting.decisions.forEach(function(decision) { %>
                      <li class="flex items-start bg-purple-50 rounded-lg p-2">
                        <svg class="h-4 w-4 text-purple-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="ml-2 text-sm text-gray-700">
                          <% if (typeof decision === 'object') { %>
                            <%= decision.text || decision.decision || decision.description || JSON.stringify(decision) %>
                          <% } else { %>
                            <%= decision %>
                          <% } %>
                        </span>
                      </li>
                    <% }); %>
                  </ul>
                </div>
              </div>
            <% } %>

            <!-- Participants Section -->
            <% if (meeting.participants && meeting.participants.length > 0) { %>
              <div class="overflow-hidden bg-white shadow rounded-lg sm:rounded-lg">
                <div class="px-3 sm:px-6 py-4 sm:py-5 border-b border-gray-200">
                  <h2 class="text-sm sm:text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    Participants
                  </h2>
                </div>
                <div class="px-3 sm:px-6 py-4 sm:py-5">
                  <ul class="space-y-2 sm:space-y-3">
                    <% meeting.participants.forEach(function(participant) { %>
                      <li class="flex items-center">
                        <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                          <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                          </svg>
                        </div>
                        <span class="ml-3 text-sm text-gray-700">
                          <% if (typeof participant === 'object') { %>
                            <%= participant.name || participant.email || participant.displayName || JSON.stringify(participant) %>
                          <% } else { %>
                            <%= participant %>
                          <% } %>
                        </span>
                      </li>
                    <% }); %>
                  </ul>
                </div>
              </div>
            <% } %>

            <!-- Sharing Section -->
            <% if (meeting.isOwner) { %>
              <div class="overflow-hidden bg-white shadow rounded-lg sm:rounded-lg">
                <div class="px-3 sm:px-6 py-4 sm:py-5 border-b border-gray-200">
                  <h2 class="text-sm sm:text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    Share Meeting
                  </h2>
                </div>
                <div class="px-3 sm:px-6 py-4 sm:py-5">
                  <p class="text-xs sm:text-sm text-gray-500 mb-4">Share this meeting's transcript and summary with attendees.</p>
                  
                  <!-- Share with attendees form -->
                  <div id="share-attendees-container">
                    <div class="mb-4">
                      <label for="share-email" class="block text-sm font-medium text-gray-700 mb-1">Share with email</label>
                      <div class="flex gap-2">
                        <input 
                          type="email" 
                          id="share-email" 
                          placeholder="email@example.com"
                          class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"
                        >
                        <button 
                          type="button" 
                          onclick="shareMeeting()"
                          class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-500"
                        >
                          Share
                        </button>
                      </div>
                    </div>
                    
                    <!-- Quick share with attendees -->
                    <div id="attendees-to-share" class="space-y-2">
                      <p class="text-xs text-gray-500">Loading attendees...</p>
                    </div>
                  </div>
                  
                  <!-- Current shares -->
                  <div id="current-shares" class="mt-4 pt-4 border-t border-gray-200">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Shared with</h3>
                    <div id="shares-list" class="space-y-2">
                      <p class="text-xs text-gray-500">Loading...</p>
                    </div>
                  </div>
                </div>
              </div>
            <% } else if (meeting.isShared) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    Shared Meeting
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <div class="flex items-center text-sm text-gray-600">
                    <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>
                      Shared by <strong><%= meeting.shareInfo?.sharedBy?.name || meeting.shareInfo?.sharedBy?.email || 'Unknown' %></strong>
                    </span>
                  </div>
                  <p class="mt-2 text-xs text-gray-500">
                    Access level: <span class="capitalize"><%= meeting.shareInfo?.accessLevel || 'view' %></span>
                  </p>
                </div>
              </div>
            <% } %>

            <!-- Publish Status Section -->
            <% if (publishDeliveries && publishDeliveries.length > 0) { %>
              <div class="overflow-hidden bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                  <h2 class="text-base font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Published To
                  </h2>
                </div>
                <div class="px-4 py-5 sm:px-6">
                  <ul class="space-y-3">
                    <% publishDeliveries.forEach(function(delivery) { %>
                      <li class="flex items-center justify-between">
                        <div class="flex items-center">
                          <% if (delivery.PublishTarget?.type === 'notion') { %>
                            <svg class="h-5 w-5 text-gray-600" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.98-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.167V6.354c0-.606-.233-.933-.748-.886l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.22.186c-.094-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.14c-.093-.514.28-.886.747-.933zM1.936 1.035l13.31-.98c1.634-.14 2.055-.047 3.082.7l4.249 2.986c.7.513.934.653.934 1.213v16.378c0 1.026-.373 1.634-1.68 1.726l-15.458.934c-.98.047-1.448-.093-1.962-.747l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.447-1.632z"/>
                            </svg>
                          <% } else { %>
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                          <% } %>
                          <span class="ml-2 text-sm text-gray-700 capitalize"><%= delivery.PublishTarget?.type || 'Unknown' %></span>
                        </div>
                        <% if (delivery.status === 'delivered' || delivery.status === 'success') { %>
                          <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700">
                            <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Sent
                          </span>
                        <% } else if (delivery.status === 'failed') { %>
                          <span class="inline-flex items-center rounded-full bg-red-50 px-2 py-1 text-xs font-medium text-red-700">
                            <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            Failed
                          </span>
                        <% } else { %>
                          <span class="inline-flex items-center rounded-full bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-700">
                            <svg class="mr-1 h-3 w-3 animate-spin" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Pending
                          </span>
                        <% } %>
                        <% if (delivery.url) { %>
                          <a href="<%= delivery.url %>" target="_blank" rel="noopener" class="ml-3 text-xs text-indigo-600 hover:text-indigo-800 underline">
                            Open
                          </a>
                        <% } %>
                      </li>
                    <% }); %>
                  </ul>
                </div>
              </div>
            <% } %>

            <!-- Quick Actions -->
            <div class="overflow-hidden bg-white shadow sm:rounded-lg">
              <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h2 class="text-base font-semibold text-gray-900">Quick Actions</h2>
              </div>
              <div class="px-4 py-5 sm:px-6 space-y-3">
                <% if (meeting.artifactId && !meeting.hasBeenEnriched) { %>
                  <button
                    type="button"
                    onclick="triggerEnrichment('<%= meeting.artifactId %>')"
                    id="enrich-btn"
                    class="w-full inline-flex items-center justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                  >
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span id="enrich-btn-text">Generate AI Summary</span>
                  </button>
                <% } else if (meeting.artifactId && meeting.hasBeenEnriched) { %>
                  <button
                    type="button"
                    onclick="triggerEnrichment('<%= meeting.artifactId %>')"
                    id="enrich-btn"
                    class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                  >
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span id="enrich-btn-text">Re-generate Summary</span>
                  </button>
                <% } %>
                <% if (meeting.artifactId) { %>
                  <button
                    type="button"
                    onclick="openNotionDestinationPicker('<%= meeting.artifactId %>')"
                    id="publish-notion-btn"
                    class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-indigo-600 shadow-sm ring-1 ring-inset ring-indigo-200 hover:bg-indigo-50"
                  >
                    <svg class="mr-2 h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 2.02c-.42-.326-.98-.7-2.055-.607L3.01 2.72c-.466.046-.56.28-.374.466l1.823 1.022zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.166V6.354c0-.606-.233-.933-.748-.886l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.22.186c-.094-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.14c-.093-.514.28-.886.747-.933l3.222-.186zM2.877 1.16l13.681-.933c1.682-.14 2.101.093 2.801.606l3.876 2.754c.466.326.606.7.606 1.213v15.06c0 .933-.373 1.493-1.682 1.586l-15.457.933c-.98.047-1.448-.093-1.962-.7l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.682-1.633l.377.126z"/>
                    </svg>
                    <span id="publish-notion-btn-text">Publish to Notion</span>
                  </button>
                  <button
                    type="button"
                    onclick="openSlackDestinationPicker('<%= meeting.artifactId %>')"
                    id="publish-slack-btn"
                    class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-sky-600 shadow-sm ring-1 ring-inset ring-sky-200 hover:bg-sky-50"
                  >
                    <svg class="mr-2 h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M5.1 15.9c0 1.05-.86 1.9-1.9 1.9S1.3 16.95 1.3 15.9s.86-1.9 1.9-1.9h1.9v1.9zm.95 0c0-1.05.86-1.9 1.9-1.9s1.9.85 1.9 1.9v4.75c0 1.05-.86 1.9-1.9 1.9s-1.9-.85-1.9-1.9V15.9zm1.9-10.85c-1.05 0-1.9-.86-1.9-1.9S6 1.25 7.05 1.25 8.95 2.1 8.95 3.15v1.9H7.05zm0 .95c1.05 0 1.9.86 1.9 1.9s-.86 1.9-1.9 1.9H2.3c-1.05 0-1.9-.86-1.9-1.9S1.25 6 2.3 6h4.75zM18.9 8.05c0-1.05.86-1.9 1.9-1.9s1.9.86 1.9 1.9-.86 1.9-1.9 1.9h-1.9v-1.9zm-.95 0c0 1.05-.86 1.9-1.9 1.9s-1.9-.86-1.9-1.9V3.3c0-1.05.86-1.9 1.9-1.9s1.9.86 1.9 1.9v4.75zm-1.9 10.85c1.05 0 1.9.86 1.9 1.9s-.86 1.9-1.9 1.9-1.9-.86-1.9-1.9v-1.9h1.9zm0-.95c-1.05 0-1.9-.86-1.9-1.9s.86-1.9 1.9-1.9h4.75c1.05 0 1.9.86 1.9 1.9s-.86 1.9-1.9 1.9H16.05z"/>
                    </svg>
                    <span id="publish-slack-btn-text">Publish to Slack</span>
                  </button>
                  <button
                    type="button"
                    onclick="publishToNotion('<%= meeting.artifactId %>')"
                    id="publish-btn"
                    class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                  >
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m-9 7h18a2 2 0 002-2V7a2 2 0 00-2-2H2a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span id="publish-btn-text">Publish to All Destinations</span>
                  </button>
                  <p class="text-xs text-gray-500">Publish to Notion (with destination picker) or all enabled targets.</p>
                <% } %>
                <a href="/meetings" class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                  <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                  </svg>
                  Back to Meetings
                </a>
                <a href="/" class="w-full inline-flex items-center justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                  <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                  </svg>
                  Dashboard
                </a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
  // Store meeting ID for use in JavaScript (could be UUID or readableId)
  const meetingId = '<%= meeting.readableId || meeting.id %>';
  const artifactId = '<%= meeting.artifactId || "" %>';
  const topicsData = <%- JSON.stringify(meeting.topics || []) %>;

  // Format all datetime elements to user's local timezone
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.local-datetime').forEach(function(el) {
      const iso = el.getAttribute('data-iso');
      const format = el.getAttribute('data-format');
      if (!iso) return;
      
      const date = new Date(iso);
      let formatted = '';
      
      if (format === 'date') {
        formatted = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
      } else if (format === 'time') {
        formatted = date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
      } else if (format === 'datetime') {
        formatted = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) + 
                    ' at ' + 
                    date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
      } else if (format === 'full') {
        formatted = date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) + 
                    ' at ' + 
                    date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
      }
      
      el.textContent = formatted;
    });
  });

  // Tab switching functionality
  function switchTab(tabName) {
    // Hide all content
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.add('hidden');
    });
    
    // Remove active state from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('border-indigo-500', 'text-indigo-600');
      btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
    });
    
    // Show selected content
    document.getElementById('content-' + tabName).classList.remove('hidden');
    
    // Activate selected tab
    const activeTab = document.getElementById('tab-' + tabName);
    activeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
    activeTab.classList.add('border-indigo-500', 'text-indigo-600');
  }

  // Topics accordion + helpers
  function topicTitleClient(topic, idx) {
    if (typeof topic === 'string') return topic || `Topic ${idx + 1}`;
    if (Array.isArray(topic)) return `Topic ${idx + 1}`;
    return topic.title || topic.name || topic.topic || topic.heading || topic.label || `Topic ${idx + 1}`;
  }

  function topicBulletsClient(topic) {
    if (typeof topic === 'string') return [topic];
    if (Array.isArray(topic)) return topic.map(item => typeof item === 'string' ? item : (item.text || item.summary || item.description || item.details || JSON.stringify(item)));
    // Check for array properties first (items, points, bullets, etc.)
    const arrayKeys = ['items', 'points', 'bullets', 'notes', 'entries', 'highlights', 'list'];
    for (const key of arrayKeys) {
      if (Array.isArray(topic[key]) && topic[key].length > 0) {
        return topic[key].map(item => typeof item === 'string' ? item : (item.text || item.summary || item.description || item.details || item.content || item.note || JSON.stringify(item)));
      }
    }
    // Handle AssemblyAI format: {topic: "title", details: "description"}
    if (topic.details && typeof topic.details === 'string') return [topic.details];
    if (topic.summary) return [topic.summary];
    if (topic.description) return [topic.description];
    if (topic.content) return [topic.content];
    if (topic.text) return [topic.text];
    // Don't return JSON.stringify for objects with only topic/title property
    const keys = Object.keys(topic).filter(k => !['topic', 'title', 'name', 'heading', 'label', 'id', 'index'].includes(k));
    if (keys.length === 0) return ['No details available'];
    return [JSON.stringify(topic)];
  }

  function parseTimecodeToSeconds(text) {
    if (typeof text === 'number' && !Number.isNaN(text)) return text;
    if (!text || typeof text !== 'string') return null;
    const match = text.match(/(\d{1,2}:)?\d{1,2}:\d{2}/);
    if (!match) return null;
    const parts = match[0].split(':').map(Number);
    if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
    return parts[0] * 60 + parts[1];
  }

  function formatSecondsLabel(sec) {
    const hours = Math.floor(sec / 3600);
    const minutes = Math.floor((sec % 3600) / 60);
    const seconds = Math.floor(sec % 60);
    if (hours > 0) return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    return `${minutes}:${String(seconds).padStart(2, '0')}`;
  }

  function toggleTopicAccordion(idx) {
    const panel = document.getElementById(`topic-panel-${idx}`);
    const chevron = document.getElementById(`topic-chevron-${idx}`);
    if (!panel) return;
    const isHidden = panel.classList.contains('hidden');
    panel.classList.toggle('hidden', !isHidden);
    panel.setAttribute('aria-hidden', (!isHidden).toString());
    if (chevron) {
      chevron.classList.toggle('rotate-90', isHidden);
      chevron.classList.toggle('rotate-0', !isHidden);
    }
  }

  function copyTextToClipboard(text) {
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text)
        .then(() => showNotification('Copied to clipboard', 'success'))
        .catch(() => fallbackCopy(text));
    } else {
      fallbackCopy(text);
    }
  }

  function fallbackCopy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      showNotification('Copied to clipboard', 'success');
    } catch (err) {
      console.error('Clipboard copy failed', err);
      showNotification('Failed to copy', 'error');
    }
    document.body.removeChild(textarea);
  }

  function copyTopic(idx, event) {
    if (event) event.stopPropagation();
    const topic = topicsData[idx];
    if (!topic) {
      showNotification('Nothing to copy for this topic', 'error');
      return;
    }
    const title = topicTitleClient(topic, idx);
    const bullets = topicBulletsClient(topic);
    const body = bullets.map(item => `- ${typeof item === 'string' ? item : (item.text || item.summary || item.description || item.content || item.note || JSON.stringify(item))}`).join('\n');
    copyTextToClipboard(`${title}\n${body}`);
  }

  function copyAllTopics() {
    if (!topicsData || !topicsData.length) {
      showNotification('No topics to copy', 'error');
      return;
    }
    const sections = topicsData.map((topic, idx) => {
      const title = topicTitleClient(topic, idx);
      const bullets = topicBulletsClient(topic);
      const body = bullets.map(item => `- ${typeof item === 'string' ? item : (item.text || item.summary || item.description || item.content || item.note || JSON.stringify(item))}`).join('\n');
      return `${title}\n${body}`;
    }).join('\n\n');
    copyTextToClipboard(sections);
  }

  function jumpToTimestamp(seconds) {
    if (typeof seconds !== 'number' || Number.isNaN(seconds)) return;
    const videoContainer = document.getElementById('video-player-container');
    const audioContainer = document.getElementById('audio-player-container');
    const video = document.getElementById('video-player');
    const audio = document.getElementById('audio-player');

    if (video && videoContainer && videoContainer.classList.contains('hidden')) {
      toggleMedia('video');
    }

    const target = video || audio;
    if (target) {
      try {
        target.currentTime = seconds;
        if (target.pause) {
          target.play().catch(() => {
            showNotification('Jumped to timestamp; press play to continue', 'info');
          });
        }
      } catch (err) {
        console.error('Seek failed', err);
        showNotification('Could not seek to timestamp', 'error');
      }
    }
  }

  // Notification system
  function showNotification(message, type = 'info') {
    // Remove any existing notifications
    const existing = document.getElementById('enrichment-notification');
    if (existing) {
      existing.remove();
    }

    const notification = document.createElement('div');
    notification.id = 'enrichment-notification';
    notification.className = `fixed top-4 right-4 z-50 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden`;
    
    const bgColor = type === 'success' ? 'bg-green-50' : type === 'error' ? 'bg-red-50' : 'bg-blue-50';
    const iconColor = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-blue-400';
    const textColor = type === 'success' ? 'text-green-800' : type === 'error' ? 'text-red-800' : 'text-blue-800';
    
    let iconSvg = '';
    if (type === 'success') {
      iconSvg = '<svg class="h-6 w-6 ' + iconColor + '" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
    } else if (type === 'error') {
      iconSvg = '<svg class="h-6 w-6 ' + iconColor + '" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
    } else {
      iconSvg = '<svg class="h-6 w-6 ' + iconColor + ' animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
    }
    
    const hoverColor = textColor.replace('800', '600');
    
    notification.innerHTML = 
      '<div class="p-4 ' + bgColor + '">' +
        '<div class="flex items-start">' +
          '<div class="flex-shrink-0">' + iconSvg + '</div>' +
          '<div class="ml-3 w-0 flex-1">' +
            '<p class="text-sm font-medium ' + textColor + '">' + message + '</p>' +
          '</div>' +
          '<div class="ml-4 flex-shrink-0 flex">' +
            '<button onclick="this.closest(\'#enrichment-notification\').remove()" class="inline-flex ' + textColor + ' hover:' + hoverColor + ' focus:outline-none">' +
              '<svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">' +
                '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>' +
              '</svg>' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds for success/error, keep info notifications until manually closed
    if (type !== 'info') {
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }
  }

  // Poll for summary completion
  async function pollForSummary(meetingId, maxAttempts = 60, intervalMs = 2000) {
    let attempts = 0;
    
    const poll = async () => {
      try {
        const response = await fetch(`/api/meetings/${meetingId}/summary`);
        const data = await response.json();
        
        if (data.summary && data.summary.content) {
          // Summary is ready!
          return true;
        }
        
        attempts++;
        if (attempts >= maxAttempts) {
          // Timeout after 2 minutes
          return false;
        }
        
        // Continue polling
        await new Promise(resolve => setTimeout(resolve, intervalMs));
        return poll();
      } catch (error) {
        console.error('Error polling for summary:', error);
        attempts++;
        if (attempts >= maxAttempts) {
          return false;
        }
        await new Promise(resolve => setTimeout(resolve, intervalMs));
        return poll();
      }
    };
    
    return poll();
  }

  // Enrichment trigger functionality
  async function triggerEnrichment(artifactId) {
    const btn = document.getElementById('enrich-btn');
    const btnText = document.getElementById('enrich-btn-text');
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    const originalText = btnText.textContent;
    btnText.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...';
    
    // Show "Please wait" notification
    showNotification('Please wait, generating AI summary... This may take a moment.', 'info');
    
    try {
      const response = await fetch('/api/meetings/enrich', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ artifactId }),
      });
      
      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Failed to trigger enrichment');
      }
      
      // Start polling for summary completion
      btnText.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
      
      const summaryReady = await pollForSummary(meetingId);
      
      if (summaryReady) {
        // Success! Show notification and refresh page
        showNotification('AI summary generated successfully! Refreshing page...', 'success');
        
        // Refresh page after a short delay to show the notification
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        // Timeout - show message that it's still processing
        showNotification('Summary generation is taking longer than expected. The page will refresh automatically when complete.', 'info');
        btnText.textContent = 'Still processing...';
        
        // Continue polling in background and refresh when ready
        setTimeout(async () => {
          const ready = await pollForSummary(meetingId, 120, 3000); // Poll for up to 6 more minutes
          if (ready) {
            showNotification('AI summary generated successfully!', 'success');
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          }
        }, 5000);
      }
    } catch (error) {
      console.error('Enrichment error:', error);
      showNotification('Error: ' + error.message, 'error');
      btnText.textContent = 'Error: ' + error.message;
      btn.classList.remove('opacity-75', 'cursor-not-allowed');
      btn.disabled = false;
      
      // Reset button text after 5 seconds
      setTimeout(() => {
        btnText.textContent = originalText;
      }, 5000);
    }
  }

  // Manual publish to Notion
  async function publishToNotion(artifactId) {
    const btn = document.getElementById('publish-btn');
    const btnText = document.getElementById('publish-btn-text');
    if (!btn) return;
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    const originalText = btnText.textContent;
    btnText.textContent = 'Queuing...';

    try {
      const response = await fetch(`/api/meetings/${artifactId}/publish`, {
        method: 'POST',
      });
      const result = await response.json();
      
      if (!response.ok) {
        // Handle specific error cases
        if (result.error === 'Notion not connected') {
          showNotification('Please connect your Notion account in Settings first.', 'error');
          btnText.textContent = 'Notion not connected';
        } else if (result.error === 'Notion destination not configured') {
          showNotification('Please configure a Notion destination in Settings first.', 'error');
          btnText.textContent = 'No destination configured';
        } else {
          throw new Error(result.message || result.error || 'Failed to queue publish');
        }
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        setTimeout(() => (btnText.textContent = originalText), 5000);
        return;
      }
      
      if (result.success) {
        if (result.action === 'publish') {
          showNotification('Publishing to Notion... This may take a moment.', 'info');
          btnText.textContent = 'Publishing...';
          
          // Poll for publish completion (check publish deliveries)
          setTimeout(async () => {
            try {
              // Reload page after a delay to show updated publish status
              setTimeout(() => {
                window.location.reload();
              }, 3000);
            } catch (pollErr) {
              console.error('Error checking publish status:', pollErr);
            }
          }, 2000);
        } else {
          showNotification('Generating summary first, then will publish to Notion...', 'info');
          btnText.textContent = 'Enriching then publish';
          
          // Wait for summary, then publish
          const summaryReady = await pollForSummary(meetingId, 60, 2000);
          if (summaryReady) {
            showNotification('Summary ready! Publishing to Notion...', 'info');
            // The enrichment job should have triggered publishing automatically
            setTimeout(() => {
              window.location.reload();
            }, 3000);
          } else {
            showNotification('Summary generation is taking longer than expected. Publishing will happen automatically when ready.', 'info');
            btnText.textContent = 'Processing...';
          }
        }
      } else {
        throw new Error(result.error || 'Failed to queue publish');
      }
    } catch (err) {
      console.error('Publish error:', err);
      showNotification('Error: ' + err.message, 'error');
      btnText.textContent = 'Error: ' + err.message;
      btn.disabled = false;
      btn.classList.remove('opacity-75', 'cursor-not-allowed');
      setTimeout(() => (btnText.textContent = originalText), 5000);
    }
  }

  // Media toggle functionality
  function toggleMedia(mediaType) {
    const videoContainer = document.getElementById('video-player-container');
    const audioContainer = document.getElementById('audio-player-container');
    const videoBtn = document.getElementById('video-toggle-btn');
    const audioBtn = document.getElementById('audio-toggle-btn');

    if (mediaType === 'video') {
      if (videoContainer) videoContainer.classList.remove('hidden');
      if (audioContainer) audioContainer.classList.add('hidden');
      if (videoBtn) {
        videoBtn.classList.remove('bg-white', 'text-gray-700', 'ring-1', 'ring-inset', 'ring-gray-300');
        videoBtn.classList.add('bg-indigo-600', 'text-white');
      }
      if (audioBtn) {
        audioBtn.classList.remove('bg-indigo-600', 'text-white');
        audioBtn.classList.add('bg-white', 'text-gray-700', 'ring-1', 'ring-inset', 'ring-gray-300');
      }
    } else {
      if (videoContainer) videoContainer.classList.add('hidden');
      if (audioContainer) audioContainer.classList.remove('hidden');
      if (audioBtn) {
        audioBtn.classList.remove('bg-white', 'text-gray-700', 'ring-1', 'ring-inset', 'ring-gray-300');
        audioBtn.classList.add('bg-indigo-600', 'text-white');
      }
      if (videoBtn) {
        videoBtn.classList.remove('bg-indigo-600', 'text-white');
        videoBtn.classList.add('bg-white', 'text-gray-700', 'ring-1', 'ring-inset', 'ring-gray-300');
      }
    }
  }

  // Sharing functionality
  const shareMeetingId = '<%= meeting.id %>';
  const isOwner = <%= meeting.isOwner ? 'true' : 'false' %>;
  
  // Load shareable attendees and current shares on page load
  if (isOwner) {
    loadShareableAttendees();
    loadCurrentShares();
  }
  
  async function loadShareableAttendees() {
    const container = document.getElementById('attendees-to-share');
    if (!container) return;
    
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shareable-attendees`);
      const data = await response.json();
      
      if (!response.ok) {
        container.innerHTML = '<p class="text-xs text-red-500">Failed to load attendees</p>';
        return;
      }
      
      if (!data.attendees || data.attendees.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500">No attendees to share with</p>';
        return;
      }
      
      container.innerHTML = data.attendees.map(attendee => `
        <div class="flex items-center justify-between py-1">
          <div class="flex items-center">
            <div class="h-6 w-6 rounded-full bg-gray-200 flex items-center justify-center">
              <svg class="h-3 w-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <span class="ml-2 text-xs text-gray-700">${attendee.name || attendee.email}</span>
            ${attendee.isRegistered ? '<span class="ml-1 text-xs text-green-600"></span>' : ''}
          </div>
          ${attendee.isShared 
            ? '<span class="text-xs text-green-600">Shared</span>'
            : `<button 
                type="button" 
                onclick="shareWithAttendee('${attendee.email}')"
                class="text-xs text-indigo-600 hover:text-indigo-800"
              >Share</button>`
          }
        </div>
      `).join('');
    } catch (error) {
      console.error('Error loading attendees:', error);
      container.innerHTML = '<p class="text-xs text-red-500">Error loading attendees</p>';
    }
  }
  
  async function loadCurrentShares() {
    const container = document.getElementById('shares-list');
    if (!container) return;
    
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares`);
      const data = await response.json();
      
      if (!response.ok) {
        container.innerHTML = '<p class="text-xs text-red-500">Failed to load shares</p>';
        return;
      }
      
      const activeShares = (data.shares || []).filter(s => s.status !== 'revoked');
      
      if (activeShares.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500">Not shared with anyone yet</p>';
        return;
      }
      
      container.innerHTML = activeShares.map(share => {
        const shareLink = share.shareToken ? `${window.location.origin}/meetings/shared/${share.shareToken}` : null;
        return `
        <div class="py-2 border-b border-gray-100 last:border-0">
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center">
              <div class="h-6 w-6 rounded-full bg-indigo-100 flex items-center justify-center">
                <svg class="h-3 w-3 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
              <span class="ml-2 text-xs text-gray-700">
                ${share.sharedWithUser?.name || share.sharedWithUser?.email || share.sharedWithEmail || 'Unknown'}
              </span>
              <span class="ml-2 text-xs text-gray-400 capitalize">(${share.accessLevel})</span>
            </div>
            <button 
              type="button" 
              onclick="revokeShare('${share.id}')"
              class="text-xs text-red-600 hover:text-red-800"
            >Revoke</button>
          </div>
          ${shareLink ? `
          <div class="mt-2 flex items-center gap-2">
            <input 
              type="text" 
              value="${shareLink}" 
              readonly 
              id="share-link-${share.id}"
              class="flex-1 text-xs px-2 py-1 bg-gray-50 border border-gray-200 rounded text-gray-600 font-mono"
              onclick="this.select()"
            >
            <button 
              type="button"
              onclick="copyShareLink('${share.id}', '${shareLink}')"
              class="text-xs px-2 py-1 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100"
              title="Copy link"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>
          ` : `
          <div class="mt-2">
            <button 
              type="button"
              onclick="generateShareToken('${share.id}')"
              class="text-xs px-2 py-1 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100"
            >
              Generate Shareable Link
            </button>
          </div>
          `}
        </div>
      `;
      }).join('');
    } catch (error) {
      console.error('Error loading shares:', error);
      container.innerHTML = '<p class="text-xs text-red-500">Error loading shares</p>';
    }
  }
  
  async function shareMeeting() {
    const emailInput = document.getElementById('share-email');
    const email = emailInput?.value?.trim();
    
    if (!email) {
      showNotification('Please enter an email address', 'error');
      return;
    }
    
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, accessLevel: 'view' }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        showNotification(data.error || 'Failed to share meeting', 'error');
        return;
      }
      
      showNotification(`Meeting shared with ${email}`, 'success');
      emailInput.value = '';
      loadShareableAttendees();
      loadCurrentShares();
    } catch (error) {
      console.error('Error sharing meeting:', error);
      showNotification('Failed to share meeting', 'error');
    }
  }
  
  async function shareWithAttendee(email) {
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, accessLevel: 'view' }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        showNotification(data.error || 'Failed to share meeting', 'error');
        return;
      }
      
      showNotification(`Meeting shared with ${email}`, 'success');
      loadShareableAttendees();
      loadCurrentShares();
    } catch (error) {
      console.error('Error sharing meeting:', error);
      showNotification('Failed to share meeting', 'error');
    }
  }
  
  async function revokeShare(shareId) {
    if (!confirm('Are you sure you want to revoke this share?')) return;
    
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares/${shareId}`, {
        method: 'DELETE',
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        showNotification(data.error || 'Failed to revoke share', 'error');
        return;
      }
      
      showNotification('Share revoked', 'success');
      loadShareableAttendees();
      loadCurrentShares();
    } catch (error) {
      console.error('Error revoking share:', error);
      showNotification('Failed to revoke share', 'error');
    }
  }

  // ===== Notion Destination Picker =====
  let notionDestinations = [];
  let selectedDestinationId = null;
  let selectedDestinationType = null;
  let createNewPage = false;
  let customSubpageTitle = '';
  let publishArtifactId = null;

  async function openNotionDestinationPicker(artifactId) {
    publishArtifactId = artifactId;
    const modal = document.getElementById('notion-destination-modal');
    const listContainer = document.getElementById('notion-destinations-list');
    const loadingEl = document.getElementById('notion-destinations-loading');
    const errorEl = document.getElementById('notion-destinations-error');
    const searchInput = document.getElementById('notion-destination-search');
    
    // Reset state
    selectedDestinationId = null;
    selectedDestinationType = null;
    createNewPage = false;
    customSubpageTitle = '';
    searchInput.value = '';
    listContainer.innerHTML = '';
    loadingEl.classList.remove('hidden');
    errorEl.classList.add('hidden');
    document.getElementById('notion-publish-btn').disabled = true;
    updateCreateNewPageOption();
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Fetch destinations
    try {
      const response = await fetch('/api/notion/destinations');
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.message || data.error || 'Failed to load destinations');
      }
      
      notionDestinations = data.destinations || [];
      selectedDestinationId = data.defaultDestinationId;
      
      // Find the type of the default destination
      if (selectedDestinationId) {
        const defaultDest = notionDestinations.find(d => d.id === selectedDestinationId);
        selectedDestinationType = defaultDest?.type || 'page';
      }
      
      renderNotionDestinations(notionDestinations);
      updateCreateNewPageOption();
    } catch (error) {
      console.error('Error loading Notion destinations:', error);
      errorEl.textContent = error.message || 'Failed to load Notion destinations. Please check your Notion connection.';
      errorEl.classList.remove('hidden');
    } finally {
      loadingEl.classList.add('hidden');
    }
  }

  function closeNotionDestinationPicker() {
    document.getElementById('notion-destination-modal').classList.add('hidden');
  }

  function renderNotionDestinations(destinations) {
    const listContainer = document.getElementById('notion-destinations-list');
    
    if (destinations.length === 0) {
      listContainer.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <p>No Notion pages or databases found.</p>
          <p class="text-sm mt-2">Make sure you've shared pages with the Recall integration in Notion.</p>
        </div>
      `;
      return;
    }
    
    // Group by type
    const databases = destinations.filter(d => d.type === 'database');
    const pages = destinations.filter(d => d.type === 'page');
    
    let html = '';
    
    if (databases.length > 0) {
      html += `<div class="mb-4">
        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Databases (creates new page)</h4>
        <div class="space-y-1">
          ${databases.map(d => renderDestinationItem(d)).join('')}
        </div>
      </div>`;
    }
    
    if (pages.length > 0) {
      html += `<div>
        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Pages (appends content)</h4>
        <div class="space-y-1">
          ${pages.map(d => renderDestinationItem(d)).join('')}
        </div>
      </div>`;
    }
    
    listContainer.innerHTML = html;
    
    // Update button state
    document.getElementById('notion-publish-btn').disabled = !selectedDestinationId;
  }

  function renderDestinationItem(dest) {
    const isSelected = dest.id === selectedDestinationId;
    const icon = dest.icon || (dest.type === 'database' ? '' : '');
    
    return `
      <button
        type="button"
        onclick="selectNotionDestination('${dest.id}', '${dest.type}')"
        class="w-full flex items-center px-3 py-2 rounded-lg text-left transition-colors ${
          isSelected 
            ? 'bg-indigo-50 ring-2 ring-indigo-500 text-indigo-700' 
            : 'hover:bg-gray-50 text-gray-700'
        }"
      >
        <span class="text-lg mr-3">${icon.length <= 2 ? icon : ''}</span>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate">${escapeHtml(dest.title)}</p>
          <p class="text-xs text-gray-500">${dest.type === 'database' ? 'Database' : 'Page'}</p>
        </div>
        ${isSelected ? `
          <svg class="h-5 w-5 text-indigo-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
        ` : ''}
      </button>
    `;
  }

  function selectNotionDestination(id, type) {
    selectedDestinationId = id;
    selectedDestinationType = type;
    createNewPage = false; // Reset when changing destination
    renderNotionDestinations(notionDestinations);
    updateCreateNewPageOption();
  }

  function updateCreateNewPageOption() {
    const container = document.getElementById('create-new-page-option');
    const titleInput = document.getElementById('create-new-page-title');
    if (!container) return;
    
    // Only show "create new page" option for page destinations
    if (selectedDestinationType === 'page') {
      container.classList.remove('hidden');
      const checkbox = document.getElementById('create-new-page-checkbox');
      if (checkbox) checkbox.checked = createNewPage;
      if (titleInput && !titleInput.value) {
        titleInput.value = '<%= meeting.title.replace(/'/g, "\\'") %>';
        customSubpageTitle = titleInput.value;
      }
    } else {
      container.classList.add('hidden');
      createNewPage = false;
      customSubpageTitle = '';
      if (titleInput) titleInput.value = '';
    }
  }

  function toggleCreateNewPage() {
    createNewPage = document.getElementById('create-new-page-checkbox')?.checked || false;
    const titleInput = document.getElementById('create-new-page-title');
    if (createNewPage && titleInput && !titleInput.value) {
      titleInput.value = '<%= meeting.title.replace(/'/g, "\\'") %>';
      customSubpageTitle = titleInput.value;
    }
  }

  function filterNotionDestinations() {
    const query = document.getElementById('notion-destination-search').value.toLowerCase();
    const filtered = notionDestinations.filter(d => 
      d.title.toLowerCase().includes(query)
    );
    renderNotionDestinations(filtered);
  }

  async function publishToSelectedNotionDestination() {
    if (!selectedDestinationId || !publishArtifactId) return;
    
    const btn = document.getElementById('notion-publish-btn');
    const btnText = btn.querySelector('span');
    const originalText = btnText.textContent;
    
    btn.disabled = true;
    btnText.textContent = 'Publishing...';
    
    try {
      const selectedDest = notionDestinations.find(d => d.id === selectedDestinationId);
      const titleTemplate = (document.getElementById('create-new-page-title')?.value || '').trim();
      customSubpageTitle = titleTemplate;
      
      const response = await fetch(`/api/meetings/${publishArtifactId}/publish/notion`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          destinationId: selectedDestinationId,
          destinationType: selectedDest?.type || 'database',
          createNewPage: createNewPage,
          titleTemplate: titleTemplate || undefined,
        }),
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.message || result.error || 'Failed to publish');
      }
      
      closeNotionDestinationPicker();
      showNotification(result.message || 'Publishing to Notion...', 'success');
      
      // Reload after a delay to show updated status
      setTimeout(() => window.location.reload(), 3000);
    } catch (error) {
      console.error('Error publishing to Notion:', error);
      showNotification(error.message || 'Failed to publish to Notion', 'error');
      btn.disabled = false;
      btnText.textContent = originalText;
    }
  }

  // ===== Slack Destination Picker =====
  let slackChannels = [];
  let selectedSlackChannelId = null;
  let createSlackChannelName = '';
  let inviteAllSlack = false;

  async function openSlackDestinationPicker(artifactId) {
    publishArtifactId = artifactId;
    const modal = document.getElementById('slack-destination-modal');
    const listContainer = document.getElementById('slack-channels-list');
    const loadingEl = document.getElementById('slack-channels-loading');
    const errorEl = document.getElementById('slack-channels-error');
    const createNameInput = document.getElementById('slack-create-channel-name');
    const inviteAllCheckbox = document.getElementById('slack-invite-all-checkbox');
    selectedSlackChannelId = null;
    createSlackChannelName = '';
    inviteAllSlack = false;
    createNameInput.value = '';
    inviteAllCheckbox.checked = false;
    listContainer.innerHTML = '';
    loadingEl.classList.remove('hidden');
    errorEl.classList.add('hidden');
    document.getElementById('slack-publish-btn').disabled = true;
    modal.classList.remove('hidden');

    try {
      const resp = await fetch('/api/slack/channels');
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Failed to load Slack channels');
      slackChannels = data.channels || [];
      selectedSlackChannelId = slackChannels[0]?.id || null;
      renderSlackChannels(slackChannels);
      document.getElementById('slack-publish-btn').disabled = !(selectedSlackChannelId || createSlackChannelName);
    } catch (err) {
      console.error('Error loading Slack channels:', err);
      errorEl.textContent = err.message || 'Failed to load Slack channels. Please connect Slack in Settings.';
      errorEl.classList.remove('hidden');
    } finally {
      loadingEl.classList.add('hidden');
    }
  }

  function closeSlackDestinationPicker() {
    document.getElementById('slack-destination-modal').classList.add('hidden');
  }

  function renderSlackChannels(channels) {
    const listContainer = document.getElementById('slack-channels-list');
    if (!channels.length) {
      listContainer.innerHTML = '<p class="text-xs text-gray-500">No channels found. Create one below.</p>';
      return;
    }
    listContainer.innerHTML = channels.map(ch => `
      <button
        type="button"
        onclick="selectSlackChannel('${ch.id}', '${ch.name}')"
        class="w-full flex items-center px-3 py-2 rounded-lg text-left transition-colors ${selectedSlackChannelId === ch.id ? 'bg-sky-50 ring-2 ring-sky-500 text-sky-700' : 'hover:bg-gray-50 text-gray-700'}"
      >
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate">#${ch.name}</p>
          <p class="text-xs text-gray-500">${ch.isPrivate ? 'Private' : 'Public'}</p>
        </div>
        ${selectedSlackChannelId === ch.id ? `<svg class="h-5 w-5 text-sky-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>` : ''}
      </button>
    `).join('');
  }

  function selectSlackChannel(id, name) {
    selectedSlackChannelId = id;
    createSlackChannelName = '';
    document.getElementById('slack-create-channel-name').value = '';
    document.getElementById('slack-publish-btn').disabled = false;
    renderSlackChannels(slackChannels);
  }

  function onSlackCreateNameInput(val) {
    createSlackChannelName = val.trim();
    if (createSlackChannelName) {
      selectedSlackChannelId = null;
    }
    document.getElementById('slack-publish-btn').disabled = !(selectedSlackChannelId || createSlackChannelName);
    renderSlackChannels(slackChannels);
  }

  async function publishToSlackSelected() {
    if (!publishArtifactId) return;
    const btn = document.getElementById('slack-publish-btn');
    const btnText = btn.querySelector('span');
    const originalText = btnText.textContent;
    btn.disabled = true;
    btnText.textContent = 'Publishing...';
    const payload = {
      channelId: selectedSlackChannelId,
      channelName: slackChannels.find(c => c.id === selectedSlackChannelId)?.name || null,
      createChannelName: createSlackChannelName || undefined,
      inviteAll: document.getElementById('slack-invite-all-checkbox').checked,
    };
    try {
      const resp = await fetch(`/api/meetings/${publishArtifactId}/publish/slack`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Failed to publish to Slack');
      closeSlackDestinationPicker();
      showNotification('Publishing to Slack...', 'info');
      setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
      console.error('Slack publish error:', err);
      showNotification(err.message || 'Failed to publish to Slack', 'error');
      btn.disabled = false;
      btnText.textContent = originalText;
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function copyShareLink(shareId, link) {
    navigator.clipboard.writeText(link).then(() => {
      showNotification('Share link copied to clipboard!', 'success');
      const btn = document.querySelector(`#share-link-${shareId}`).nextElementSibling;
      if (btn) {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
        }, 2000);
      }
    }).catch(err => {
      console.error('Failed to copy:', err);
      showNotification('Failed to copy link', 'error');
    });
  }

  async function generateShareToken(shareId) {
    try {
      const response = await fetch(`/api/meetings/${shareMeetingId}/shares/${shareId}/generate-token`, {
        method: 'POST',
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to generate token');
      }
      
      showNotification('Shareable link generated!', 'success');
      loadCurrentShares(); // Reload to show the new link
    } catch (error) {
      console.error('Error generating share token:', error);
      showNotification(error.message || 'Failed to generate shareable link', 'error');
    }
  }
</script>

<!-- Slack Destination Picker Modal -->
<div id="slack-destination-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeSlackDestinationPicker()"></div>
    <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
      <div class="absolute top-0 right-0 pt-4 pr-4">
        <button type="button" onclick="closeSlackDestinationPicker()" class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
          <span class="sr-only">Close</span>
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="sm:flex sm:items-start">
        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-sky-100 sm:mx-0 sm:h-10 sm:w-10">
          <svg class="h-6 w-6 text-sky-600" viewBox="0 0 24 24" fill="currentColor">
            <path d="M5.1 15.9c0 1.05-.86 1.9-1.9 1.9S1.3 16.95 1.3 15.9s.86-1.9 1.9-1.9h1.9v1.9zm.95 0c0-1.05.86-1.9 1.9-1.9s1.9.85 1.9 1.9v4.75c0 1.05-.86 1.9-1.9 1.9s-1.9-.85-1.9-1.9V15.9zm1.9-10.85c-1.05 0-1.9-.86-1.9-1.9S6 1.25 7.05 1.25 8.95 2.1 8.95 3.15v1.9H7.05zm0 .95c1.05 0 1.9.86 1.9 1.9s-.86 1.9-1.9 1.9H2.3c-1.05 0-1.9-.86-1.9-1.9S1.25 6 2.3 6h4.75zM18.9 8.05c0-1.05.86-1.9 1.9-1.9s1.9.86 1.9 1.9-.86 1.9-1.9 1.9h-1.9v-1.9zm-.95 0c0 1.05-.86 1.9-1.9 1.9s-1.9-.86-1.9-1.9V3.3c0-1.05.86-1.9 1.9-1.9s1.9.86 1.9 1.9v4.75zm-1.9 10.85c1.05 0 1.9.86 1.9 1.9s-.86 1.9-1.9 1.9-1.9-.86-1.9-1.9v-1.9h1.9zm0-.95c-1.05 0-1.9-.86-1.9-1.9s.86-1.9 1.9-1.9h4.75c1.05 0 1.9.86 1.9 1.9s-.86 1.9-1.9 1.9H16.05z"/>
          </svg>
        </div>
        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
          <h3 class="text-lg leading-6 font-medium text-gray-900">Publish to Slack</h3>
          <p class="mt-1 text-sm text-gray-500">Choose a channel or create a new one to post this meeting.</p>
        </div>
      </div>

      <div class="mt-4">
        <div id="slack-channels-loading" class="mt-4 text-center py-6">
          <svg class="animate-spin h-8 w-8 text-sky-600 mx-auto" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="mt-2 text-sm text-gray-500">Loading Slack channels...</p>
        </div>
        <div id="slack-channels-error" class="hidden mt-2 p-3 bg-red-50 rounded-md text-sm text-red-700"></div>
        <div id="slack-channels-list" class="mt-2 max-h-56 overflow-y-auto space-y-1"></div>

        <div class="mt-4 space-y-2">
          <label class="block text-xs font-medium text-gray-700">Or create a new channel</label>
          <input
            type="text"
            id="slack-create-channel-name"
            placeholder="e.g., meeting-recaps"
            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm"
            oninput="onSlackCreateNameInput(this.value)"
          />
          <div class="flex items-center space-x-2 mt-2">
            <input
              type="checkbox"
              id="slack-invite-all-checkbox"
              class="h-4 w-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500"
            />
            <label for="slack-invite-all-checkbox" class="text-xs text-gray-700">Invite all users</label>
          </div>
        </div>
      </div>

      <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse gap-3">
        <button
          type="button"
          id="slack-publish-btn"
          onclick="publishToSlackSelected()"
          disabled
          class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-sky-600 text-base font-medium text-white hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span>Publish to Selected</span>
        </button>
        <button
          type="button"
          onclick="closeSlackDestinationPicker()"
          class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 sm:mt-0 sm:w-auto sm:text-sm"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Notion Destination Picker Modal -->
<div id="notion-destination-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeNotionDestinationPicker()"></div>

    <!-- Modal panel -->
    <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
      <div class="absolute top-0 right-0 pt-4 pr-4">
        <button type="button" onclick="closeNotionDestinationPicker()" class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
          <span class="sr-only">Close</span>
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="sm:flex sm:items-start">
        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
          <svg class="h-6 w-6 text-indigo-600" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 2.02c-.42-.326-.98-.7-2.055-.607L3.01 2.72c-.466.046-.56.28-.374.466l1.823 1.022zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.166V6.354c0-.606-.233-.933-.748-.886l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.22.186c-.094-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.14c-.093-.514.28-.886.747-.933l3.222-.186zM2.877 1.16l13.681-.933c1.682-.14 2.101.093 2.801.606l3.876 2.754c.466.326.606.7.606 1.213v15.06c0 .933-.373 1.493-1.682 1.586l-15.457.933c-.98.047-1.448-.093-1.962-.7l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.682-1.633l.377.126z"/>
          </svg>
        </div>
        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
            Publish to Notion
          </h3>
          <p class="mt-1 text-sm text-gray-500">
            Select a Notion page or database to publish this meeting's notes.
          </p>
        </div>
      </div>
      
      <!-- Search -->
      <div class="mt-4">
        <input
          type="text"
          id="notion-destination-search"
          placeholder="Search pages and databases..."
          oninput="filterNotionDestinations()"
          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
        />
      </div>
      
      <!-- Loading state -->
      <div id="notion-destinations-loading" class="mt-4 text-center py-8">
        <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2 text-sm text-gray-500">Loading Notion destinations...</p>
      </div>
      
      <!-- Error state -->
      <div id="notion-destinations-error" class="hidden mt-4 p-4 bg-red-50 rounded-md">
        <p class="text-sm text-red-700"></p>
      </div>
      
      <!-- Destinations list -->
      <div id="notion-destinations-list" class="mt-4 max-h-64 overflow-y-auto">
        <!-- Populated by JavaScript -->
      </div>
      
      <!-- Create new page option (only shown for page destinations) -->
      <div id="create-new-page-option" class="hidden mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
        <label class="flex items-center cursor-pointer">
          <input
            type="checkbox"
            id="create-new-page-checkbox"
            onchange="toggleCreateNewPage()"
            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
          />
          <div class="ml-3">
            <span class="text-sm font-medium text-gray-900">Create new subpage</span>
            <p class="text-xs text-gray-500">Creates a new page under the selected page instead of appending content</p>
          </div>
        </label>
        <div class="mt-3">
          <label for="create-new-page-title" class="block text-xs font-medium text-gray-700 mb-1">
            Subpage title (optional)
          </label>
          <input
            type="text"
            id="create-new-page-title"
            placeholder="Defaults to meeting title"
            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
            oninput="customSubpageTitle = this.value"
          />
        </div>
      </div>
      
      <!-- Actions -->
      <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse gap-3">
        <button
          type="button"
          id="notion-publish-btn"
          onclick="publishToSelectedNotionDestination()"
          disabled
          class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span>Publish to Selected</span>
        </button>
        <button
          type="button"
          onclick="closeNotionDestinationPicker()"
          class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') -%>
