<div class="space-y-8">
  <!-- Notion Integration -->
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
    <div class="px-6 py-5 border-b border-gray-100">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center">
            <svg class="h-6 w-6 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
              <path d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.98-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.167V6.354c0-.606-.233-.933-.748-.886l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952l1.448.327s0 .84-1.168.84l-3.22.186c-.094-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.14c-.093-.514.28-.886.747-.933zM1.936 1.035l13.31-.98c1.634-.14 2.055-.047 3.082.7l4.249 2.986c.7.513.934.653.934 1.213v16.378c0 1.026-.373 1.634-1.68 1.726l-15.458.934c-.98.047-1.448-.093-1.962-.747l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.447-1.632z"/>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Notion</h3>
            <p class="text-sm text-gray-500">Automatically publish meeting notes to Notion</p>
          </div>
        </div>
        <% if (notion?.integration) { %>
          <span class="inline-flex items-center rounded-full bg-green-50 px-3 py-1 text-sm font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
            <svg class="mr-1.5 h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            Connected
          </span>
        <% } else { %>
          <a
            href="<%= connectUrls?.notion || '#' %>"
            class="inline-flex items-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 transition-colors"
          >
            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
            </svg>
            Connect Notion
          </a>
        <% } %>
      </div>
    </div>
    
    <% if (notion?.integration) { %>
      <div class="px-6 py-5">
        <form method="POST" action="/integrations/notion-target" class="space-y-5" id="notionTargetForm">
          <!-- Destination Selection -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Publishing Destination</label>
            <div id="currentSelection" class="<%= notion.target ? '' : 'hidden' %>">
              <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center gap-3">
                  <span id="selectedIcon" class="text-2xl"><%= notion.targetDetails?.icon || 'ðŸ“„' %></span>
                  <div>
                    <p id="selectedTitle" class="text-sm font-semibold text-gray-900"><%= notion.targetDetails?.title || 'Select a destination' %></p>
                    <p id="selectedType" class="text-xs text-gray-500 capitalize"><%= notion.target?.config?.destinationType || 'database' %></p>
                  </div>
                </div>
                <button type="button" id="changeDestinationBtn" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                  Change
                </button>
              </div>
            </div>
            
            <!-- Destination Picker -->
            <div id="destinationPicker" class="<%= notion.target ? 'hidden' : '' %>">
              <div class="relative">
                <input
                  type="text"
                  id="notionSearch"
                  placeholder="Search your Notion pages and databases..."
                  class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"
                  autocomplete="off"
                />
                <div id="notionSearchResults" class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg rounded-lg border border-gray-200 max-h-60 overflow-auto">
                  <div id="notionResultsList" class="py-1"></div>
                  <div id="notionLoading" class="hidden p-4 text-center text-sm text-gray-500">
                    <svg class="animate-spin h-5 w-5 mx-auto text-indigo-600" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="mt-2 block">Loading...</span>
                  </div>
                  <div id="notionEmpty" class="hidden p-4 text-center text-sm text-gray-500">
                    No pages or databases found. Make sure you've shared them with the integration.
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Hidden inputs -->
          <input type="hidden" name="destinationId" id="destinationId" value="<%= notion.target ? notion.target.config.destinationId : '' %>" required />
          <input type="hidden" name="destinationType" id="destinationType" value="<%= notion.target ? notion.target.config.destinationType : 'database' %>" />
          
          <!-- Enable toggle -->
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div>
              <p class="text-sm font-medium text-gray-900">Auto-publish meeting notes</p>
              <p class="text-xs text-gray-500">Automatically send meeting summaries to Notion after each meeting</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input id="enabled" name="enabled" type="checkbox" <%= notion.target && notion.target.enabled ? "checked" : "" %> class="sr-only peer" />
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
            </label>
          </div>
          
          <button
            type="submit"
            id="saveNotionBtn"
            class="inline-flex items-center rounded-lg bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            <%= notion.target ? '' : 'disabled' %>
          >
            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Save Settings
          </button>
        </form>
        
        <script>
        (function() {
          const searchInput = document.getElementById('notionSearch');
          const resultsContainer = document.getElementById('notionSearchResults');
          const resultsList = document.getElementById('notionResultsList');
          const loadingEl = document.getElementById('notionLoading');
          const emptyEl = document.getElementById('notionEmpty');
          const currentSelection = document.getElementById('currentSelection');
          const destinationPicker = document.getElementById('destinationPicker');
          const changeBtn = document.getElementById('changeDestinationBtn');
          const destinationIdInput = document.getElementById('destinationId');
          const destinationTypeInput = document.getElementById('destinationType');
          const selectedIcon = document.getElementById('selectedIcon');
          const selectedTitle = document.getElementById('selectedTitle');
          const selectedType = document.getElementById('selectedType');
          const saveBtn = document.getElementById('saveNotionBtn');
          
          let searchTimeout;
          let cachedResults = null;
          
          changeBtn?.addEventListener('click', () => {
            currentSelection.classList.add('hidden');
            destinationPicker.classList.remove('hidden');
            searchInput.focus();
            if (!cachedResults) fetchPages('');
            else showResults(cachedResults);
          });
          
          searchInput?.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => fetchPages(e.target.value), 300);
          });
          
          searchInput?.addEventListener('focus', () => {
            if (!cachedResults) fetchPages('');
            else resultsContainer.classList.remove('hidden');
          });
          
          document.addEventListener('click', (e) => {
            if (!destinationPicker?.contains(e.target)) {
              resultsContainer?.classList.add('hidden');
            }
          });
          
          async function fetchPages(query) {
            loadingEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');
            resultsList.innerHTML = '';
            resultsContainer.classList.remove('hidden');
            
            try {
              const res = await fetch(`/api/notion/pages?q=${encodeURIComponent(query)}`);
              const data = await res.json();
              if (data.error) throw new Error(data.error);
              cachedResults = data.results;
              showResults(data.results);
            } catch (err) {
              loadingEl.classList.add('hidden');
              emptyEl.textContent = 'Failed to load: ' + err.message;
              emptyEl.classList.remove('hidden');
            }
          }
          
          function showResults(results) {
            loadingEl.classList.add('hidden');
            resultsList.innerHTML = '';
            if (!results || results.length === 0) {
              emptyEl.classList.remove('hidden');
              return;
            }
            emptyEl.classList.add('hidden');
            
            const databases = results.filter(r => r.type === 'database');
            const pages = results.filter(r => r.type === 'page');
            
            if (databases.length > 0) {
              resultsList.innerHTML += '<div class="px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-50">Databases</div>';
              databases.forEach(item => resultsList.innerHTML += createResultItem(item));
            }
            if (pages.length > 0) {
              resultsList.innerHTML += '<div class="px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-50">Pages</div>';
              pages.forEach(item => resultsList.innerHTML += createResultItem(item));
            }
            
            resultsList.querySelectorAll('[data-notion-item]').forEach(el => {
              el.addEventListener('click', () => selectItem(el.dataset));
            });
          }
          
          function createResultItem(item) {
            const icon = item.icon?.length > 2 ? 'ðŸ“„' : (item.icon || 'ðŸ“„');
            return `
              <div data-notion-item data-id="${item.id}" data-type="${item.type}" data-title="${item.title.replace(/"/g, '&quot;')}" data-icon="${icon}"
                class="px-4 py-3 hover:bg-indigo-50 cursor-pointer flex items-center gap-3">
                <span class="text-xl">${icon}</span>
                <span class="text-sm text-gray-900 truncate">${item.title}</span>
              </div>`;
          }
          
          function selectItem(data) {
            destinationIdInput.value = data.id;
            destinationTypeInput.value = data.type;
            selectedIcon.textContent = data.icon;
            selectedTitle.textContent = data.title;
            selectedType.textContent = data.type;
            resultsContainer.classList.add('hidden');
            destinationPicker.classList.add('hidden');
            currentSelection.classList.remove('hidden');
            saveBtn.disabled = false;
          }
        })();
        </script>
      </div>
    <% } else { %>
      <div class="px-6 py-8 text-center">
        <p class="text-sm text-gray-500">Connect Notion to automatically publish meeting notes to your workspace.</p>
      </div>
    <% } %>
  </div>

  <!-- Ask My Meetings (AI Search) -->
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
    <div class="px-6 py-5 border-b border-gray-100">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-lg bg-purple-100 flex items-center justify-center">
          <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Ask My Meetings</h3>
          <p class="text-sm text-gray-500">Use AI to search across all your meeting transcripts</p>
        </div>
      </div>
    </div>
    <div class="px-6 py-5">
      <form method="POST" action="/api/chat/meetings" class="space-y-4" id="askMeetingsForm">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2" for="query">Your Question</label>
          <textarea
            id="query"
            name="query"
            rows="3"
            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"
            placeholder="e.g., What were the action items from last week's calls? What did we discuss about the Q2 roadmap?"
          ></textarea>
        </div>
        <button
          type="submit"
          class="inline-flex items-center rounded-lg bg-purple-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 transition-colors"
        >
          <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          Search Meetings
        </button>
      </form>
      <div id="askMeetingsResult" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
        <div id="askMeetingsLoading" class="hidden flex items-center gap-2 text-sm text-gray-600">
          <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          Searching...
        </div>
        <div id="askMeetingsAnswer" class="text-sm text-gray-700 whitespace-pre-wrap"></div>
      </div>
    </div>
  </div>

  <!-- Calendar Connections -->
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
    <div class="px-6 py-5 border-b border-gray-100">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center">
          <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Calendar Connections</h3>
          <p class="text-sm text-gray-500">Connect your calendars to automatically record meetings</p>
        </div>
      </div>
    </div>
    <div class="px-6 py-5 space-y-4">
      <!-- Google Calendar -->
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
        <div class="flex items-center gap-3">
          <img class="h-6 w-6" src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Google_Calendar_icon_%282020%29.svg/2048px-Google_Calendar_icon_%282020%29.svg.png" alt="Google Calendar" />
          <div>
            <p class="text-sm font-medium text-gray-900">Google Calendar</p>
            <% const googleCal = calendars?.find(c => c.platform === 'google_calendar'); %>
            <% if (googleCal) { %>
              <p class="text-xs text-gray-500"><%= googleCal.email %></p>
            <% } %>
          </div>
        </div>
        <% if (googleCal && googleCal.status === 'connected') { %>
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-1 text-xs font-medium text-green-700">Connected</span>
            <a href="<%= connectUrls?.googleCalendar %>" class="text-xs text-indigo-600 hover:text-indigo-500">Reconnect</a>
          </div>
        <% } else { %>
          <a href="<%= connectUrls?.googleCalendar %>" class="inline-flex items-center rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-indigo-500">
            Connect
          </a>
        <% } %>
      </div>
      
      <!-- Microsoft Outlook -->
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
        <div class="flex items-center gap-3">
          <img class="h-6 w-6" src="https://img.icons8.com/color/480/outlook-calendar.png" alt="Microsoft Outlook" />
          <div>
            <p class="text-sm font-medium text-gray-900">Microsoft Outlook</p>
            <% const outlookCal = calendars?.find(c => c.platform === 'microsoft_outlook'); %>
            <% if (outlookCal) { %>
              <p class="text-xs text-gray-500"><%= outlookCal.email %></p>
            <% } %>
          </div>
        </div>
        <% if (outlookCal && outlookCal.status === 'connected') { %>
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-1 text-xs font-medium text-green-700">Connected</span>
            <a href="<%= connectUrls?.microsoftOutlook %>" class="text-xs text-indigo-600 hover:text-indigo-500">Reconnect</a>
          </div>
        <% } else { %>
          <a href="<%= connectUrls?.microsoftOutlook %>" class="inline-flex items-center rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-indigo-500">
            Connect
          </a>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('askMeetingsForm')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  const query = document.getElementById('query').value.trim();
  if (!query) return;
  
  const resultArea = document.getElementById('askMeetingsResult');
  const loading = document.getElementById('askMeetingsLoading');
  const answer = document.getElementById('askMeetingsAnswer');
  
  resultArea.classList.remove('hidden');
  loading.classList.remove('hidden');
  answer.textContent = '';
  
  try {
    const res = await fetch('/api/chat/meetings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    const data = await res.json();
    loading.classList.add('hidden');
    answer.textContent = data.answer || data.response || data.error || 'No results found.';
  } catch (err) {
    loading.classList.add('hidden');
    answer.textContent = 'An error occurred. Please try again.';
  }
});
</script>
