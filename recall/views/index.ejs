<%- include('partials/header') -%>
<div class="min-h-full bg-gradient-to-br from-slate-50 via-white to-indigo-50">
  <%- include('partials/navigation') -%>
  <%- include('partials/notice', { notice: notice }) -%>
  
  <div class="py-10">
    <main>
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        
        <!-- Personalized Greeting Section -->
        <div class="mb-8">
          <%
            const hour = new Date().getHours();
            let greeting = 'Good Morning';
            if (hour >= 12 && hour < 17) greeting = 'Good Afternoon';
            else if (hour >= 17) greeting = 'Good Evening';
            
            const firstName = user.name ? user.name.split(' ')[0] : user.email.split('@')[0];
          %>
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">
            <%= greeting %>, <span class="text-indigo-600"><%= firstName %></span>!
          </h1>
          <p class="mt-2 text-lg text-gray-600">Welcome back to your meeting assistant.</p>
        </div>

        <!-- AI Assistant Section -->
        <div class="mb-8 bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 rounded-2xl shadow-xl overflow-hidden">
          <div class="px-6 py-8 sm:px-10 sm:py-10">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
              <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                  <div class="h-14 w-14 rounded-full bg-white/20 flex items-center justify-center">
                    <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                  </div>
                </div>
                <div>
                  <h2 class="text-2xl font-bold text-white">How can I help you today?</h2>
                  <p class="mt-2 text-indigo-100 max-w-xl">Ask me anything about your meetings - find action items, search transcripts, or get summaries from past conversations.</p>
                </div>
              </div>
              <div class="flex-shrink-0 w-full lg:w-auto">
                <form id="ai-assistant-form" class="flex flex-col sm:flex-row gap-3">
                  <input
                    type="text"
                    id="ai-query"
                    name="query"
                    placeholder="e.g., What were the action items from last week?"
                    class="flex-1 min-w-0 lg:min-w-[320px] rounded-lg border-0 px-4 py-3 text-gray-900 shadow-sm ring-1 ring-inset ring-white/20 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-white sm:text-sm"
                  />
                  <button
                    type="submit"
                    class="inline-flex items-center justify-center rounded-lg bg-white px-6 py-3 text-sm font-semibold text-indigo-600 shadow-sm hover:bg-indigo-50 transition-colors"
                  >
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Ask AI
                  </button>
                </form>
              </div>
            </div>
            
            <!-- AI Response Area (hidden by default) -->
            <div id="ai-response" class="hidden mt-6 p-4 bg-white/10 rounded-lg backdrop-blur-sm">
              <div id="ai-loading" class="hidden flex items-center gap-3 text-white">
                <div class="h-5 w-5 animate-spin rounded-full border-2 border-white border-t-transparent"></div>
                <span>Searching your meetings...</span>
              </div>
              <div id="ai-result" class="text-white"></div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
          <!-- Upcoming Meetings Section -->
          <div class="lg:col-span-2">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="px-6 py-5 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-lg bg-indigo-100 flex items-center justify-center">
                    <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <div>
                    <h2 class="text-lg font-semibold text-gray-900">Upcoming Meetings</h2>
                    <p class="text-sm text-gray-500">Next 5 shown, scroll for more</p>
                  </div>
                </div>
                <a href="/meetings" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                  View all →
                </a>
              </div>
              <div class="divide-y divide-gray-100 max-h-[340px] overflow-y-auto" id="upcoming-meetings-list">
                <% if (upcomingMeetings && upcomingMeetings.length > 0) { %>
                  <% upcomingMeetings.slice(0, 20).forEach(function(event) { 
                    const startTime = new Date(event.recallData?.start_time);
                    const endTime = new Date(event.recallData?.end_time);
                    const title = event.title || 'Untitled Meeting';
                    const isToday = startTime.toDateString() === new Date().toDateString();
                    const isTomorrow = startTime.toDateString() === new Date(Date.now() + 86400000).toDateString();
                    const willRecord = event.shouldRecordAutomatic || event.shouldRecordManual;
                    const attendees = event.attendees || [];
                    const nonOrganizerAttendees = attendees.filter(a => !a.organizer);
                  %>
                    <a href="/meetings" class="block px-6 py-4 hover:bg-gray-50 transition-colors cursor-pointer">
                      <div class="flex items-start justify-between gap-4">
                        <div class="flex items-start gap-4 min-w-0">
                          <div class="flex-shrink-0 text-center">
                            <% if (isToday) { %>
                              <div class="text-xs font-semibold text-indigo-600 uppercase">Today</div>
                            <% } else if (isTomorrow) { %>
                              <div class="text-xs font-semibold text-amber-600 uppercase">Tomorrow</div>
                            <% } else { %>
                              <div class="text-xs font-medium text-gray-500 uppercase"><%= startTime.toLocaleDateString('en-US', { weekday: 'short' }) %></div>
                            <% } %>
                            <div class="text-lg font-bold text-gray-900"><%= startTime.getDate() %></div>
                            <div class="text-xs text-gray-500"><%= startTime.toLocaleDateString('en-US', { month: 'short' }) %></div>
                          </div>
                          <div class="min-w-0 flex-1">
                            <h3 class="text-sm font-semibold text-gray-900 truncate"><%= title %></h3>
                            <p class="mt-1 text-sm text-gray-500">
                              <%= startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) %> - 
                              <%= endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) %>
                            </p>
                            <% if (nonOrganizerAttendees.length > 0) { %>
                              <p class="mt-1 text-xs text-gray-500 truncate">
                                <span class="text-gray-400">With:</span>
                                <%= nonOrganizerAttendees.slice(0, 3).map(a => a.name).join(', ') %><% if (nonOrganizerAttendees.length > 3) { %> +<%= nonOrganizerAttendees.length - 3 %> more<% } %>
                              </p>
                            <% } %>
                            <% if (event.recallData?.meeting_url) { %>
                              <p class="mt-1 text-xs text-gray-400 truncate">
                                <% 
                                  const meetingUrl = event.recallData.meeting_url;
                                  let platform = 'Video call';
                                  if (meetingUrl.includes('zoom')) platform = 'Zoom';
                                  else if (meetingUrl.includes('meet.google')) platform = 'Google Meet';
                                  else if (meetingUrl.includes('teams')) platform = 'Microsoft Teams';
                                %>
                                <%= platform %>
                              </p>
                            <% } %>
                          </div>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-2">
                          <% if (willRecord) { %>
                            <span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                              <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <circle cx="10" cy="10" r="3"></circle>
                              </svg>
                              Set to record
                            </span>
                          <% } else { %>
                            <span class="inline-flex items-center rounded-full bg-gray-50 px-2.5 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10">
                              Not recording
                            </span>
                          <% } %>
                        </div>
                      </div>
                    </a>
                  <% }); %>
                <% } else { %>
                  <div class="px-6 py-12 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <h3 class="mt-3 text-sm font-semibold text-gray-900">No upcoming meetings</h3>
                    <p class="mt-1 text-sm text-gray-500">
                      <% if (calendars.length === 0) { %>
                        Connect your calendar to see upcoming meetings.
                      <% } else { %>
                        You have no upcoming meetings.
                      <% } %>
                    </p>
                    <% if (calendars.length === 0) { %>
                      <div class="mt-4 flex justify-center gap-3">
                        <a href="<%= connectUrls.googleCalendar %>" class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                          Connect Google
                        </a>
                        <a href="<%= connectUrls.microsoftOutlook %>" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                          Connect Outlook
                        </a>
                      </div>
                    <% } %>
                  </div>
                <% } %>
              </div>
            </div>

            <!-- Past Meetings Section -->
            <div class="mt-6 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="px-6 py-5 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-lg bg-amber-100 flex items-center justify-center">
                    <svg class="h-5 w-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <div>
                    <h2 class="text-lg font-semibold text-gray-900">Past Meetings</h2>
                    <p class="text-sm text-gray-500">Last 5</p>
                  </div>
                </div>
                <a href="/meetings#past" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                  View all →
                </a>
              </div>
              <div class="divide-y divide-gray-100">
                <% if (pastMeetings && pastMeetings.length > 0) { %>
                  <% pastMeetings.forEach(function(meeting) {
                    const startDate = new Date(meeting.startTime);
                  %>
                    <a href="/meetings/<%= meeting.id %>" class="block px-6 py-4 hover:bg-gray-50 transition-colors">
                      <div class="flex items-start justify-between gap-4">
                        <div class="flex items-start gap-4 min-w-0">
                          <div class="flex-shrink-0 text-center">
                            <div class="text-xs font-medium text-gray-500 uppercase"><%= startDate.toLocaleDateString('en-US', { weekday: 'short' }) %></div>
                            <div class="text-lg font-bold text-gray-900"><%= startDate.getDate() %></div>
                            <div class="text-xs text-gray-500"><%= startDate.toLocaleDateString('en-US', { month: 'short' }) %></div>
                          </div>
                          <div class="min-w-0 flex-1">
                            <h3 class="text-sm font-semibold text-gray-900 truncate"><%= meeting.title %></h3>
                            <% if (meeting.attendees && meeting.attendees.length > 0) { %>
                              <div class="mt-1 flex flex-wrap items-center gap-1">
                                <span class="text-xs text-gray-400 flex items-center gap-1">
                                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                  <span>Attendees:</span>
                                </span>
                                <% meeting.attendees.slice(0, 4).forEach(function(att) { %>
                                  <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-700" title="<%= att.email || '' %>">
                                    <%= att.name || att.email || 'Guest' %>
                                    <% if (att.organizer) { %>
                                      <svg class="ml-1 w-3 h-3 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                    <% } %>
                                  </span>
                                <% }); %>
                                <% if (meeting.attendees.length > 4) { %>
                                  <span class="text-xs text-gray-400">+<%= meeting.attendees.length - 4 %> more</span>
                                <% } %>
                              </div>
                            <% } %>
                            <p class="mt-1 text-sm text-gray-500">
                              <%= startDate.toLocaleDateString('en-US', { hour: 'numeric', minute: '2-digit' }) %>
                              <% if (meeting.durationSeconds) { %>
                                · <%= Math.round(meeting.durationSeconds / 60) %> min
                              <% } %>
                            </p>
                          </div>
                        </div>
                        <div class="flex-shrink-0 flex items-center">
                          <% if (meeting.hasRecording) { %>
                            <span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">Recording</span>
                          <% } else { %>
                            <span class="text-gray-400">
                              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </span>
                          <% } %>
                        </div>
                      </div>
                    </a>
                  <% }); %>
                <% } else { %>
                  <div class="px-6 py-8 text-center">
                    <p class="text-sm text-gray-500">No past meetings yet.</p>
                    <a href="/meetings#past" class="mt-2 inline-flex text-sm font-medium text-indigo-600 hover:text-indigo-500">View meetings →</a>
                  </div>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Quick Links & Status Section -->
          <div class="space-y-6">
            <!-- Recent Recordings -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="px-6 py-5 border-b border-gray-100">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-lg bg-green-100 flex items-center justify-center">
                    <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <h2 class="text-lg font-semibold text-gray-900">Quick Links</h2>
                </div>
              </div>
              <div class="p-4 space-y-2">
                <a href="/meetings" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                  </svg>
                  <span class="text-sm font-medium text-gray-700">View All Recordings</span>
                </a>
                <a href="/settings" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  <span class="text-sm font-medium text-gray-700">Settings & Integrations</span>
                </a>
                <a href="/publishing-targets" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors">
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                  </svg>
                  <span class="text-sm font-medium text-gray-700">Publishing Targets</span>
                </a>
              </div>
            </div>

            <!-- Calendar Status -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
              <div class="px-6 py-5 border-b border-gray-100">
                <div class="flex items-center gap-3">
                  <div class="h-10 w-10 rounded-lg bg-purple-100 flex items-center justify-center">
                    <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h2 class="text-lg font-semibold text-gray-900">Calendar Status</h2>
                </div>
              </div>
              <div class="p-4 space-y-3">
                <% if (calendars.length > 0) { %>
                  <% calendars.forEach(function(calendar) { %>
                    <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-gray-50">
                      <div class="flex items-center gap-2 min-w-0">
                        <% if (calendar.platform === 'google_calendar') { %>
                          <img class="h-4 w-4" src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Google_Calendar_icon_%282020%29.svg/2048px-Google_Calendar_icon_%282020%29.svg.png" alt="Google" />
                        <% } else { %>
                          <img class="h-4 w-4" src="https://img.icons8.com/color/480/outlook-calendar.png" alt="Outlook" />
                        <% } %>
                        <span class="text-sm text-gray-700 truncate"><%= calendar.email %></span>
                      </div>
                      <% const status = calendar.status || calendar.recallData?.status || 'unknown'; %>
                      <% if (status === 'connected') { %>
                        <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-0.5 text-xs font-medium text-green-700">Connected</span>
                      <% } else if (status === 'connecting') { %>
                        <span class="inline-flex items-center rounded-full bg-yellow-50 px-2 py-0.5 text-xs font-medium text-yellow-700">Connecting...</span>
                      <% } else { %>
                        <span class="inline-flex items-center rounded-full bg-red-50 px-2 py-0.5 text-xs font-medium text-red-700">Disconnected</span>
                      <% } %>
                    </div>
                  <% }); %>
                <% } else { %>
                  <div class="text-center py-4">
                    <p class="text-sm text-gray-500">No calendars connected</p>
                    <a href="<%= connectUrls.googleCalendar %>" class="mt-2 inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500">
                      Connect a calendar →
                    </a>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>
</div>

<script>
document.getElementById('ai-assistant-form')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  const query = document.getElementById('ai-query').value.trim();
  if (!query) return;
  
  const responseArea = document.getElementById('ai-response');
  const loading = document.getElementById('ai-loading');
  const result = document.getElementById('ai-result');
  
  responseArea.classList.remove('hidden');
  loading.classList.remove('hidden');
  result.innerHTML = '';
  
  try {
    const res = await fetch('/api/chat/meetings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    const data = await res.json();
    
    loading.classList.add('hidden');
    if (data.error) {
      result.innerHTML = '<p class="text-red-200">Sorry, I couldn\'t process that request. Please try again.</p>';
    } else {
      result.innerHTML = '<p class="whitespace-pre-wrap">' + (data.answer || data.response || 'No results found.') + '</p>';
    }
  } catch (err) {
    loading.classList.add('hidden');
    result.innerHTML = '<p class="text-red-200">An error occurred. Please try again.</p>';
  }
});
</script>

<%- include('partials/footer') -%>
